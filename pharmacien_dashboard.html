<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Pharmacien - Ordonnances reçues</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="style1.css" />
  <script src="https://kit.fontawesome.com/a2d9d5a64b.js" crossorigin="anonymous"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    #logout {
      display: flex !important;
      align-items: center;
      color: white !important;
      background: #e74c3c;
      border-radius: 8px;
      margin-top: 10px;
      padding: 10px;
      transition: 0.3s ease;
    }
    #logout:hover { background: #c0392b; }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      z-index: 10000;
    }
    .notification-success { background:#28a745; }
    .notification-error { background:#dc3545; }
    .notification-info { background:#17a2b8; }

    .status { padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600; }
    .status.envoyee { background:#E8F5E9;color:#4CAF50; }
    .status.en_cours { background:#FFF3E0;color:#FF9800; }
    .status.delivree { background:#F3E5F5;color:#9C27B0; }
    .status.pret { background:#E0F7FA;color:#00BCD4; }

    /* Boutons d'action */
    .btn-action {
      padding: 5px 10px;
      margin: 0 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    .btn-detail {
      background-color: #17a2b8;
      color: white;
    }
    .btn-detail:hover {
      background-color: #138496;
    }
    .btn-delete {
      background-color: #dc3545;
      color: white;
    }
    .btn-delete:hover {
      background-color: #c82333;
    }

    /* Modal pour les détails */
    .modal-detail {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content-detail {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .modal-header h3 {
      margin: 0;
    }
    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: #999;
    }
    .modal-close:hover {
      color: #333;
    }
    .detail-item {
      margin-bottom: 10px;
    }
    .detail-item strong {
      display: inline-block;
      width: 120px;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- ✅ SIDEBAR COMPLET -->
  <aside class="sidebar">
    <div class="logo">ORDO<span>PASS</span></div>
    <nav class="menu">
      <a href="pharmacien_dashboard.html" class="active"><i class="fa-solid fa-prescription"></i> Ordonnances</a>
      <a href="pharmacien_medecins.html"><i class="fa-solid fa-user-md"></i> Médecins</a>
      <a href="pharmacien_stock.html"><i class="fa-solid fa-boxes-stacked"></i> Gestion Stock</a>
      <a href="pharmacien_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="pharmacien_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="pharmacien_parametres.html"><i class="fa-solid fa-gear"></i> Paramètres</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
    </nav>
  </aside>

  <!-- ✅ CONTENU -->
  <main class="main">
    <div class="topbar">
      <div class="title">Ordonnances reçues</div>
      <div class="user-box">
        <div>
          <div id="userName">Pharmacie</div>
          <small id="userStatus">Chargement...</small>
        </div>
      </div>
    </div>

    <section class="card">
      <div id="ordCount">Chargement...</div>

      <table class="table">
        <thead>
          <tr>
            <th>Code</th>
            <th>Date</th>
            <th>Patient</th>
            <th>Médecin</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordBody">
          <tr><td colspan="6">Chargement...</td></tr>
        </tbody>
      </table>
    </section>
  </main>
</div>

<!-- Modal pour afficher les détails de l'ordonnance -->
<div id="detailModal" class="modal-detail">
  <div class="modal-content-detail">
    <div class="modal-header">
      <h3><i class="fa-solid fa-file-prescription"></i> Détails de l'ordonnance</h3>
      <span class="modal-close" onclick="closeDetailModal()">&times;</span>
    </div>
    <div id="detailContent">
      <!-- Les détails seront injectés ici -->
    </div>
    <div style="text-align: right; margin-top: 15px;">
      <button class="btn-action btn-detail" onclick="closeDetailModal()">Fermer</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const API_URL = window.location.origin;
  const user = JSON.parse(localStorage.getItem("user"));

  if (!user || user.role !== "pharmacie") {
    alert("⚠️ Accès refusé");
    location.href = "index.html";
    return;
  }

  document.getElementById("userName").textContent = user.username;
  document.getElementById("userStatus").textContent = "Connecté";

  function showNotification(msg,type="info"){
    const n=document.createElement("div");
    n.className=`notification notification-${type}`;
    n.textContent=msg;
    document.body.appendChild(n);
    setTimeout(()=>n.remove(),4000);
  }

  async function loadOrdonnances(){
    try{
      const res = await fetch(`${API_URL}/api/ordonnances/pharmacie/${user.id}`);
      const data = await res.json();

      afficher(data);
      document.getElementById("ordCount").textContent =
        data.length + " ordonnance(s)";
    }catch(e){
      showNotification("Erreur chargement ordonnances","error");
    }
  }

  function afficher(list){
    const body=document.getElementById("ordBody");
    body.innerHTML="";

    if(!list.length){
      body.innerHTML="<tr><td colspan='6'>Aucune ordonnance</td></tr>";
      return;
    }

    list.forEach(o=>{
      body.innerHTML+=`
      <tr>
        <td>${o.code}</td>
        <td>${new Date(o.createdAt).toLocaleDateString()}</td>
        <td>${o.patientNom}</td>
        <td>${o.medecin.nom}</td>
        <td><span class="status ${o.statut}">${o.statut}</span></td>
        <td>
          <button class="btn-action btn-detail" onclick="showDetails('${o._id}')">Détail</button>
          <button class="btn-action btn-delete" onclick="deleteOrdonnance('${o._id}')">Supprimer</button>
          <button class="btn-action" onclick="updateStatus('${o._id}','en_cours')">Traiter</button>
        </td>
      </tr>`;
    });
  }

  // Fonction pour afficher les détails dans la modale
  window.showDetails = async (id) => {
    try {
      const res = await fetch(`${API_URL}/api/ordonnances/${id}`);
      if (!res.ok) throw new Error('Erreur lors du chargement des détails');
      const ord = await res.json();

      const content = document.getElementById('detailContent');
      content.innerHTML = `
        <div class="detail-item"><strong>Code :</strong> ${ord.code}</div>
        <div class="detail-item"><strong>Patient :</strong> ${ord.patientNom}</div>
        <div class="detail-item"><strong>Âge :</strong> ${ord.age}</div>
        <div class="detail-item"><strong>Sexe :</strong> ${ord.genre}</div>
        <div class="detail-item"><strong>Adresse :</strong> ${ord.adresse}</div>
        <div class="detail-item"><strong>Médecin :</strong> ${ord.medecin.nom}</div>
        <div class="detail-item"><strong>Date :</strong> ${new Date(ord.createdAt).toLocaleDateString()}</div>
        <div class="detail-item"><strong>Médicaments :</strong></div>
        <div style="background:#f8f9fa; padding:10px; border-radius:4px; white-space:pre-wrap;">${ord.medicaments}</div>
        <div class="detail-item"><strong>Statut :</strong> <span class="status ${ord.statut}">${ord.statut}</span></div>
        ${ord.pharmacie ? `<div class="detail-item"><strong>Pharmacie :</strong> ${ord.pharmacie.nom}</div>` : ''}
      `;

      document.getElementById('detailModal').style.display = 'block';
    } catch (error) {
      showNotification('Erreur lors du chargement des détails', 'error');
    }
  };

  // Fonction pour fermer la modale
  window.closeDetailModal = () => {
    document.getElementById('detailModal').style.display = 'none';
  };

  // Fonction pour supprimer une ordonnance
  window.deleteOrdonnance = async (id) => {
    if (!confirm('Voulez-vous vraiment supprimer cette ordonnance ?')) return;

    try {
      const res = await fetch(`${API_URL}/api/ordonnances/${id}`, {
        method: 'DELETE'
      });
      if (!res.ok) throw new Error('Erreur lors de la suppression');
      showNotification('Ordonnance supprimée avec succès', 'success');
      loadOrdonnances(); // Recharger la liste
    } catch (error) {
      showNotification('Erreur lors de la suppression', 'error');
    }
  };

  window.updateStatus = async(id,statut)=>{
    await fetch(`${API_URL}/api/ordonnances/${id}/status`,{
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({statut})
    });
    showNotification("Statut mis à jour","success");
    loadOrdonnances();
  }

  document.getElementById("logout").addEventListener("click",()=>{
    localStorage.clear();
    location.href="index.html";
  });

  loadOrdonnances();
});
</script>
</body>
</html>
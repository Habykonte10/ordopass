<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Pharmacien - Ordonnances reçues</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="style1.css" />
  <script src="https://kit.fontawesome.com/a2d9d5a64b.js" crossorigin="anonymous"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    #logout {
      display: flex !important;
      align-items: center;
      color: white !important;
      background: #e74c3c;
      border-radius: 8px;
      margin-top: 10px;
      padding: 10px;
      transition: 0.3s ease;
    }
    #logout:hover { background: #c0392b; }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      z-index: 10000;
    }
    .notification-success { background:#28a745; }
    .notification-error { background:#dc3545; }
    .notification-info { background:#17a2b8; }

    .status { padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600; }
    .status.envoyee { background:#E8F5E9;color:#4CAF50; }
    .status.en_cours { background:#FFF3E0;color:#FF9800; }
    .status.delivree { background:#F3E5F5;color:#9C27B0; }
    .status.pret { background:#E0F7FA;color:#00BCD4; }
  </style>
</head>

<body>
<div class="container">

  <!-- ✅ SIDEBAR COMPLET -->
  <aside class="sidebar">
    <div class="logo">ORDO<span>PASS</span></div>
    <nav class="menu">
      <a href="pharmacien_dashboard.html" class="active"><i class="fa-solid fa-prescription"></i> Ordonnances</a>
      <a href="pharmacien_medecins.html"><i class="fa-solid fa-user-md"></i> Médecins</a>
      <a href="pharmacien_stock.html"><i class="fa-solid fa-boxes-stacked"></i> Gestion Stock</a>
      <a href="pharmacien_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="pharmacien_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="pharmacien_parametres.html"><i class="fa-solid fa-gear"></i> Paramètres</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
    </nav>
  </aside>

  <!-- ✅ CONTENU -->
  <main class="main">
    <div class="topbar">
      <div class="title">Ordonnances reçues</div>
      <div class="user-box">
        <div>
          <div id="userName">Pharmacie</div>
          <small id="userStatus">Chargement...</small>
        </div>
      </div>
    </div>

    <section class="card">
      <div id="ordCount">Chargement...</div>

      <table class="table">
        <thead>
          <tr>
            <th>Code</th>
            <th>Date</th>
            <th>Patient</th>
            <th>Médecin</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordBody">
          <tr><td colspan="6">Chargement...</td></tr>
        </tbody>
      </table>
    </section>
  </main>
</div>

<script>
const API_URL = window.location.origin;
const user = JSON.parse(localStorage.getItem("user"));

if (!user || user.role !== "medecin") {
  alert("⚠️ Accès refusé");
  location.href = "index.html";
}

document.getElementById("usernameDisplay").textContent = user.username;

document.getElementById("logout").addEventListener("click", () => {
  localStorage.removeItem("user");
  location.href = "index.html";
});

let currentOrdonnance = null;
let selectedPharmacie = null;
let allPharmacies = [];

/* ===== Charger pharmacies ===== */
async function loadPharmaciesFromBackend(){
  const res = await fetch("/api/pharmacies");
  allPharmacies = await res.json();
}

/* ===== PREVIEW ===== */
function generatePreview(){
  currentOrdonnance = {
    patientNom: nom.value,
    age: age.value,
    genre: genre.value,
    adresse: adresse.value,
    medicaments: medicaments.value,
    medecinNom: user.username,
    date: dateOrd.value
  };

  preview.style.display="block";
  preview.innerHTML = `
    <h3>Ordonnance</h3>
    <p><b>Patient:</b> ${currentOrdonnance.patientNom}</p>
    <p><b>Médecin:</b> ${currentOrdonnance.medecinNom}</p>
    <p><b>Médicaments:</b><br>${currentOrdonnance.medicaments}</p>
  `;

  sendBtn.disabled=false;
}

/* ===== OUVRIR MODAL ===== */
function openPharmacieModal(){
  pharmacieList.innerHTML = allPharmacies.map(p=>`
    <div class="pharmacie-item" onclick="selectPharmacie('${p._id}','${p.nom}')">
      ${p.nom}
    </div>
  `).join("");

  pharmacieModal.style.display="block";
}

function selectPharmacie(id,nom){
  selectedPharmacie={id,nom};
  confirmSendBtn.disabled=false;
}

/* ===== ENVOI API ===== */
async function sendToPharmacie(){
  if(!selectedPharmacie) return;

  const res = await fetch("/api/ordonnances",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      patientNom: currentOrdonnance.patientNom,
      age: currentOrdonnance.age,
      genre: currentOrdonnance.genre,
      adresse: currentOrdonnance.adresse,
      medicaments: currentOrdonnance.medicaments,
      medecinNom: user.username,
      pharmacieId: selectedPharmacie.id,
      pharmacieNom: selectedPharmacie.nom
    })
  });

  if(res.ok){
    alert("✅ Ordonnance envoyée à la pharmacie");
    pharmacieModal.style.display="none";
  }else{
    alert("Erreur envoi");
  }
}

/* ===== EVENTS ===== */
genBtn.onclick=generatePreview;
sendBtn.onclick=openPharmacieModal;
confirmSendBtn.onclick=sendToPharmacie;

loadPharmaciesFromBackend();
</script>
</body>
</html>
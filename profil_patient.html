<!DOCTYPE html> 
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Patient - OrdoPass</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .header h1 {
      font-size: 24px;
      color: #2a5298;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header h1 i {
      color: #2a5298;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .patient-profile {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .patient-profile {
        grid-template-columns: 1fr;
      }
    }
    
    .profile-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 25px;
      position: relative;
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .profile-info h2 {
      font-size: 22px;
      color: #2a5298;
      margin-bottom: 5px;
    }
    
    .profile-info .badge {
      background: #e9ecef;
      color: #495057;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .info-item {
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: bold;
      color: #555;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .info-value {
      color: #333;
    }
    
    .history-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 18px;
      color: #2a5298;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #555;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .btn-link {
      color: #2a5298;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 4px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      transition: all 0.3s;
    }
    
    .btn-link:hover {
      text-decoration: none;
      background-color: #e9ecef;
      border-color: #2a5298;
    }
    
    .consultation-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .consultation-item {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .consultation-info {
      flex: 1;
    }
    
    .consultation-number {
      font-weight: bold;
      color: #2a5298;
      font-size: 1.1rem;
    }
    
    .consultation-date {
      color: #666;
      font-size: 0.9rem;
      margin: 5px 0;
    }
    
    .consultation-symptoms {
      color: #333;
      font-size: 0.95rem;
    }
    
    .consultation-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-outline {
      border: 1px solid #2a5298;
      color: #2a5298;
      background: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s;
    }
    
    .btn-outline:hover {
      background: #f0f5ff;
    }
    
    .btn-primary {
      background: #2a5298;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      background: #1e3c72;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .ordonnance-history {
      margin-top: 30px;
    }
    
    .ordonnance-table {
      margin-top: 15px;
    }
    
    .empty-section {
      text-align: center;
      padding: 30px;
      color: #777;
    }
    
    .empty-section i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #ddd;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn-back {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .btn-back:hover {
      background: #5a6268;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content h3 {
      margin-bottom: 20px;
      color: #2a5298;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    /* Styles pour les détails de consultation */
    .consultation-details {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .detail-section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .detail-section:last-child {
      border-bottom: none;
    }
    
    .detail-title {
      font-size: 16px;
      color: #2a5298;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-content {
      color: #333;
      line-height: 1.6;
    }
    
    .medication-item {
      background: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .medication-name {
      font-weight: bold;
      color: #2a5298;
    }
    
    .medication-details {
      display: flex;
      gap: 15px;
      margin-top: 5px;
      flex-wrap: wrap;
    }
    
    .medication-detail {
      font-size: 0.9rem;
      color: #666;
    }
    
    .medication-detail strong {
      color: #333;
    }

    /* Styles pour le statut des ordonnances */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-delivree {
      background: #cce7ff;
      color: #004085;
    }
    
    .status-annulee {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-envoyee {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-en_cours {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .status-pret {
      background: #e2e3e5;
      color: #383d41;
    }
    
    .status-recuperee {
      background: #d4edda;
      color: #155724;
    }

    /* Nouveau style pour le bouton Voir Ordonnance */
    .btn-ordonnance {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      font-weight: 600;
    }
    
    .btn-ordonnance:hover {
      background: #e0a800;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    .btn-ordonnance:active {
      transform: translateY(0);
    }

    /* Styles pour les nouveaux boutons */
    .btn-info {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    /* Style pour le bouton Envoyer Pharmacie */
    .btn-pharmacy {
      background: #6f42c1;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s;
    }

    .btn-pharmacy:hover {
      background: #5a32a3;
    }

    /* Responsive pour les boutons */
    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons button {
        width: 100%;
        justify-content: center;
      }

      .consultation-actions {
        flex-direction: column;
        gap: 5px;
      }
    }

    /* Styles pour le modal pharmacie - MODIFIÉ SANS CARTE */
    .pharmacies-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .pharmacy-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .pharmacy-item:hover {
      background-color: #f8f9fa;
    }

    .pharmacy-item.selected {
      background-color: #e3f2fd;
      border-left: 4px solid #2a5298;
    }

    .pharmacy-name {
      font-weight: bold;
      color: #2a5298;
    }

    .pharmacy-address {
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }

    .pharmacy-contact {
      font-size: 0.85rem;
      color: #888;
      margin-top: 3px;
    }

    /* Styles pour les notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification.success {
      background: #28a745;
    }

    .notification.error {
      background: #dc3545;
    }

    .notification.info {
      background: #2a5298;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- En-tête -->
    <div class="header">
      <h1><i class="fa-solid fa-user-injured"></i> Profil Patient</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay">Dr Fatoumata Ndiaye</span>
      </div>
    </div>

    <!-- Bouton retour -->
    <button class="btn-back" onclick="goBack()">
      <i class="fa-solid fa-arrow-left"></i> Retour à la liste des patients
    </button>

    <!-- Boutons d'action améliorés -->
    <div class="action-buttons">
      <button class="btn-primary" onclick="openEditModal()">
        <i class="fa-solid fa-user-edit"></i> Modifier profil
      </button>
      <button class="btn-success" onclick="newConsultation()">
        <i class="fa-solid fa-stethoscope"></i> Nouvelle consultation
      </button>
      <button class="btn-info" onclick="viewAllConsultations()">
        <i class="fa-solid fa-clipboard-list"></i> Historique consultations
      </button>
    </div>

    <!-- Profil patient -->
    <div class="patient-profile">
      <!-- Carte de profil -->
      <div class="profile-card">
        <div class="profile-header">
          <img id="patientAvatar" src="https://i.pravatar.cc/80" class="profile-avatar" alt="Patient">
          <div class="profile-info">
            <h2 id="patientName">Chargement...</h2>
            <span class="badge" id="patientBadge">Patient</span>
          </div>
        </div>
        
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Âge</div>
            <div class="info-value" id="patientAge">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Adresse</div>
            <div class="info-value" id="patientAddress">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Téléphone</div>
            <div class="info-value" id="patientPhone">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">N° pièce d'identité</div>
            <div class="info-value" id="patientId">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Sexe</div>
            <div class="info-value" id="patientGender">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Date d'ajout</div>
            <div class="info-value" id="patientAdded">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Mode de paiement</div>
            <div class="info-value" id="patientPayment">Chargement...</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Assurance</div>
            <div class="info-value" id="patientInsurance">Chargement...</div>
          </div>
        </div>
      </div>
      
      <!-- Historique des consultations -->
      <div class="history-section">
        <h2 class="section-title"><i class="fa-solid fa-history"></i> Historique des consultations</h2>
        
        <table id="consultationsTable">
          <thead>
            <tr>
              <th>No ticket</th>
              <th>Date</th>
              <th>Symptômes</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <!-- Les consultations seront chargées dynamiquement -->
          </tbody>
        </table>
        
        <div class="ordonnance-history">
          <h3 class="section-title"><i class="fa-solid fa-prescription"></i> Historique des ordonnances</h3>
          
          <table class="ordonnance-table" id="ordonnancesTable">
            <thead>
              <tr>
                <th>N° Consultation</th>
                <th>Date</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Les ordonnances seront chargées dynamiquement -->
            </tbody>
          </table>
        </div>
        
        <div style="margin-top: 30px;">
          <h3 class="section-title"><i class="fa-solid fa-vial"></i> Historique des résultats du salivage</h3>
          <div class="empty-section">
            <i class="fa-solid fa-file-medical"></i>
            <p>Aucun résultat de salivage disponible</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Section pour afficher les détails de consultation -->
    <div id="consultationDetails" class="consultation-details" style="display: none;">
      <h2 class="section-title"><i class="fa-solid fa-file-medical"></i> Détails de la consultation</h2>
      <button class="btn-outline" onclick="closeConsultationDetails()" style="margin-bottom: 20px;">
        <i class="fa-solid fa-arrow-left"></i> Retour à l'historique
      </button>
      
      <div id="consultationDetailsContent">
        <!-- Les détails de consultation seront chargés dynamiquement -->
      </div>
    </div>

    <!-- Version alternative pour OrdoPass -->
    <div class="history-section">
      <h2 class="section-title"><i class="fa-solid fa-prescription-bottle-medical"></i> OrdoPass</h2>
      
      <div class="consultation-list" id="consultationList">
        <!-- Les consultations seront chargées dynamiquement -->
      </div>
      
      <div class="ordonnance-history">
        <h3 class="section-title"><i class="fa-solid fa-prescription"></i> Historique des ordonnances</h3>
        
        <div class="consultation-list" id="ordonnanceList">
          <!-- Les ordonnances seront chargées dynamiquement -->
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <h3 class="section-title"><i class="fa-solid fa-file-medical-alt"></i> Historique des résultats d'analyses</h3>
        
        <table id="analysesTable">
          <thead>
            <tr>
              <th>Date de l'examen</th>
              <th>Motif</th>
              <th>Detail</th>
            </tr>
          </thead>
          <tbody>
            <!-- Les analyses seront chargées dynamiquement -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal pour modifier les informations -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Modifier les informations du patient</h3>
      
      <div class="form-group">
        <label class="form-label">Nom complet</label>
        <input type="text" class="form-control" id="editName">
      </div>
      
      <div class="form-group">
        <label class="form-label">Âge</label>
        <input type="number" class="form-control" id="editAge">
      </div>
      
      <div class="form-group">
        <label class="form-label">Adresse</label>
        <input type="text" class="form-control" id="editAddress">
      </div>
      
      <div class="form-group">
        <label class="form-label">Téléphone</label>
        <input type="text" class="form-control" id="editPhone">
      </div>
      
      <div class="form-group">
        <label class="form-label">N° pièce d'identité</label>
        <input type="text" class="form-control" id="editId">
      </div>
      
      <div class="form-group">
        <label class="form-label">Sexe</label>
        <select class="form-control" id="editGender">
          <option value="Femme">Femme</option>
          <option value="Homme">Homme</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Mode de paiement</label>
        <select class="form-control" id="editPayment">
          <option value="Wave">Wave</option>
          <option value="Orange Money">Orange Money</option>
          <option value="Free Money">Free Money</option>
          <option value="Espèces">Espèces</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Assurance</label>
        <select class="form-control" id="editInsurance">
          <option value="Oui">Oui</option>
          <option value="Non">Non</option>
        </select>
      </div>
      
      <div class="modal-buttons">
        <button class="btn-outline" onclick="closeEditModal()">Annuler</button>
        <button class="btn-primary" onclick="savePatientInfo()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal pour envoyer à la pharmacie - MODIFIÉ SANS CARTE -->
  <div id="pharmacyModal" class="modal">
    <div class="modal-content">
      <h3><i class="fa-solid fa-truck-medical"></i> Envoyer l'ordonnance à une pharmacie</h3>
      
      <div class="form-group">
        <label class="form-label">Sélectionner une pharmacie</label>
        <div class="pharmacies-list" id="pharmaciesList">
          <!-- Liste des pharmacies chargée dynamiquement depuis les pharmacies créées -->
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Message (optionnel)</label>
        <textarea class="form-control" id="pharmacyMessage" rows="3" placeholder="Message pour le pharmacien..."></textarea>
      </div>
      
      <div class="modal-buttons">
        <button class="btn-outline" onclick="closePharmacyModal()">Annuler</button>
        <button class="btn-pharmacy" onclick="sendToPharmacy()">Envoyer à la pharmacie</button>
      </div>
    </div>
  </div>

  <script>
let currentPatient = null;
let currentConsultation = null;

// Récupérer l'ID du patient depuis l'URL
function getPatientFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

// Initialiser les données si elles n'existent pas
function initializeData() {
  // Vérifier si les données existent déjà
  if (!localStorage.getItem("patients")) {
    // Créer des données d'exemple
    const examplePatients = [
      {
        id: "1",
        name: "Marième Diallo",
        age: 32,
        address: "Dakar, Sacré Coeur 3",
        phone: "77 123 45 67",
        idNumber: "1234567890",
        gender: "Femme",
        added: "15/03/2024",
        paymentMethod: "Wave",
        insurance: "Oui",
        image: "https://i.pravatar.cc/80?img=5"
      },
      {
        id: "2",
        name: "Abdoulaye Sow",
        age: 45,
        address: "Thiaroye, Rue 10",
        phone: "76 234 56 78",
        idNumber: "0987654321",
        gender: "Homme",
        added: "20/03/2024",
        paymentMethod: "Orange Money",
        insurance: "Non",
        image: "https://i.pravatar.cc/80?img=15"
      }
    ];
    localStorage.setItem("patients", JSON.stringify(examplePatients));
  }
  
  if (!localStorage.getItem("consultations")) {
    const exampleConsultations = [
      {
        id: "consult1",
        patientId: "1",
        ticketNumber: "TKT-2024-001",
        date: "15/03/2024",
        symptoms: "Fièvre, maux de tête",
        diagnosis: "Paludisme",
        notes: "Patient à surveiller",
        medications: ["Paracétamol", "Artéméther"]
      },
      {
        id: "consult2",
        patientId: "1",
        ticketNumber: "TKT-2024-002",
        date: "20/03/2024",
        symptoms: "Toux, fatigue",
        diagnosis: "Infection respiratoire",
        notes: "Repos recommandé",
        medications: ["Amoxicilline", "Sirop antitussif"]
      }
    ];
    localStorage.setItem("consultations", JSON.stringify(exampleConsultations));
  }
  
  if (!localStorage.getItem("ordonnances")) {
    const exampleOrdonnances = [
      {
        id: "ordo1",
        patientId: "1",
        consultationId: "consult1",
        date: "15/03/2024",
        status: "active",
        medications: [
          { name: "Paracétamol", dosage: "500mg", frequency: "3x/jour", duration: "5 jours" },
          { name: "Artéméther", dosage: "80mg", frequency: "2x/jour", duration: "3 jours" }
        ],
        notes: "Prendre après les repas"
      },
      {
        id: "ordo2",
        patientId: "1",
        consultationId: "consult2",
        date: "20/03/2024",
        status: "envoyee",
        sentToPharmacy: {
          pharmacyId: "pharm1",
          pharmacyName: "Pharmacie du Soleil",
          date: "21/03/2024"
        },
        medications: [
          { name: "Amoxicilline", dosage: "1g", frequency: "2x/jour", duration: "7 jours" }
        ]
      }
    ];
    localStorage.setItem("ordonnances", JSON.stringify(exampleOrdonnances));
  }
  
  if (!localStorage.getItem("pharmacies")) {
    const examplePharmacies = [
      {
        id: "pharm1",
        name: "Pharmacie du Soleil",
        address: "Dakar, Plateau",
        phone: "33 821 10 20",
        email: "contact@pharmasoleil.sn"
      },
      {
        id: "pharm2",
        name: "Pharmacie de la Liberté",
        address: "Dakar, Liberté 6",
        phone: "33 822 30 40",
        email: "info@pharmaliberte.sn"
      },
      {
        id: "pharm3",
        name: "Pharmacie Centrale",
        address: "Dakar, Médina",
        phone: "33 823 50 60",
        email: "centrale@pharma.sn"
      }
    ];
    localStorage.setItem("pharmacies", JSON.stringify(examplePharmacies));
  }
}

// Charger les données du patient
function loadPatientData() {
  initializeData();
  
  const patientId = getPatientFromURL();
  
  if (!patientId) {
    alert("Aucun patient sélectionné");
    window.location.href = "patients.html";
    return;
  }
  
  // Récupérer les patients depuis le localStorage
  const patients = JSON.parse(localStorage.getItem("patients")) || [];
  const patient = patients.find(p => p.id == patientId);
  
  if (!patient) {
    alert("Patient introuvable");
    window.location.href = "patients.html";
    return;
  }
  
  currentPatient = patient;
  
  // Mettre à jour l'affichage
  document.getElementById("patientName").textContent = patient.name;
  document.getElementById("patientAge").textContent = patient.age + " ans";
  document.getElementById("patientAddress").textContent = patient.address;
  document.getElementById("patientPhone").textContent = patient.phone;
  document.getElementById("patientId").textContent = patient.idNumber || "Non spécifié";
  document.getElementById("patientGender").textContent = patient.gender || "Non spécifié";
  document.getElementById("patientAdded").textContent = patient.added || "Date inconnue";
  document.getElementById("patientPayment").textContent = patient.paymentMethod || "Non spécifié";
  document.getElementById("patientInsurance").textContent = patient.insurance || "Non spécifié";
  document.getElementById("patientAvatar").src = patient.image || "https://i.pravatar.cc/80";
  
  // Charger les consultations et ordonnances
  loadConsultations();
  loadOrdonnances();
}

// Charger les consultations
function loadConsultations() {
  const consultations = JSON.parse(localStorage.getItem("consultations")) || [];
  const patientId = getPatientFromURL();
  const patientConsultations = consultations.filter(c => c.patientId == patientId);
  
  const tbody = document.querySelector("#consultationsTable tbody");
  tbody.innerHTML = "";
  
  if (patientConsultations.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align: center; color: #777;">Aucune consultation enregistrée</td>
      </tr>
    `;
    return;
  }
  
  patientConsultations.forEach(consultation => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${consultation.ticketNumber || "N/A"}</td>
      <td>${consultation.date}</td>
      <td>${consultation.symptoms || "Non spécifié"}</td>
      <td>
        <button class="btn-link" onclick="viewConsultationDetails('${consultation.id}')">
          <i class="fa-solid fa-eye"></i> Voir
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Charger les ordonnances
function loadOrdonnances() {
  const ordonnances = JSON.parse(localStorage.getItem("ordonnances")) || [];
  const patientId = getPatientFromURL();
  const patientOrdonnances = ordonnances.filter(o => o.patientId == patientId);
  
  const tbody = document.querySelector("#ordonnancesTable tbody");
  tbody.innerHTML = "";
  
  if (patientOrdonnances.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align: center; color: #777;">Aucune ordonnance enregistrée</td>
      </tr>
    `;
    return;
  }
  
  patientOrdonnances.forEach(ordonnance => {
    const row = document.createElement("tr");
    
    // Déterminer la classe CSS pour le statut
    let statusClass = "status-active";
    if (ordonnance.status === "delivree") statusClass = "status-delivree";
    if (ordonnance.status === "annulee") statusClass = "status-annulee";
    if (ordonnance.status === "envoyee") statusClass = "status-envoyee";
    if (ordonnance.status === "en_cours") statusClass = "status-en_cours";
    if (ordonnance.status === "pret") statusClass = "status-pret";
    if (ordonnance.status === "recuperee") statusClass = "status-recuperee";
    
    // Texte du statut
    let statusText = "Active";
    if (ordonnance.status === "delivree") statusText = "Délivrée";
    if (ordonnance.status === "annulee") statusText = "Annulée";
    if (ordonnance.status === "envoyee") statusText = "Envoyée";
    if (ordonnance.status === "en_cours") statusText = "En cours";
    if (ordonnance.status === "pret") statusText = "Prête";
    if (ordonnance.status === "recuperee") statusText = "Récupérée";
    
    row.innerHTML = `
      <td>${ordonnance.consultationId || "N/A"}</td>
      <td>${ordonnance.date}</td>
      <td><span class="status-badge ${statusClass}">${statusText}</span></td>
      <td>
        <button class="btn-ordonnance" onclick="viewOrdonnance('${ordonnance.id}')">
          <i class="fa-solid fa-file-prescription"></i> Voir Ordonnance
        </button>
        ${ordonnance.status === "active" ? 
          `<button class="btn-pharmacy" onclick="openPharmacyModal('${ordonnance.id}')">
            <i class="fa-solid fa-truck-medical"></i> Envoyer Pharmacie
          </button>` : ""
        }
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Ouvrir le modal d'édition
function openEditModal() {
  if (!currentPatient) return;
  
  document.getElementById("editName").value = currentPatient.name;
  document.getElementById("editAge").value = currentPatient.age;
  document.getElementById("editAddress").value = currentPatient.address;
  document.getElementById("editPhone").value = currentPatient.phone;
  document.getElementById("editId").value = currentPatient.idNumber || "";
  document.getElementById("editGender").value = currentPatient.gender || "Femme";
  document.getElementById("editPayment").value = currentPatient.paymentMethod || "Wave";
  document.getElementById("editInsurance").value = currentPatient.insurance || "Non";
  
  document.getElementById("editModal").style.display = "flex";
}

// Fermer le modal d'édition
function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

// Sauvegarder les informations du patient
function savePatientInfo() {
  const patientId = getPatientFromURL();
  const patients = JSON.parse(localStorage.getItem("patients")) || [];
  const patientIndex = patients.findIndex(p => p.id == patientId);
  
  if (patientIndex === -1) {
    showNotification("Patient introuvable", "error");
    return;
  }
  
  // Mettre à jour les informations
  patients[patientIndex].name = document.getElementById("editName").value;
  patients[patientIndex].age = document.getElementById("editAge").value;
  patients[patientIndex].address = document.getElementById("editAddress").value;
  patients[patientIndex].phone = document.getElementById("editPhone").value;
  patients[patientIndex].idNumber = document.getElementById("editId").value;
  patients[patientIndex].gender = document.getElementById("editGender").value;
  patients[patientIndex].paymentMethod = document.getElementById("editPayment").value;
  patients[patientIndex].insurance = document.getElementById("editInsurance").value;
  
  // Sauvegarder dans localStorage
  localStorage.setItem("patients", JSON.stringify(patients));
  
  // Mettre à jour l'affichage
  currentPatient = patients[patientIndex];
  loadPatientData();
  
  // Fermer le modal
  closeEditModal();
  
  // Afficher une notification
  showNotification("Informations du patient mises à jour avec succès", "success");
}

// Nouvelle consultation
function newConsultation() {
  const patientId = getPatientFromURL();
  window.location.href = `new-consultation.html?patientId=${patientId}`;
}

// Voir toutes les consultations
function viewAllConsultations() {
  const consultationDetails = document.getElementById("consultationDetails");
  const patientProfile = document.querySelector(".patient-profile");
  const ordopassSection = document.querySelector(".history-section");
  
  consultationDetails.style.display = "none";
  patientProfile.style.display = "grid";
  ordopassSection.style.display = "block";
  
  loadConsultations();
}

// Voir les détails d'une consultation
function viewConsultationDetails(consultationId) {
  const consultations = JSON.parse(localStorage.getItem("consultations")) || [];
  const consultation = consultations.find(c => c.id == consultationId);
  
  if (!consultation) {
    showNotification("Consultation introuvable", "error");
    return;
  }
  
  currentConsultation = consultation;
  
  // Afficher la section des détails
  const consultationDetails = document.getElementById("consultationDetails");
  const patientProfile = document.querySelector(".patient-profile");
  const ordopassSection = document.querySelector(".history-section");
  
  patientProfile.style.display = "none";
  ordopassSection.style.display = "none";
  consultationDetails.style.display = "block";
  
  // Remplir les détails
  const detailsContent = document.getElementById("consultationDetailsContent");
  
  // Récupérer les ordonnances liées à cette consultation
  const ordonnances = JSON.parse(localStorage.getItem("ordonnances")) || [];
  const consultationOrdonnances = ordonnances.filter(o => o.consultationId == consultationId);
  
  let ordonnanceHTML = "";
  if (consultationOrdonnances.length > 0) {
    consultationOrdonnances.forEach(ordonnance => {
      // Texte du statut
      let statusText = "Active";
      if (ordonnance.status === "delivree") statusText = "Délivrée";
      if (ordonnance.status === "annulee") statusText = "Annulée";
      if (ordonnance.status === "envoyee") statusText = "Envoyée";
      if (ordonnance.status === "en_cours") statusText = "En cours";
      if (ordonnance.status === "pret") statusText = "Prête";
      if (ordonnance.status === "recuperee") statusText = "Récupérée";
      
      ordonnanceHTML += `
        <div class="medication-item">
          <div class="medication-name">Ordonnance du ${ordonnance.date}</div>
          <div class="medication-details">
            <div class="medication-detail"><strong>Statut:</strong> ${statusText}</div>
            <div class="medication-detail"><strong>Médicaments:</strong> ${ordonnance.medications ? ordonnance.medications.length : 0}</div>
            <button class="btn-outline" onclick="viewOrdonnance('${ordonnance.id}')">Voir</button>
          </div>
        </div>
      `;
    });
  } else {
    ordonnanceHTML = `<p>Aucune ordonnance pour cette consultation.</p>`;
  }
  
  detailsContent.innerHTML = `
    <div class="detail-section">
      <h3 class="detail-title"><i class="fa-solid fa-calendar"></i> Date de la consultation</h3>
      <div class="detail-content">${consultation.date}</div>
    </div>
    
    <div class="detail-section">
      <h3 class="detail-title"><i class="fa-solid fa-stethoscope"></i> Symptômes</h3>
      <div class="detail-content">${consultation.symptoms || "Non spécifié"}</div>
    </div>
    
    <div class="detail-section">
      <h3 class="detail-title"><i class="fa-solid fa-notes-medical"></i> Diagnostic</h3>
      <div class="detail-content">${consultation.diagnosis || "Non spécifié"}</div>
    </div>
    
    <div class="detail-section">
      <h3 class="detail-title"><i class="fa-solid fa-prescription-bottle-medical"></i> Ordonnances</h3>
      <div class="detail-content">
        ${ordonnanceHTML}
        <button class="btn-primary" onclick="createOrdonnanceForConsultation('${consultationId}')" style="margin-top: 15px;">
          <i class="fa-solid fa-file-prescription"></i> Créer une ordonnance
        </button>
      </div>
    </div>
    
    <div class="detail-section">
      <h3 class="detail-title"><i class="fa-solid fa-file-medical-alt"></i> Notes supplémentaires</h3>
      <div class="detail-content">${consultation.notes || "Aucune note"}</div>
    </div>
  `;
}

// Créer une ordonnance pour une consultation
function createOrdonnanceForConsultation(consultationId) {
  const patientId = getPatientFromURL();
  window.location.href = `new-ordonnance.html?patientId=${patientId}&consultationId=${consultationId}`;
}

// Fermer les détails de consultation
function closeConsultationDetails() {
  const consultationDetails = document.getElementById("consultationDetails");
  const patientProfile = document.querySelector(".patient-profile");
  const ordopassSection = document.querySelector(".history-section");
  
  consultationDetails.style.display = "none";
  patientProfile.style.display = "grid";
  ordopassSection.style.display = "block";
}

// Voir une ordonnance
function viewOrdonnance(ordonnanceId) {
  window.location.href = `ordonnance.html?id=${ordonnanceId}`;
}

// Ouvrir le modal pharmacie
function openPharmacyModal(ordonnanceId) {
  // Charger la liste des pharmacies
  loadPharmacies();
  
  // Stocker l'ID de l'ordonnance dans un attribut data
  document.getElementById("pharmacyModal").setAttribute("data-ordonnance-id", ordonnanceId);
  
  document.getElementById("pharmacyModal").style.display = "flex";
}

// Charger les pharmacies
function loadPharmacies() {
  const pharmacies = JSON.parse(localStorage.getItem("pharmacies")) || [];
  const pharmaciesList = document.getElementById("pharmaciesList");
  
  pharmaciesList.innerHTML = "";
  
  if (pharmacies.length === 0) {
    pharmaciesList.innerHTML = `
      <div class="pharmacy-item" style="text-align: center; padding: 20px;">
        <p>Aucune pharmacie enregistrée</p>
        <button class="btn-outline" onclick="window.location.href='pharmacies.html'" style="margin-top: 10px;">
          <i class="fa-solid fa-plus"></i> Ajouter une pharmacie
        </button>
      </div>
    `;
    return;
  }
  
  pharmacies.forEach((pharmacy, index) => {
    const item = document.createElement("div");
    item.className = "pharmacy-item";
    item.setAttribute("data-id", pharmacy.id);
    item.setAttribute("data-index", index);
    
    item.innerHTML = `
      <div class="pharmacy-name">${pharmacy.name}</div>
      <div class="pharmacy-address">${pharmacy.address}</div>
      <div class="pharmacy-contact">${pharmacy.phone} • ${pharmacy.email || ""}</div>
    `;
    
    item.onclick = function() {
      // Retirer la sélection précédente
      document.querySelectorAll(".pharmacy-item").forEach(el => {
        el.classList.remove("selected");
      });
      
      // Ajouter la sélection à l'élément cliqué
      this.classList.add("selected");
    };
    
    pharmaciesList.appendChild(item);
  });
}

// Fermer le modal pharmacie
function closePharmacyModal() {
  document.getElementById("pharmacyModal").style.display = "none";
  document.getElementById("pharmacyMessage").value = "";
  
  // Retirer les sélections
  document.querySelectorAll(".pharmacy-item").forEach(el => {
    el.classList.remove("selected");
  });
}

// Envoyer à la pharmacie
function sendToPharmacy() {
  const selectedPharmacy = document.querySelector(".pharmacy-item.selected");
  
  if (!selectedPharmacy) {
    showNotification("Veuillez sélectionner une pharmacie", "error");
    return;
  }
  
  const ordonnanceId = document.getElementById("pharmacyModal").getAttribute("data-ordonnance-id");
  const message = document.getElementById("pharmacyMessage").value;
  
  // Récupérer les ordonnances
  const ordonnances = JSON.parse(localStorage.getItem("ordonnances")) || [];
  const ordonnanceIndex = ordonnances.findIndex(o => o.id == ordonnanceId);
  
  if (ordonnanceIndex === -1) {
    showNotification("Ordonnance introuvable", "error");
    return;
  }
  
  // Récupérer les informations de la pharmacie
  const pharmacies = JSON.parse(localStorage.getItem("pharmacies")) || [];
  const pharmacyIndex = parseInt(selectedPharmacy.getAttribute("data-index"));
  const selectedPharmacyData = pharmacies[pharmacyIndex];
  
  // Mettre à jour le statut de l'ordonnance
  ordonnances[ordonnanceIndex].status = "envoyee";
  ordonnances[ordonnanceIndex].sentToPharmacy = {
    pharmacyId: selectedPharmacyData.id,
    pharmacyName: selectedPharmacyData.name,
    pharmacyAddress: selectedPharmacyData.address,
    date: new Date().toLocaleDateString(),
    message: message
  };
  
  // Sauvegarder
  localStorage.setItem("ordonnances", JSON.stringify(ordonnances));
  
  // Fermer le modal
  closePharmacyModal();
  
  // Recharger les ordonnances
  loadOrdonnances();
  
  // Afficher une notification
  showNotification(`Ordonnance envoyée à ${selectedPharmacyData.name} avec succès`, "success");
}

// Afficher une notification
function showNotification(message, type = "info") {
  const notification = document.createElement("div");
  notification.className = `notification ${type}`;
  
  // Icône selon le type
  let icon = "fa-info-circle";
  if (type === 'success') icon = 'fa-check-circle';
  if (type === 'error') icon = 'fa-exclamation-circle';
  
  notification.innerHTML = `
    <i class="fa-solid ${icon}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(notification);
  
  // Supprimer la notification après 3 secondes
  setTimeout(() => {
    notification.style.opacity = "0";
    notification.style.transform = "translateX(100%)";
    setTimeout(() => {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Retour à la liste des patients
function goBack() {
  window.location.href = "patients.html";
}

// Initialisation au chargement de la page
document.addEventListener("DOMContentLoaded", () => {
  loadPatientData();
  
  // Fermer les modals en cliquant à l'extérieur
  window.addEventListener("click", (event) => {
    const editModal = document.getElementById("editModal");
    const pharmacyModal = document.getElementById("pharmacyModal");
    
    if (event.target === editModal) {
      closeEditModal();
    }
    
    if (event.target === pharmacyModal) {
      closePharmacyModal();
    }
  });
  
  // Permettre d'appuyer sur Échap pour fermer les modals
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      closeEditModal();
      closePharmacyModal();
    }
  });
});
</script>
</body>
</html>
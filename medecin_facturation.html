<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Facturation - OrdoPass</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.invoice-card{background:white;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.tabs{display:flex;margin-bottom:15px}
.tab{padding:10px 20px;border:1px solid #ccc;cursor:pointer}
.tab.active{background:#2a5298;color:white}
.tab-content{display:none}
.tab-content.active{display:block}
.document-card{border-left:4px solid #2a5298;padding:15px;background:white;margin-bottom:15px;border-radius:8px}
.btn{padding:8px 15px;border:none;border-radius:5px;cursor:pointer}
.btn-primary{background:#2a5298;color:white}
.btn-outline{border:1px solid #2a5298;color:#2a5298;background:white}
.badge{padding:4px 8px;border-radius:10px;font-size:12px}
.badge-success{background:#d4edda;color:#155724}
.badge-warning{background:#fff3cd;color:#856404}
</style>
</head>

<body class="dashboard-page">

<!-- SIDEBAR -->
<aside class="sidebar">
<div class="logo"><i class="fa-solid fa-notes-medical"></i> ORDOPASS</div>
<nav>
<a href="medecin_dashboard.html">Consultations</a>
<a href="patients.html">Patients</a>
<a href="teleconsultation.html">Téléconsultation</a>
<a href="pharmacies.html">Pharmacies</a>
<a href="medecin_facturation.html" class="active">Facturation</a>
<a href="#" id="logout">Déconnexion</a>
</nav>
</aside>

<main class="main-area">

<header class="topbar">
<h1>Facturation</h1>
<span id="usernameDisplay"></span>
</header>

<section class="content">

<div class="tabs">
<div class="tab active" data-tab="new">Nouvelle facture</div>
<div class="tab" data-tab="list">Factures enregistrées</div>
</div>

<!-- NOUVELLE FACTURE -->
<div class="tab-content active" id="new">

<div class="invoice-card">
<form id="factureForm">

<input id="patient" placeholder="Nom du patient" required>
<input id="description" placeholder="Description" required>
<input id="montant" type="number" placeholder="Montant" required>

<select id="paiement">
<option>Espèces</option>
<option>Wave</option>
<option>Orange Money</option>
</select>

<select id="facturePaye">
<option value="Oui">Oui</option>
<option value="Non">Non</option>
</select>

<button class="btn btn-primary" type="submit">Enregistrer facture</button>

</form>
</div>

</div>

<!-- LISTE FACTURES -->
<div class="tab-content" id="list">
<div id="facturesList"></div>
</div>

</section>
</main>

<script>
const { jsPDF } = window.jspdf;

/* ✅ CORRECTION ICI */
const user = JSON.parse(localStorage.getItem("user"));

if(!user || user.role !== "medecin"){
  alert("⚠️ Accès refusé");
  window.location.href="index.html";
  return;
}

document.getElementById("usernameDisplay").textContent = user.username;

// Tabs
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
    if(tab.dataset.tab==="list") loadFactures();
  }
});

// Logout
document.getElementById("logout").onclick=()=>{
  localStorage.clear();
  location.href="index.html";
}

// Save facture
document.getElementById("factureForm").addEventListener("submit",e=>{
  e.preventDefault();

  const facture={
    id:Date.now(),
    patient:patient.value,
    description:description.value,
    montant:montant.value,
    paiement:paiement.value,
    paye:facturePaye.value,
    date:new Date().toLocaleDateString()
  };

  let factures=JSON.parse(localStorage.getItem("factures"))||[];
  factures.push(facture);
  localStorage.setItem("factures",JSON.stringify(factures));

  alert("✅ Facture enregistrée");
  document.getElementById("factureForm").reset();
});

// Load factures
function loadFactures(){
  const list=document.getElementById("facturesList");
  let factures=JSON.parse(localStorage.getItem("factures"))||[];

  if(factures.length===0){
    list.innerHTML="<p>Aucune facture</p>";
    return;
  }

  list.innerHTML="";

  factures.forEach(f=>{
    list.innerHTML+=`
      <div class="document-card">
        <b>${f.patient}</b><br>
        ${f.description}<br>
        Montant: ${f.montant} FCFA<br>
        Paiement: ${f.paiement}<br>
        Statut: <span class="badge ${f.paye==="Oui"?"badge-success":"badge-warning"}">${f.paye}</span><br>
        Date: ${f.date}
      </div>
    `;
  });
}
</script>

</body>
</html>
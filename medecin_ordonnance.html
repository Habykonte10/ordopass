<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ordonnances - OrdoPass</title>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* ... (tous vos styles CSS restent exactement les mêmes) ... */
    .preview { 
      margin-top:20px; 
      border:1px solid #ddd; 
      padding:25px; 
      border-radius:8px; 
      background: white; 
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .preview .logo { 
      max-width:120px; 
      margin-bottom:10px; 
      display:block; 
      margin-left:auto; 
      margin-right:auto; 
    }
    .signature { 
      max-width:150px; 
      margin-top:15px; 
    }
    .btn-secondary { 
      background:#28a745; 
      color:#fff; 
      padding:10px 20px; 
      border:none; 
      border-radius:5px; 
      cursor:pointer; 
      font-size: 14px; 
    }
    .btn-warning { 
      background:#ffc107; 
      color:#212529; 
      padding:10px 20px; 
      border:none; 
      border-radius:5px; 
      cursor:pointer; 
      font-size: 14px; 
    }
    .btn-danger { 
      background:#dc3545; 
      color:#fff; 
      padding:10px 20px; 
      border:none; 
      border-radius:5px; 
      cursor:pointer; 
      font-size: 14px; 
    }
    .medecin-name { 
      text-align: center; 
      font-weight: bold; 
      font-size: 18px; 
      margin-bottom: 10px; 
    }
    .center-content { 
      text-align:center; 
    }
    .form-group { 
      margin-bottom: 15px; 
    }
    label { 
      display: block; 
      margin-bottom: 5px; 
      font-weight: bold; 
      color: #333;
    }
    input, select, textarea { 
      width: 100%; 
      padding: 10px; 
      border: 2px solid #e9ecef; 
      border-radius: 6px; 
      box-sizing: border-box; 
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #2a5298;
      outline: none;
    }
    .tabs { 
      display: flex; 
      margin-bottom: 20px; 
      border-bottom: 1px solid #ddd; 
      background: white;
      border-radius: 8px;
      padding: 0 10px;
    }
    .tab { 
      padding: 12px 20px; 
      cursor: pointer; 
      border-bottom: 3px solid transparent; 
      font-weight: 500;
    }
    .tab.active { 
      border-bottom: 3px solid #2a5298; 
      font-weight: bold; 
      color: #2a5298;
    }
    .tab-content { 
      display: none; 
    }
    .tab-content.active { 
      display: block; 
    }
    .ordonnance-list { 
      max-height: 400px; 
      overflow-y: auto; 
    }
    .ordonnance-item { 
      border: 1px solid #ddd; 
      padding: 15px; 
      margin-bottom: 10px; 
      border-radius: 5px; 
      background: #f8f9fa;
    }
    .ordonnance-item h4 { 
      margin: 0 0 10px 0; 
      color: #2a5298;
    }
    .status-badge { 
      padding: 3px 8px; 
      border-radius: 12px; 
      font-size: 12px; 
    }
    .status-active { 
      background: #d4edda; 
      color: #155724; 
    }
    .status-delivree { 
      background: #cce7ff; 
      color: #004085; 
    }
    .status-annulee { 
      background: #f8d7da; 
      color: #721c24; 
    }
    .status-envoyee { 
      background: #fff3cd; 
      color: #856404; 
    }
    .status-en_cours { 
      background: #d1ecf1; 
      color: #0c5460; 
    }
    .status-pret { 
      background: #e2e3e5; 
      color: #383d41; 
    }
    .status-recuperee { 
      background: #d4edda; 
      color: #155724; 
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .buttons button {
      flex: 1;
      min-width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: #999;
    }
    .pharmacie-item {
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .pharmacie-item:hover {
      background-color: #f5f5f5;
    }
    .pharmacie-item.selected {
      background-color: #e6f7ff;
      border-color: #2a5298;
    }
    .online-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .online {
      background-color: #28a745;
    }
    .offline {
      background-color: #dc3545;
    }

    /* Styles pour le mode consultation */
    .consultation-mode {
      background-color: #e8f4fd;
      border-left: 4px solid #2a5298;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .consultation-mode .badge {
      background: #2a5298;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 10px;
    }

    .btn-back {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .btn-back:hover {
      background: #5a6268;
    }

    /* Styles améliorés pour l'ordonnance */
    .ordonnance-beautiful {
      background: white;
      border: 2px solid #2a5298;
      border-radius: 10px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(42, 82, 152, 0.1);
      font-family: 'Georgia', serif;
    }

    .ordonnance-header {
      text-align: center;
      border-bottom: 3px double #2a5298;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }

    .ordonnance-title {
      color: #2a5298;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .ordonnance-subtitle {
      color: #666;
      font-size: 16px;
      font-style: italic;
    }

    .ordonnance-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .ordonnance-section {
      margin-bottom: 25px;
    }

    .ordonnance-section-title {
      color: #2a5298;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }

    .ordonnance-medicaments {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #2a5298;
    }

    .medicament-item {
      padding: 10px 0;
      border-bottom: 1px dashed #ddd;
    }

    .medicament-item:last-child {
      border-bottom: none;
    }

    .medicament-name {
      font-weight: bold;
      color: #2a5298;
      font-size: 16px;
    }

    .ordonnance-footer {
      border-top: 2px solid #2a5298;
      padding-top: 30px;
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .signature-area {
      text-align: center;
    }

    .signature-image {
      max-width: 200px;
      height: auto;
      margin-bottom: 10px;
      border-bottom: 1px solid #000;
      padding-bottom: 5px;
    }

    .doctor-stamp {
      color: #2a5298;
      font-weight: bold;
      font-size: 14px;
    }

    .qr-code-area {
      text-align: center;
    }

    .ordonnance-security {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    /* Styles pour les notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: #28a745;
    }

    .notification.error {
      background: #dc3545;
    }

    .notification.info {
      background: #2a5298;
    }

    /* Styles pour les pharmacies */
    .pharmacie-marker {
      background: transparent !important;
      border: none !important;
    }

    .leaflet-popup-content {
      margin: 8px 12px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 8px;
    }

    .pharmacie-item {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .pharmacie-item:hover {
      border-color: #2a5298;
      box-shadow: 0 2px 8px rgba(42, 82, 152, 0.1);
    }

    .pharmacie-item.selected {
      border-color: #2a5298;
      background-color: #e8f4fd;
      box-shadow: 0 2px 8px rgba(42, 82, 152, 0.15);
    }

    .select-pharmacie-btn {
      white-space: nowrap;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Amélioration responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .clinic-info {
        text-align: center;
        margin-top: 15px;
      }
      
      .actions {
        flex-direction: column;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        border-radius: 0;
        margin-right: 0;
        border-bottom: 1px solid #ddd;
      }

      .ordonnance-content {
        grid-template-columns: 1fr;
      }

      .pharmacie-item {
        padding: 12px;
      }
      
      .pharmacie-item h4 {
        font-size: 14px;
      }

      .modal-content {
        width: 95%;
        margin: 5% auto;
      }
    }
  </style>
</head>

<body class="dashboard-page">

  <!-- ✅ SIDEBAR FIXE IDENTIQUE -->
  <aside class="sidebar">
    <div class="logo">
      <i class="fa-solid fa-notes-medical"></i>
      <span>ORDOPASS</span>
    </div>
    <nav>
      <a href="medecin_dashboard.html"><i class="fa-solid fa-file-medical"></i> <span>Consultations</span></a>
      <a href="patients.html"><i class="fa-solid fa-users"></i> <span>Patients</span></a>
      <a href="teleconsultation.html"><i class="fa-solid fa-video"></i> <span>Téléconsultation</span></a>
      <a href="pharmacies.html"><i class="fa-solid fa-prescription-bottle-medical"></i> <span>Pharmacies</span></a>
      <a href="medecin_messagerie.html"><i class="fa-solid fa-comment-medical"></i> <span>Messagerie</span></a>
      <a href="parametres.html"><i class="fa-solid fa-gear"></i> <span>Paramètres</span></a>
      <a href="medecin_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> <span>Facturation</span></a>
      <a href="medecin_rendezvous.html"><i class="fa-solid fa-calendar-check"></i> <span>Rendez-vous</span></a>
      <a href="medecin_ordonnance.html" class="active"><i class="fa-solid fa-prescription"></i> <span>Ordonnances sécurisées</span></a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> <span>Déconnexion</span></a>
    </nav>
  </aside>

  <!-- ✅ CONTENU PRINCIPAL -->
  <main class="main-area">
    <!-- TOPBAR -->
    <header class="topbar">
      <h1><i class="fa-solid fa-prescription"></i> Ordonnances sécurisées</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay"></span>
      </div>
    </header>

    <!-- CONTENU DÉFILANT -->
    <section class="content">
      <!-- Bouton de retour pour le mode consultation -->
      <div id="backButtonContainer" style="display: none;">
        <button class="btn-back" onclick="exitConsultationMode()">
          <i class="fa-solid fa-arrow-left"></i> Retour au profil patient
        </button>
      </div>

      <!-- Indicateur de mode consultation -->
      <div id="consultationModeIndicator" class="consultation-mode" style="display: none;">
        <i class="fa-solid fa-eye"></i> 
        <strong>Mode consultation</strong>
        <span class="badge">Affichage seule</span>
        <span style="margin-left: 10px; font-size: 0.9rem;">
          Vous consultez une ordonnance existante. Les modifications sont limitées.
        </span>
        <button onclick="exitConsultationMode()" class="btn-outline" style="margin-left: 15px; padding: 4px 8px;">
          <i class="fa-solid fa-pen"></i> Activer l'édition
        </button>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="create">Créer une ordonnance</div>
        <div class="tab" data-tab="list">Mes ordonnances</div>
        <div class="tab" data-tab="search">Rechercher</div>
      </div>

      <!-- Création d'ordonnance -->
      <div class="tab-content active" id="create-tab">
        <div class="card">
          <h2><i class="fa-solid fa-file-prescription"></i> Créer une ordonnance</h2>

          <form id="ordForm" autocomplete="off">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Nom du médecin *</label>
                <input type="text" id="nomMedecin" placeholder="Dr ..." required>
              </div>

              <div class="form-group">
                <label>Nom du patient *</label>
                <input type="text" id="nom" required>
              </div>

              <div class="form-group">
                <label>Âge *</label>
                <input type="number" id="age" required>
              </div>

              <div class="form-group">
                <label>Sexe *</label>
                <select id="genre" required>
                  <option value="">-- Choisir --</option>
                  <option value="F">F</option>
                  <option value="M">M</option>
                </select>
              </div>

              <div class="form-group">
                <label>Adresse *</label>
                <input type="text" id="adresse" required>
              </div>

              <div class="form-group">
                <label>Poids (optionnel)</label>
                <input type="text" id="poids" placeholder="ex: 65 kg">
              </div>
            </div>

            <div class="form-group">
              <label>Médicaments et posologie *</label>
              <textarea id="medicaments" rows="5" placeholder="Ex: Paracétamol 1000mg - 1 comprimé 3 fois par jour pendant 5 jours&#10;Vitamine C - 1 comprimé par jour" required></textarea>
            </div>

            <div class="form-group">
              <label>Date</label>
              <input type="date" id="dateOrd">
            </div>

            <div class="buttons">
              <button type="button" id="genBtn" class="btn-primary">
                <i class="fa-solid fa-eye"></i> Prévisualiser
              </button>
              <button type="button" id="saveBtn" class="btn-secondary">
                <i class="fa-solid fa-save"></i> Sauvegarder
              </button>
              <button type="button" id="sendBtn" class="btn-warning" disabled>
                <i class="fa-solid fa-paper-plane"></i> Envoyer à pharmacie
              </button>
              <button type="button" id="pdfBtn" class="btn-danger" disabled>
                <i class="fa-solid fa-file-pdf"></i> Télécharger PDF
              </button>
            </div>
          </form>

          <!-- Aperçu -->
          <div class="preview" id="preview">
            <!-- L'ordonnance beautifiée sera chargée ici dynamiquement -->
          </div>
        </div>
      </div>

      <!-- Liste des ordonnances -->
      <div class="tab-content" id="list-tab">
        <div class="card">
          <h2><i class="fa-solid fa-list"></i> Mes ordonnances</h2>
          <div class="ordonnance-list" id="ordonnanceList">
            <!-- Les ordonnances seront chargées ici -->
          </div>
        </div>
      </div>

      <!-- Recherche d'ordonnance -->
      <div class="tab-content" id="search-tab">
        <div class="card">
          <h2><i class="fa-solid fa-search"></i> Rechercher une ordonnance</h2>
          <div class="form-group">
            <label>Code de l'ordonnance</label>
            <input type="text" id="searchCode" placeholder="Entrez le code de l'ordonnance">
          </div>
          <button type="button" id="searchBtn" class="btn-primary">
            <i class="fa-solid fa-search"></i> Rechercher
          </button>
          
          <div class="preview" id="searchResult" style="display: none;">
            <h3>Résultat de la recherche</h3>
            <div id="searchContent"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal pour sélectionner une pharmacie -->
  <div id="pharmacieModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-map-location-dot"></i> Sélectionner une pharmacie</h3>
        <span class="modal-close">&times;</span>
      </div>
      
      <!-- Liste des pharmacies uniquement -->
      <div style="margin-top: 15px;">
        <h4><i class="fa-solid fa-list"></i> Liste des pharmacies disponibles</h4>
        <div id="pharmacieList">
          <!-- Les pharmacies seront chargées ici -->
        </div>
      </div>
      
      <div class="buttons" style="margin-top: 20px;">
        <button id="confirmSendBtn" class="btn-primary" disabled>
          <i class="fa-solid fa-paper-plane"></i> Envoyer
        </button>
        <button id="cancelSendBtn" class="btn-secondary">
          <i class="fa-solid fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

<script>
/* ===== Vérification de session ===== */
const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
  alert("⚠️ Veuillez vous connecter");
  window.location.href = "index.html";
}

if (user.role !== "medecin") {
  alert("⚠️ Accès refusé");
  window.location.href = "index.html";
}

/* Afficher le nom du médecin */
document.getElementById("usernameDisplay").textContent = user.username;

/* ===== Logout ===== */
document.getElementById("logout").addEventListener("click", () => {
  localStorage.removeItem("user");
  window.location.href = "index.html";
});

/* ===== Variables globales ===== */
let currentOrdonnance = null;
let currentOrdonnanceId = null;
let selectedPharmacie = null;
let allPharmacies = [];
let currentPatientId = null;

/* ===== Initialisation ===== */
document.addEventListener('DOMContentLoaded', function() {
  // Initialiser la date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateOrd').value = today;
  
  // Remplir le nom du médecin
  if (user.username) {
    document.getElementById('nomMedecin').value = user.username;
  }
  
  // Récupérer les paramètres d'URL pour pré-remplir les infos patient
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patientId');
  const patientName = urlParams.get('patientName');
  const patientAge = urlParams.get('patientAge');
  const patientGender = urlParams.get('patientGender');
  const patientAddress = urlParams.get('patientAddress');

  // Pré-remplir les champs si des infos patient sont fournies
  if (patientName) {
    document.getElementById('nom').value = decodeURIComponent(patientName);
  }

  if (patientAge) {
    document.getElementById('age').value = patientAge;
  }

  if (patientGender) {
    // Convertir "Femme"/"Homme" en "F"/"M"
    let genderValue = patientGender === 'Femme' ? 'F' : patientGender === 'Homme' ? 'M' : patientGender;
    document.getElementById('genre').value = genderValue;
  }

  if (patientAddress) {
    document.getElementById('adresse').value = decodeURIComponent(patientAddress);
  }

  // Stocker l'ID patient pour référence
  if (patientId) {
    currentPatientId = patientId;
  }
  
  // Initialiser les onglets
  initTabs();
  
  // Charger les ordonnances
  loadOrdonnances();
  
  // Charger les pharmacies
  loadPharmaciesForModal();
  
  // Événements des boutons
  document.getElementById('genBtn').addEventListener('click', generatePreview);
  document.getElementById('saveBtn').addEventListener('click', saveOrdonnance);
  document.getElementById('sendBtn').addEventListener('click', openPharmacieModal);
  document.getElementById('pdfBtn').addEventListener('click', generatePDF);
  document.getElementById('searchBtn').addEventListener('click', searchOrdonnance);
  
  // Modal events
  document.querySelector('.modal-close').addEventListener('click', closeModal);
  document.getElementById('cancelSendBtn').addEventListener('click', closeModal);
  document.getElementById('confirmSendBtn').addEventListener('click', sendToPharmacie);
  
  // Vérifier si on vient d'enregistrer une ordonnance
  checkRecentOrdonnance();
});

/* ===== Gestion des onglets ===== */
function initTabs() {
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Retirer la classe active de tous les onglets et contenus
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Activer l'onglet et le contenu correspondant
      this.classList.add('active');
      document.getElementById(tabId + '-tab').classList.add('active');
    });
  });
}

/* ===== Générer l'aperçu ===== */
function generatePreview() {
  // Validation
  const requiredFields = ['nomMedecin', 'nom', 'age', 'genre', 'adresse', 'medicaments'];
  for (const fieldId of requiredFields) {
    const field = document.getElementById(fieldId);
    if (!field.value.trim()) {
      showNotification(`Le champ "${field.previousElementSibling.textContent}" est obligatoire`, 'error');
      field.focus();
      return;
    }
  }
  
  // Générer un code unique
  const code = generateOrdonnanceCode();
  
  // Créer l'objet ordonnance
  currentOrdonnance = {
    code: code,
    medecin: document.getElementById('nomMedecin').value,
    patient: document.getElementById('nom').value,
    age: document.getElementById('age').value,
    genre: document.getElementById('genre').value,
    adresse: document.getElementById('adresse').value,
    poids: document.getElementById('poids').value || 'Non spécifié',
    medicaments: document.getElementById('medicaments').value,
    date: document.getElementById('dateOrd').value || new Date().toISOString().split('T')[0],
    statut: 'active',
    createdAt: new Date().toISOString()
  };
  
  // Ajouter l'ID patient si disponible
  if (currentPatientId) {
    currentOrdonnance.patientId = currentPatientId;
  }
  
  // Afficher l'aperçu
  displayPreview(currentOrdonnance);
  
  // Activer les boutons
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('pdfBtn').disabled = false;
}

function generateOrdonnanceCode() {
  const now = new Date();
  const year = now.getFullYear();
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  const day = now.getDate().toString().padStart(2, '0');
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `ORD-${year}${month}${day}-${random}`;
}

function displayPreview(ordonnance) {
  const previewDiv = document.getElementById('preview');
  
  const previewHTML = `
    <div class="ordonnance-beautiful">
      <div class="ordonnance-header">
        <div class="ordonnance-title">ORDONNANCE MÉDICALE</div>
        <div class="ordonnance-subtitle">Document sécurisé - OrdoPass</div>
      </div>
      
      <div class="ordonnance-content">
        <div class="ordonnance-section">
          <div class="ordonnance-section-title">INFORMATIONS MÉDECIN</div>
          <p><strong>Médecin :</strong> ${ordonnance.medecin}</p>
          <p><strong>Date :</strong> ${ordonnance.date}</p>
          <p><strong>Code ordonnance :</strong> ${ordonnance.code}</p>
        </div>
        
        <div class="ordonnance-section">
          <div class="ordonnance-section-title">INFORMATIONS PATIENT</div>
          <p><strong>Patient :</strong> ${ordonnance.patient}</p>
          <p><strong>Âge :</strong> ${ordonnance.age} ans</p>
          <p><strong>Sexe :</strong> ${ordonnance.genre}</p>
          <p><strong>Adresse :</strong> ${ordonnance.adresse}</p>
          <p><strong>Poids :</strong> ${ordonnance.poids}</p>
        </div>
      </div>
      
      <div class="ordonnance-section">
        <div class="ordonnance-section-title">PRESCRIPTION MÉDICALE</div>
        <div class="ordonnance-medicaments">
          ${ordonnance.medicaments.split('\n').map(line => `
            <div class="medicament-item">
              <div class="medicament-name">${line}</div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="ordonnance-footer">
        <div class="signature-area">
          <div class="signature-image"></div>
          <div class="doctor-stamp">
            <div>${ordonnance.medecin}</div>
            <div>Médecin traitant</div>
          </div>
        </div>
        
        <div class="qr-code-area" id="qrCodeContainer">
          <!-- QR Code sera généré ici -->
        </div>
      </div>
      
      <div class="ordonnance-security">
        <i class="fa-solid fa-shield-alt"></i> 
        Cette ordonnance est sécurisée par OrdoPass. Code de vérification : ${ordonnance.code}
      </div>
    </div>
  `;
  
  previewDiv.innerHTML = previewHTML;
  previewDiv.style.display = 'block';
  
  // Générer le QR Code
  const qrContainer = document.getElementById('qrCodeContainer');
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: JSON.stringify({
      code: ordonnance.code,
      medecin: ordonnance.medecin,
      patient: ordonnance.patient,
      date: ordonnance.date
    }),
    width: 100,
    height: 100
  });
}

/* ===== Sauvegarder l'ordonnance ===== */
function saveOrdonnance() {
  if (!currentOrdonnance) {
    showNotification('Veuillez d\'abord générer un aperçu', 'error');
    return;
  }
  
  // Ajouter un ID unique
  currentOrdonnance.id = Date.now();
  currentOrdonnanceId = currentOrdonnance.id;
  
  // Ajouter l'ID patient si disponible
  if (currentPatientId) {
    currentOrdonnance.patientId = currentPatientId;
  }
  
  // Récupérer les ordonnances existantes
  let ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  
  // Vérifier si l'ordonnance existe déjà
  const existingIndex = ordonnances.findIndex(o => o.id === currentOrdonnance.id);
  if (existingIndex !== -1) {
    ordonnances[existingIndex] = currentOrdonnance;
  } else {
    ordonnances.push(currentOrdonnance);
  }
  
  // Sauvegarder dans le localStorage
  localStorage.setItem('ordonnances', JSON.stringify(ordonnances));
  
  // Marquer comme ordonnance récente
  localStorage.setItem('recentOrdonnance', JSON.stringify(currentOrdonnance));
  
  // Afficher notification et passer à l'onglet "Mes ordonnances"
  showNotification('Ordonnance sauvegardée avec succès ! Redirection vers "Mes ordonnances"...', 'success');
  
  // Activer l'onglet "Mes ordonnances" après un délai
  setTimeout(() => {
    document.querySelector('.tab[data-tab="list"]').click();
    loadOrdonnances();
    
    // Réinitialiser le formulaire
    document.getElementById('ordForm').reset();
    if (user.username) {
      document.getElementById('nomMedecin').value = user.username;
    }
    document.getElementById('dateOrd').value = new Date().toISOString().split('T')[0];
    document.getElementById('preview').style.display = 'none';
    document.getElementById('sendBtn').disabled = true;
    document.getElementById('pdfBtn').disabled = true;
    currentOrdonnance = null;
    currentOrdonnanceId = null;
    currentPatientId = null;
  }, 1500);
}

/* ===== Charger les ordonnances ===== */
function loadOrdonnances() {
  const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const container = document.getElementById('ordonnanceList');
  
  if (ordonnances.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <i class="fa-solid fa-file-prescription" style="font-size: 48px; color: #ccc;"></i>
        <h3>Aucune ordonnance</h3>
        <p>Commencez par créer une ordonnance</p>
      </div>
    `;
    return;
  }
  
  // Trier par date (les plus récentes d'abord)
  ordonnances.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  container.innerHTML = ordonnances.map(ord => `
    <div class="ordonnance-item">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h4>${ord.patient}</h4>
          <p><strong>Médecin :</strong> ${ord.medecin}</p>
          <p><strong>Date :</strong> ${ord.date}</p>
          <p><strong>Code :</strong> ${ord.code}</p>
          <p><strong>Statut :</strong> ${getStatusText(ord.statut || 'active')}</p>
        </div>
        <div>
          <span class="status-badge status-${ord.statut || 'active'}">
            ${getStatusText(ord.statut || 'active')}
          </span>
        </div>
      </div>
      <div class="buttons" style="margin-top: 10px;">
        <button class="btn-outline" onclick="viewOrdonnance('${ord.id}')">
          <i class="fa-solid fa-eye"></i> Voir
        </button>
        <button class="btn-outline" onclick="editOrdonnance('${ord.id}')">
          <i class="fa-solid fa-edit"></i> Modifier
        </button>
        <button class="btn-outline" onclick="sendOrdonnanceToPharmacy('${ord.id}')">
          <i class="fa-solid fa-paper-plane"></i> Envoyer
        </button>
        <button class="btn-outline" onclick="deleteOrdonnance('${ord.id}')">
          <i class="fa-solid fa-trash"></i> Supprimer
        </button>
      </div>
    </div>
  `).join('');
}

function getStatusText(status) {
  const statusMap = {
    'active': 'Active',
    'delivree': 'Délivrée',
    'annulee': 'Annulée',
    'envoyee': 'Envoyée',
    'en_cours': 'En cours',
    'pret': 'Prête',
    'recuperee': 'Récupérée'
  };
  return statusMap[status] || status;
}

/* ===== Gestion des pharmacies pour le modal ===== */
function loadPharmaciesForModal() {
  allPharmacies = JSON.parse(localStorage.getItem('pharmacies')) || [];
  
  // Si pas de pharmacies, en créer quelques-unes par défaut
  if (allPharmacies.length === 0) {
    allPharmacies = [
      {
        id: 'ph1',
        nom: 'Pharmacie du Centre',
        adresse: '123 Avenue de la République, Dakar',
        telephone: '+221 33 821 45 67',
        online: true,
        services: ['Livraison', 'Urgence', '24h/24']
      },
      {
        id: 'ph2',
        nom: 'Pharmacie de la Paix',
        adresse: '456 Rue des Martyrs, Dakar',
        telephone: '+221 33 822 34 56',
        online: true,
        services: ['24h/24', 'Livraison']
      },
      {
        id: 'ph3',
        nom: 'Pharmacie Liberté',
        adresse: '789 Boulevard Liberté, Dakar',
        telephone: '+221 33 823 78 90',
        online: false,
        services: ['Livraison']
      }
    ];
    localStorage.setItem('pharmacies', JSON.stringify(allPharmacies));
  }
}

function openPharmacieModal() {
  if (!currentOrdonnance) {
    showNotification('Veuillez d\'abord sauvegarder l\'ordonnance', 'error');
    return;
  }
  
  const listContainer = document.getElementById('pharmacieList');
  
  if (allPharmacies.length === 0) {
    listContainer.innerHTML = '<p>Aucune pharmacie disponible</p>';
  } else {
    listContainer.innerHTML = allPharmacies.map(pharma => `
      <div class="pharmacie-item" data-id="${pharma.id}" onclick="selectPharmacie('${pharma.id}')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4 style="margin: 0;">${pharma.nom}</h4>
            <p style="margin: 5px 0; color: #666;">${pharma.adresse}</p>
            <p style="margin: 0; color: #666;">${pharma.telephone}</p>
            <div class="services-list" style="margin-top: 5px;">
              ${pharma.services && pharma.services.length > 0 ? 
                pharma.services.map(service => `<span class="service-tag">${service}</span>`).join(' ') : 
                '<span class="service-tag">Générale</span>'
              }
            </div>
          </div>
          <div>
            <span class="online-indicator ${pharma.online ? 'online' : 'offline'}"></span>
            <span>${pharma.online ? 'En ligne' : 'Hors ligne'}</span>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  selectedPharmacie = null;
  document.getElementById('confirmSendBtn').disabled = true;
  document.getElementById('pharmacieModal').style.display = 'block';
}

function selectPharmacie(pharmacieId) {
  // Retirer la sélection de tous les items
  document.querySelectorAll('.pharmacie-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  // Sélectionner l'item cliqué
  const selectedItem = document.querySelector(`.pharmacie-item[data-id="${pharmacieId}"]`);
  if (selectedItem) {
    selectedItem.classList.add('selected');
    selectedPharmacie = pharmacieId;
    document.getElementById('confirmSendBtn').disabled = false;
  }
}

function closeModal() {
  document.getElementById('pharmacieModal').style.display = 'none';
  selectedPharmacie = null;
}

function sendToPharmacie() {
  if (!selectedPharmacie || !currentOrdonnance) {
    showNotification('Veuillez sélectionner une pharmacie', 'error');
    return;
  }
  
  // Récupérer la pharmacie
  const pharmacie = allPharmacies.find(p => p.id === selectedPharmacie);
  
  if (!pharmacie) {
    showNotification('Pharmacie non trouvée', 'error');
    return;
  }
  
  // Mettre à jour le statut de l'ordonnance
  currentOrdonnance.statut = 'envoyee';
  currentOrdonnance.pharmacieId = selectedPharmacie;
  currentOrdonnance.pharmacieNom = pharmacie.nom;
  currentOrdonnance.envoyeeLe = new Date().toISOString();
  
  // Sauvegarder les modifications
  let ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const index = ordonnances.findIndex(o => o.id === currentOrdonnanceId);
  if (index !== -1) {
    ordonnances[index] = currentOrdonnance;
    localStorage.setItem('ordonnances', JSON.stringify(ordonnances));
  }
  
  showNotification(`Ordonnance envoyée à ${pharmacie.nom}`, 'success');
  closeModal();
  loadOrdonnances();
}

/* ===== Envoyer une ordonnance existante à une pharmacie ===== */
function sendOrdonnanceToPharmacy(ordonnanceId) {
  const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const ordonnance = ordonnances.find(o => o.id == ordonnanceId);
  
  if (!ordonnance) {
    showNotification('Ordonnance non trouvée', 'error');
    return;
  }
  
  currentOrdonnance = ordonnance;
  currentOrdonnanceId = ordonnanceId;
  openPharmacieModal();
}

/* ===== Générer PDF ===== */
function generatePDF() {
  if (!currentOrdonnance) {
    showNotification('Veuillez d\'abord générer un aperçu', 'error');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Titre
  doc.setFontSize(20);
  doc.text('ORDONNANCE MÉDICALE', 105, 20, { align: 'center' });
  doc.setFontSize(12);
  doc.text('Document sécurisé - OrdoPass', 105, 30, { align: 'center' });
  
  // Informations médecin
  doc.setFontSize(14);
  doc.text('Médecin : ' + currentOrdonnance.medecin, 20, 50);
  doc.text('Date : ' + currentOrdonnance.date, 20, 60);
  doc.text('Code : ' + currentOrdonnance.code, 20, 70);
  
  // Informations patient
  doc.text('Patient : ' + currentOrdonnance.patient, 20, 90);
  doc.text('Âge : ' + currentOrdonnance.age + ' ans', 20, 100);
  doc.text('Sexe : ' + currentOrdonnance.genre, 20, 110);
  doc.text('Adresse : ' + currentOrdonnance.adresse, 20, 120);
  doc.text('Poids : ' + currentOrdonnance.poids, 20, 130);
  
  // Prescription
  doc.setFontSize(16);
  doc.text('PRESCRIPTION :', 20, 150);
  doc.setFontSize(12);
  
  let y = 160;
  const lines = currentOrdonnance.medicaments.split('\n');
  lines.forEach(line => {
    if (line.trim()) {
      doc.text('• ' + line, 25, y);
      y += 10;
    }
  });
  
  // Signature
  doc.setFontSize(12);
  doc.text('Signature :', 20, y + 20);
  doc.text(currentOrdonnance.medecin, 20, y + 30);
  doc.text('Médecin traitant', 20, y + 35);
  
  // Enregistrer le PDF
  doc.save(`ordonnance-${currentOrdonnance.code}.pdf`);
  showNotification('PDF généré avec succès !', 'success');
}

/* ===== Recherche d'ordonnance ===== */
function searchOrdonnance() {
  const code = document.getElementById('searchCode').value.trim();
  
  if (!code) {
    showNotification('Veuillez entrer un code', 'error');
    return;
  }
  
  const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const found = ordonnances.find(ord => ord.code === code);
  
  const resultDiv = document.getElementById('searchResult');
  const contentDiv = document.getElementById('searchContent');
  
  if (!found) {
    contentDiv.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <i class="fa-solid fa-search" style="font-size: 48px; color: #ccc;"></i>
        <h4>Aucune ordonnance trouvée</h4>
        <p>Vérifiez le code et réessayez</p>
      </div>
    `;
  } else {
    contentDiv.innerHTML = `
      <div class="ordonnance-item">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h4>${found.patient}</h4>
            <p><strong>Médecin :</strong> ${found.medecin}</p>
            <p><strong>Date :</strong> ${found.date}</p>
            <p><strong>Code :</strong> ${found.code}</p>
            <p><strong>Statut :</strong> ${getStatusText(found.statut || 'active')}</p>
            ${found.pharmacieNom ? `<p><strong>Pharmacie :</strong> ${found.pharmacieNom}</p>` : ''}
          </div>
          <div>
            <span class="status-badge status-${found.statut || 'active'}">
              ${getStatusText(found.statut || 'active')}
            </span>
          </div>
        </div>
        <div class="buttons" style="margin-top: 10px;">
          <button class="btn-outline" onclick="viewOrdonnance('${found.id}')">
            <i class="fa-solid fa-eye"></i> Voir détails
          </button>
          <button class="btn-outline" onclick="generatePDFFromSearch('${found.id}')">
            <i class="fa-solid fa-file-pdf"></i> PDF
          </button>
        </div>
      </div>
    `;
  }
  
  resultDiv.style.display = 'block';
}

function generatePDFFromSearch(ordonnanceId) {
  const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const ordonnance = ordonnances.find(o => o.id == ordonnanceId);
  
  if (ordonnance) {
    currentOrdonnance = ordonnance;
    generatePDF();
  }
}

/* ===== Voir/Modifier une ordonnance ===== */
function viewOrdonnance(ordonnanceId) {
  const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const ordonnance = ordonnances.find(o => o.id == ordonnanceId);
  
  if (ordonnance) {
    // Activer l'onglet création
    document.querySelector('.tab.active').classList.remove('active');
    document.querySelector('.tab-content.active').classList.remove('active');
    
    document.querySelector('.tab[data-tab="create"]').classList.add('active');
    document.getElementById('create-tab').classList.add('active');
    
    // Remplir le formulaire
    document.getElementById('nomMedecin').value = ordonnance.medecin;
    document.getElementById('nom').value = ordonnance.patient;
    document.getElementById('age').value = ordonnance.age;
    document.getElementById('genre').value = ordonnance.genre;
    document.getElementById('adresse').value = ordonnance.adresse;
    document.getElementById('poids').value = ordonnance.poids;
    document.getElementById('medicaments').value = ordonnance.medicaments;
    document.getElementById('dateOrd').value = ordonnance.date;
    
    // Générer l'aperçu
    currentOrdonnance = ordonnance;
    currentOrdonnanceId = ordonnanceId;
    displayPreview(ordonnance);
    
    // Activer les boutons
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('pdfBtn').disabled = false;
    
    // Afficher le mode consultation
    document.getElementById('consultationModeIndicator').style.display = 'block';
    document.getElementById('backButtonContainer').style.display = 'block';
  }
}

function editOrdonnance(ordonnanceId) {
  viewOrdonnance(ordonnanceId);
  document.getElementById('consultationModeIndicator').style.display = 'none';
  document.getElementById('backButtonContainer').style.display = 'none';
}

function deleteOrdonnance(ordonnanceId) {
  if (confirm('Voulez-vous vraiment supprimer cette ordonnance ?')) {
    let ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
    ordonnances = ordonnances.filter(o => o.id != ordonnanceId);
    localStorage.setItem('ordonnances', JSON.stringify(ordonnances));
    
    if (currentOrdonnanceId == ordonnanceId) {
      currentOrdonnance = null;
      currentOrdonnanceId = null;
    }
    
    loadOrdonnances();
    showNotification('Ordonnance supprimée', 'success');
  }
}

function exitConsultationMode() {
  document.getElementById('consultationModeIndicator').style.display = 'none';
  document.getElementById('backButtonContainer').style.display = 'none';
  
  // Réinitialiser le formulaire
  document.getElementById('ordForm').reset();
  if (user.username) {
    document.getElementById('nomMedecin').value = user.username;
  }
  document.getElementById('dateOrd').value = new Date().toISOString().split('T')[0];
  document.getElementById('preview').style.display = 'none';
  currentOrdonnance = null;
  currentOrdonnanceId = null;
}

/* ===== Vérifier si une ordonnance vient d'être enregistrée ===== */
function checkRecentOrdonnance() {
  const recentOrdonnance = localStorage.getItem('recentOrdonnance');
  if (recentOrdonnance) {
    try {
      const ordonnance = JSON.parse(recentOrdonnance);
      showNotification(`Ordonnance ${ordonnance.code} enregistrée avec succès !`, 'success');
      
      // Nettoyer
      localStorage.removeItem('recentOrdonnance');
    } catch (e) {
      console.error('Erreur lors du parsing de l\'ordonnance:', e);
    }
  }
}

/* ===== Notifications ===== */
function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 3000);
}
</script>
</body> 
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ordonnances - OrdoPass</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.preview{margin-top:20px;border:1px solid #ddd;padding:20px;border-radius:8px;background:#fff}
.tabs{display:flex;margin-bottom:15px}
.tab{padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent}
.tab.active{border-bottom:3px solid #2a5298;color:#2a5298;font-weight:bold}
.tab-content{display:none}
.tab-content.active{display:block}
.ordonnance-item{border:1px solid #ddd;padding:10px;border-radius:6px;margin-bottom:10px;background:#f8f9fa}
.badge{padding:4px 8px;border-radius:10px;font-size:12px}
.btn{padding:8px 15px;border:none;border-radius:5px;cursor:pointer}
.btn-primary{background:#2a5298;color:white}
.btn-secondary{background:#28a745;color:white}
</style>
</head>

<body class="dashboard-page">

<aside class="sidebar">
<div class="logo"><i class="fa-solid fa-notes-medical"></i> ORDOPASS</div>
<nav>
<a href="medecin_dashboard.html">Consultations</a>
<a href="patients.html">Patients</a>
<a href="teleconsultation.html">Téléconsultation</a>
<a href="pharmacies.html">Pharmacies</a>
<a href="medecin_ordonnance.html" class="active">Ordonnances</a>
<a href="#" id="logout">Déconnexion</a>
</nav>
</aside>

<main class="main-area">

<header class="topbar">
<h1>Ordonnances sécurisées</h1>
<span id="usernameDisplay"></span>
</header>

<section class="content">

<div class="tabs">
<div class="tab active" data-tab="create-tab">Créer</div>
<div class="tab" data-tab="list-tab">Mes ordonnances</div>
<div class="tab" data-tab="search-tab">Rechercher</div>
</div>

<!-- CREATION -->
<div class="tab-content active" id="create-tab">

<form id="ordForm">

<input id="nomMedecin" placeholder="Nom du médecin" required>
<input id="nom" placeholder="Nom patient" required>
<input id="age" type="number" placeholder="Âge" required>
<input id="adresse" placeholder="Adresse" required>

<textarea id="medicaments" placeholder="Médicaments..." required></textarea>

<button type="button" id="previewBtn" class="btn btn-primary">Prévisualiser</button>
<button type="button" id="saveBtn" class="btn btn-secondary">Sauvegarder</button>

</form>

<div class="preview" id="preview" style="display:none"></div>

</div>

<!-- LISTE -->
<div class="tab-content" id="list-tab">
<div id="ordonnanceList"></div>
</div>

<!-- RECHERCHE -->
<div class="tab-content" id="search-tab">
<input id="searchCode" placeholder="Code ordonnance">
<button id="searchBtn" class="btn btn-primary">Rechercher</button>
<div id="searchResult"></div>
</div>

</section>
</main>

<script>
// ✅ SESSION CORRIGÉE
const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role !== "medecin"){
 alert("Accès refusé");
 location.href="index.html";
}
document.getElementById("usernameDisplay").textContent = user.username;

// LOGOUT
document.getElementById("logout").onclick=()=>{
 localStorage.removeItem("user");
 location.href="index.html";
}

// TABS
document.querySelectorAll(".tab").forEach(tab=>{
 tab.onclick=()=>{
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
 document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
 tab.classList.add("active");
 document.getElementById(tab.dataset.tab).classList.add("active");
 if(tab.dataset.tab==="list-tab") loadOrdonnances();
 }
});

// PREVIEW
document.getElementById("previewBtn").onclick=()=>{
 const html=`
 <h3>Ordonnance</h3>
 <b>Médecin:</b> ${nomMedecin.value}<br>
 <b>Patient:</b> ${nom.value}<br>
 <b>Age:</b> ${age.value}<br>
 <b>Adresse:</b> ${adresse.value}<br><br>
 <b>Médicaments:</b><br>${medicaments.value.replace(/\n/g,"<br>")}
 `;
 preview.innerHTML=html;
 preview.style.display="block";
}

// SAVE
document.getElementById("saveBtn").onclick=()=>{
 const ordonnance={
 id:Date.now(),
 code:"ORD-"+Math.floor(Math.random()*100000),
 medecin:nomMedecin.value,
 patient:nom.value,
 age:age.value,
 adresse:adresse.value,
 medicaments:medicaments.value,
 date:new Date().toLocaleDateString()
 };

 let list=JSON.parse(localStorage.getItem("ordonnances"))||[];
 list.push(ordonnance);
 localStorage.setItem("ordonnances",JSON.stringify(list));

 alert("Ordonnance enregistrée");
 document.getElementById("ordForm").reset();
 preview.style.display="none";
}

// LOAD LIST
function loadOrdonnances(){
 const listDiv=document.getElementById("ordonnanceList");
 let list=JSON.parse(localStorage.getItem("ordonnances"))||[];
 if(list.length===0){listDiv.innerHTML="Aucune ordonnance";return;}
 listDiv.innerHTML="";
 list.forEach(o=>{
 listDiv.innerHTML+=`
 <div class="ordonnance-item">
 <b>${o.patient}</b><br>
 Code: ${o.code}<br>
 Date: ${o.date}<br>
 </div>
 `;
 });
}

// SEARCH
document.getElementById("searchBtn").onclick=()=>{
 const code=searchCode.value;
 let list=JSON.parse(localStorage.getItem("ordonnances"))||[];
 let found=list.find(o=>o.code===code);
 if(found){
 searchResult.innerHTML=`<div class="preview">
 <b>${found.patient}</b><br>
 ${found.medicaments}
 </div>`;
 }else{
 searchResult.innerHTML="Aucune ordonnance trouvée";
 }
}
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patients - OrdoPass</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial}
body{background:#f5f5f5}
.dashboard-page{display:flex;min-height:100vh}
.sidebar{width:250px;background:#2a5298;color:#fff;padding:20px 0;position:fixed;height:100vh}
.sidebar nav a{color:#fff;text-decoration:none;padding:12px 20px;display:flex;gap:10px}
.sidebar nav a.active{background:rgba(255,255,255,.2)}
.main-area{margin-left:250px;flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;padding:15px 30px;display:flex;justify-content:space-between}
.content{padding:30px}
.card{background:#fff;border-radius:8px;padding:25px}
.btn-primary{background:#2a5298;color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer}
.btn-outline{border:1px solid #2a5298;color:#2a5298;padding:6px 12px;border-radius:5px;background:#fff;cursor:pointer}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #eee}
.stat-card{background:#fff;border:1px solid #eee;padding:15px;text-align:center;border-radius:6px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:20px 0}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}
.modal-content{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:400px}
.modal-content input{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px}
.action-buttons{display:flex;gap:5px}
</style>
</head>

<body class="dashboard-page">

<!-- SIDEBAR -->
<aside class="sidebar">
<nav>
<a href="medecin_dashboard.html">Consultations</a>
<a href="patients.html" class="active">Patients</a>
<a href="medecin_ordonnance.html">Ordonnances</a>
<a href="#" id="logout">Déconnexion</a>
</nav>
</aside>

<!-- MAIN -->
<main class="main-area">

<header class="topbar">
<h2>Liste des patients</h2>
<span id="usernameDisplay"></span>
</header>

<section class="content">
<div class="card">

<button class="btn-primary" onclick="showAddForm()">+ Nouveau patient</button>

<!-- STATS -->
<div class="stats-grid">
<div class="stat-card"><h3 id="totalPatients">0</h3><p>Total</p></div>
<div class="stat-card"><h3 id="adultPatients">0</h3><p>Adultes</p></div>
<div class="stat-card"><h3 id="recentPatients">0</h3><p>Ce mois</p></div>
</div>

<table>
<thead>
<tr>
<th>Image</th>
<th>Nom</th>
<th>Age</th>
<th>Téléphone</th>
<th>Adresse</th>
<th>Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="patientsBody"></tbody>
</table>

</div>
</section>
</main>

<!-- MODAL -->
<div id="modal" class="modal">
<div class="modal-content">
<h3 id="modalTitle">Ajouter patient</h3>
<input type="text" id="name" placeholder="Nom complet">
<input type="number" id="age" placeholder="Age">
<input type="text" id="phone" placeholder="Téléphone">
<input type="text" id="address" placeholder="Adresse">
<input type="text" id="image" placeholder="Image URL">
<div style="display:flex;gap:10px;justify-content:end">
<button class="btn-primary" onclick="savePatient()">Enregistrer</button>
<button class="btn-outline" onclick="closeForm()">Annuler</button>
</div>
</div>
</div>

<script>
const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role!=="medecin"){location.href="medecin_login.html";}
document.getElementById("usernameDisplay").textContent=user.username;

let allPatients=[];
let editingId=null;

/* =========================
   LOAD PATIENTS CORRIGÉ
========================= */
function loadPatients(){
let patients=JSON.parse(localStorage.getItem("patients"));

if(!patients || patients.length===0){
patients=[
{id:1,name:"Diop Awa",age:32,phone:"+221771234567",address:"Dakar",image:"https://i.pravatar.cc/40?u=awa",added:"13/07/2025"}
];
localStorage.setItem("patients",JSON.stringify(patients));
}

/* compatibilité consultation */
patients=patients.map(p=>({
id:p.id,
name:p.name || (p.prenom? p.prenom+" "+p.nom:""),
age:p.age||"",
phone:p.phone||p.telephone||"",
address:p.address||p.adresse||"",
image:p.image||"https://i.pravatar.cc/40",
added:p.added || (p.createdAt? new Date(p.createdAt).toLocaleDateString("fr-FR"):"")
}));

allPatients=patients;
renderPatients();
updateStats();
}

/* ========================= */
function renderPatients(){
const tbody=document.getElementById("patientsBody");
tbody.innerHTML="";

allPatients.forEach(p=>{
tbody.innerHTML+=`
<tr>
<td><img src="${p.image}" class="avatar"></td>
<td>${p.name}</td>
<td>${p.age}</td>
<td>${p.phone}</td>
<td>${p.address}</td>
<td>${p.added}</td>
<td class="action-buttons">
<button class="btn-outline" onclick="editPatient(${p.id})">Modifier</button>
<button class="btn-outline" style="color:red" onclick="deletePatient(${p.id})">Supprimer</button>
</td>
</tr>`;
});
}

/* ========================= */
function updateStats(){
const total=allPatients.length;
const adult=allPatients.filter(p=>p.age>=18).length;

const now=new Date();
const month=now.getMonth();
const year=now.getFullYear();

const recent=allPatients.filter(p=>{
if(!p.added)return false;
const [d,m,y]=p.added.split("/");
return (parseInt(m)-1===month && parseInt(y)===year);
}).length;

document.getElementById("totalPatients").textContent=total;
document.getElementById("adultPatients").textContent=adult;
document.getElementById("recentPatients").textContent=recent;
}

/* ========================= */
function showAddForm(){
editingId=null;
document.getElementById("modalTitle").textContent="Ajouter patient";
document.getElementById("modal").style.display="flex";
}

/* ========================= */
function editPatient(id){
const p=allPatients.find(x=>x.id===id);
if(!p)return;

editingId=id;
document.getElementById("modalTitle").textContent="Modifier patient";
document.getElementById("name").value=p.name;
document.getElementById("age").value=p.age;
document.getElementById("phone").value=p.phone;
document.getElementById("address").value=p.address;
document.getElementById("image").value=p.image;

document.getElementById("modal").style.display="flex";
}

/* ========================= */
function closeForm(){
document.getElementById("modal").style.display="none";
}

/* ========================= */
function savePatient(){
const name=document.getElementById("name").value;
const age=document.getElementById("age").value;
const phone=document.getElementById("phone").value;
const address=document.getElementById("address").value;
const image=document.getElementById("image").value;

if(!name||!age){alert("Nom et age obligatoires");return;}

let patients=JSON.parse(localStorage.getItem("patients"))||[];

if(editingId){
const index=patients.findIndex(p=>p.id===editingId);
patients[index]={...patients[index],name,age,phone,address,image};
}else{
patients.push({
id:Date.now(),
name,
age,
phone,
address,
image:image||"https://i.pravatar.cc/40",
added:new Date().toLocaleDateString("fr-FR")
});
}

localStorage.setItem("patients",JSON.stringify(patients));
closeForm();
loadPatients();
}

/* ========================= */
function deletePatient(id){
if(!confirm("Supprimer ce patient ?"))return;
let patients=JSON.parse(localStorage.getItem("patients"))||[];
patients=patients.filter(p=>p.id!==id);
localStorage.setItem("patients",JSON.stringify(patients));
loadPatients();
}

/* ========================= */
document.getElementById("logout").onclick=()=>{
localStorage.removeItem("user");
location.href="medecin_login.html";
}

/* ========================= */
loadPatients();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients - OrdoPass</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .dashboard-page {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 250px;
      background: #2a5298;
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .logo i {
      font-size: 24px;
    }
    
    .logo span {
      font-size: 18px;
      font-weight: bold;
    }
    
    .sidebar nav {
      display: flex;
      flex-direction: column;
    }
    
    .sidebar nav a {
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s;
    }
    
    .sidebar nav a:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .sidebar nav a.active {
      background: rgba(255,255,255,0.2);
      border-left: 4px solid white;
    }
    
    .main-area {
      flex: 1;
      margin-left: 250px;
      display: flex;
      flex-direction: column;
    }
    
    .topbar {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .topbar h1 {
      color: #2a5298;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 25px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .card-header h2 {
      color: #2a5298;
      font-size: 20px;
    }
    
    .btn-primary {
      background: #2a5298;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      background: #1e3c72;
    }
    
    .btn-outline {
      border: 1px solid #2a5298;
      color: #2a5298;
      background: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s;
    }
    
    .btn-outline:hover {
      background: #f0f5ff;
    }
    
    .message-container {
      margin-bottom: 20px;
    }
    
    .message {
      padding: 12px 15px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }
    
    .filters-container {
      display: flex;
      gap: 15px;
      align-items: end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .filter-group label {
      font-weight: bold;
      color: #555;
      font-size: 0.9rem;
    }
    
    .filters-container input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-width: 250px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 32px;
      color: #2a5298;
      margin-bottom: 5px;
    }
    
    .stat-card p {
      color: #666;
      font-size: 0.9rem;
    }
    
    .stat-card.pending {
      border-left: 4px solid #ffc107;
    }
    
    .stat-card.completed {
      border-left: 4px solid #28a745;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #555;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .loading, .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .no-data i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #ddd;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-view {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-view:hover {
      background: #138496;
    }
    
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .pagination-info {
      color: #666;
      font-size: 0.9rem;
    }
    
    .pagination-buttons {
      display: flex;
      gap: 10px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    
    .modal-content h2 {
      margin-bottom: 20px;
      color: #2a5298;
    }
    
    .modal-content input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* Styles pour le modal des pharmacies */
    .pharmacie-item {
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .pharmacie-item:hover {
      background-color: #f5f5f5;
    }
    
    .pharmacie-item.selected {
      background-color: #e6f7ff;
      border-color: #2a5298;
    }
    
    .online-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .online {
      background-color: #28a745;
    }
    
    .offline {
      background-color: #dc3545;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }
      
      .sidebar .logo span,
      .sidebar nav a span {
        display: none;
      }
      
      .main-area {
        margin-left: 70px;
      }
      
      .filters-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filters-container input {
        min-width: auto;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>

<body class="dashboard-page">

  <!-- ‚úÖ SIDEBAR FIXE AVEC D√âFILEMENT -->
  <aside class="sidebar">
    <div class="logo">
      <i class="fa-solid fa-notes-medical"></i>
      <span>ORDOPASS</span>
    </div>
    <nav>
      <a href="medecin_dashboard.html"><i class="fa-solid fa-file-medical"></i> <span>Consultations</span></a>
      <a href="patients.html" class="active"><i class="fa-solid fa-users"></i> <span>Patients</span></a>
      <a href="teleconsultation.html"><i class="fa-solid fa-video"></i> <span>T√©l√©consultation</span></a>
      <a href="pharmacies.html"><i class="fa-solid fa-prescription-bottle-medical"></i> <span>Pharmacies</span></a>
      <a href="medecin_messagerie.html"><i class="fa-solid fa-comment-medical"></i> <span>Messagerie</span></a>
      <a href="parametres.html"><i class="fa-solid fa-gear"></i> <span>Param√®tres</span></a>
      <a href="medecin_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> <span>Facturation</span></a>
      <a href="medecin_rendezvous.html"><i class="fa-solid fa-calendar-check"></i> <span>Rendez-vous</span></a>
      <a href="medecin_ordonnance.html"><i class="fa-solid fa-prescription"></i> <span>Ordonnances s√©curis√©es</span></a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> <span>D√©connexion</span></a>
    </nav>
  </aside>

  <!-- ‚úÖ CONTENU PRINCIPAL -->
  <main class="main-area">
    <!-- TOPBAR -->
    <header class="topbar">
      <h1><i class="fa-solid fa-users"></i> Liste des patients</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay"></span>
      </div>
    </header>

    <!-- CONTENU D√âFILANT -->
    <section class="content">
      <div class="card">
        <div class="card-header">
          <h2>Gestion des patients</h2>
          <button class="btn-primary" onclick="showAddForm()">
            <i class="fa-solid fa-plus"></i> Nouveau patient
          </button>
        </div>

        <div id="messageContainer" class="message-container"></div>

        <!-- Filtres et recherche -->
        <div class="filters-container">
          <div class="filter-group">
            <label>Rechercher:</label>
            <input type="text" id="searchInput" placeholder="Nom du patient..." onkeyup="filterPatients()">
          </div>
          <button class="btn-outline" onclick="clearSearch()">
            <i class="fa-solid fa-times"></i> Effacer
          </button>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="totalPatients">0</h3>
            <p>Total patients</p>
          </div>
          <div class="stat-card pending">
            <h3 id="recentPatients">0</h3>
            <p>Ajout√©s ce mois</p>
          </div>
          <div class="stat-card completed">
            <h3 id="adultPatients">0</h3>
            <p>Patients adultes</p>
          </div>
        </div>

        <!-- Table des patients -->
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Nom</th>
              <th>√Çge</th>
              <th>T√©l√©phone</th>
              <th>Adresse</th>
              <th>Date ajout</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="patientsBody">
            <tr>
              <td colspan="7" class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i> Chargement des patients...
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination-container">
          <div id="paginationInfo" class="pagination-info"></div>
          <div class="pagination-buttons">
            <button class="btn-outline" id="prevBtn" onclick="changePage(-1)">
              <i class="fa-solid fa-chevron-left"></i> Pr√©c√©dent
            </button>
            <button class="btn-outline" id="nextBtn" onclick="changePage(1)">
              Suivant <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal formulaire patient -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Ajouter patient</h2>
      <input type="text" id="name" placeholder="Nom complet" required>
      <input type="number" id="age" placeholder="√Çge" required>
      <input type="text" id="phone" placeholder="T√©l√©phone">
      <input type="text" id="address" placeholder="Adresse">
      <input type="text" id="image" placeholder="URL de l'image (optionnel)">
      <div class="modal-actions">
        <button id="saveBtn" class="btn-primary">Enregistrer</button>
        <button onclick="closeForm()" class="btn-outline">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Modal pour s√©lectionner une pharmacie -->
  <div id="pharmacieModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-map-location-dot"></i> S√©lectionner une pharmacie</h3>
        <span class="modal-close">&times;</span>
      </div>
      
      <!-- Liste des pharmacies uniquement -->
      <div style="margin-top: 15px;">
        <h4><i class="fa-solid fa-list"></i> Liste des pharmacies disponibles</h4>
        <div id="pharmacieList">
          <!-- Les pharmacies seront charg√©es ici -->
        </div>
      </div>
      
      <div class="buttons" style="margin-top: 20px;">
        <button id="confirmSendBtn" class="btn-primary" disabled>
          <i class="fa-solid fa-paper-plane"></i> Envoyer
        </button>
        <button id="cancelSendBtn" class="btn-secondary">
          <i class="fa-solid fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <script>
    // V√©rification de session
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if(!user || user.role !== "medecin") {
      alert("‚ö†Ô∏è Acc√®s refus√©. Veuillez vous connecter.");
      window.location.href = "index.html";
    }

    document.getElementById("usernameDisplay").textContent = user.username;

    let allPatients = [];
    let filteredPatients = [];
    let currentPage = 1;
    const patientsPerPage = 10;
    let editId = null;

    // Variables pour l'envoi d'ordonnance
    let selectedPharmacieId = null;
    let currentOrdonnanceId = null;

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `
        <div class="message ${type}">
          ${message}
        </div>
      `;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    function loadPatients() {
      try {
        const patients = JSON.parse(localStorage.getItem("patients")) || [
          {id:1, name:"Diop Awa", age:32, phone:"+221771234567", address:"Dakar", image:"https://i.pravatar.cc/40?u=awa", added:"13/07/2025"},
          {id:2, name:"Konte Habiba", age:30, phone:"+221772345678", address:"Dakar", image:"https://i.pravatar.cc/40?u=habiba", added:"30/10/2025"},
          {id:3, name:"Ba Aicha", age:30, phone:"+221773456789", address:"Non renseign√©", image:"https://i.pravatar.cc/40?u=aicha", added:"29/10/2025"},
          {id:4, name:"Leslie Alexander", age:28, phone:"+221774567890", address:"Thi√®s", image:"https://i.pravatar.cc/40?u=leslie", added:"28/10/2025"},
          {id:5, name:"Ba Habiba", age:23, phone:"+221775678901", address:"Dakar", image:"https://i.pravatar.cc/40?u=ba", added:"05/11/2025"},
          {id:6, name:"Sow Fatou", age:28, phone:"+221776789012", address:"Thi√®s", image:"https://i.pravatar.cc/40?u=fatou", added:"12/07/2025"}
        ];
        
        // Assurer que tous les patients ont un ID
        const patientsWithIds = patients.map((patient, index) => {
          if (!patient.id) {
            patient.id = Date.now() + index;
          }
          return patient;
        });
        
        allPatients = patientsWithIds;
        filteredPatients = [...allPatients];
        renderPatients();
        updateStats();
      } catch (error) {
        showMessage('‚ùå Erreur lors du chargement des patients', 'error');
      }
    }

    function filterPatients() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      filteredPatients = allPatients.filter(patient => {
        return patient.name.toLowerCase().includes(searchTerm);
      });

      currentPage = 1;
      renderPatients();
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      filterPatients();
    }

    function updateStats() {
      const total = allPatients.length;
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      const recent = allPatients.filter(patient => {
        const addedDate = new Date(patient.added);
        return addedDate.getMonth() === currentMonth && addedDate.getFullYear() === currentYear;
      }).length;
      
      const adults = allPatients.filter(patient => patient.age >= 18).length;

      document.getElementById('totalPatients').textContent = total;
      document.getElementById('recentPatients').textContent = recent;
      document.getElementById('adultPatients').textContent = adults;
    }

    function renderPatients() {
      const tbody = document.getElementById("patientsBody");
      
      if (filteredPatients.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="no-data">
              <i class="fa-solid fa-user-slash"></i>
              <p>Aucun patient trouv√©</p>
              <button onclick="showAddForm()" class="btn-primary">
                <i class="fa-solid fa-plus"></i> Ajouter un patient
              </button>
            </td>
          </tr>
        `;
        updatePagination();
        return;
      }

      const startIndex = (currentPage - 1) * patientsPerPage;
      const endIndex = startIndex + patientsPerPage;
      const patientsToShow = filteredPatients.slice(startIndex, endIndex);

      tbody.innerHTML = "";

      patientsToShow.forEach(patient => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="${patient.image || 'https://i.pravatar.cc/40'}" alt="${patient.name}" class="avatar"></td>
          <td><strong>${patient.name}</strong></td>
          <td>${patient.age} ans</td>
          <td>${patient.phone || 'Non renseign√©'}</td>
          <td>${patient.address || 'Non renseign√©e'}</td>
          <td>${patient.added}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-view viewBtn" data-id="${patient.id}">
                <i class="fa-solid fa-eye"></i> Voir
              </button>
              <button class="btn-outline editBtn" data-id="${patient.id}">
                <i class="fa-solid fa-pen"></i>
              </button>
              <button class="btn-outline deleteBtn" data-id="${patient.id}" style="color: #dc3545; border-color: #dc3545;">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tr.querySelector(".viewBtn").addEventListener("click", function() {
          const id = this.getAttribute('data-id');
          viewPatient(id);
        });
        
        tr.querySelector(".editBtn").addEventListener("click", function() {
          const id = this.getAttribute('data-id');
          editPatient(id);
        });
        
        tr.querySelector(".deleteBtn").addEventListener("click", function() {
          const id = this.getAttribute('data-id');
          deletePatient(id);
        });
        
        tbody.appendChild(tr);
      });
      
      updatePagination();
    }

    // FONCTION CORRIG√âE POUR LA REDIRECTION
    function viewPatient(id) {
      const patient = allPatients.find(p => p.id.toString() === id.toString());
      if (patient) {
        // Stocker le patient dans localStorage avec une cl√© sp√©cifique
        localStorage.setItem('selectedPatientForProfile', JSON.stringify(patient));
        
        // Rediriger vers le profil avec l'ID dans l'URL
        window.location.href = `patient_profile.html?id=${patient.id}`;
        
        console.log('üîó Redirection vers profil patient:', patient.id, patient.name);
      } else {
        console.error('‚ùå Patient non trouv√© avec ID:', id);
        alert('Patient non trouv√©');
      }
    }

    function showAddForm(){
      editId = null;
      document.getElementById("modalTitle").innerText = "Ajouter patient";
      document.getElementById("name").value = "";
      document.getElementById("age").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("address").value = "";
      document.getElementById("image").value = "";
      document.getElementById("modal").style.display = "flex";
    }

    function closeForm(){ 
      document.getElementById("modal").style.display = "none"; 
    }

    document.getElementById("saveBtn").addEventListener("click", () => {
      const name = document.getElementById("name").value.trim();
      const age = parseInt(document.getElementById("age").value);
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const image = document.getElementById("image").value.trim() || "https://i.pravatar.cc/40";

      if(!name || !age) {
        alert("Nom et √¢ge obligatoires");
        return;
      }

      if(editId){
        const p = allPatients.find(p => p.id === editId);
        if (p) {
          p.name = name; 
          p.age = age; 
          p.phone = phone; 
          p.address = address; 
          p.image = image;
          showMessage('‚úÖ Patient modifi√© avec succ√®s', 'success');
        }
      } else {
        const newId = allPatients.length ? Math.max(...allPatients.map(p => p.id)) + 1 : 1;
        allPatients.push({
          id: newId, 
          name, 
          age, 
          phone, 
          address, 
          image, 
          added: new Date().toLocaleDateString("fr-FR")
        });
        showMessage('‚úÖ Patient ajout√© avec succ√®s', 'success');
      }

      localStorage.setItem("patients", JSON.stringify(allPatients));
      loadPatients();
      closeForm();
    });

    function editPatient(id){
      editId = id;
      const p = allPatients.find(p => p.id === id);
      if (p) {
        document.getElementById("modalTitle").innerText = "Modifier patient";
        document.getElementById("name").value = p.name;
        document.getElementById("age").value = p.age;
        document.getElementById("phone").value = p.phone || "";
        document.getElementById("address").value = p.address || "";
        document.getElementById("image").value = p.image || "";
        document.getElementById("modal").style.display = "flex";
      }
    }

    function deletePatient(id){
      if(confirm("Voulez-vous vraiment supprimer ce patient ?")){
        allPatients = allPatients.filter(p => p.id.toString() !== id.toString());
        localStorage.setItem("patients", JSON.stringify(allPatients));
        showMessage('‚úÖ Patient supprim√© avec succ√®s', 'success');
        loadPatients();
      }
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
      const startItem = (currentPage - 1) * patientsPerPage + 1;
      const endItem = Math.min(currentPage * patientsPerPage, filteredPatients.length);
      document.getElementById('paginationInfo').textContent = 
        `Affichage de ${startItem} √† ${endItem} sur ${filteredPatients.length} patients`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
    }

    function changePage(direction) {
      const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
      currentPage += direction;
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages) currentPage = totalPages;
      renderPatients();
    }

    // =================================================================
    // FONCTIONS POUR L'ENVOI √Ä LA PHARMACIE - AJOUT√âES
    // =================================================================

    // Fonctions pour l'envoi √† la pharmacie
    async function openPharmacieModal() {
      if (!currentOrdonnanceId) {
        alert("Veuillez d'abord sauvegarder l'ordonnance");
        return;
      }
      
      await loadPharmacies();
      document.getElementById('pharmacieModal').style.display = 'block';
    }

    function closePharmacieModal() {
      document.getElementById('pharmacieModal').style.display = 'none';
      selectedPharmacieId = null;
      document.getElementById('confirmSendBtn').disabled = true;
      document.getElementById('confirmSendBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i> Envoyer';
    }

    async function loadPharmacies() {
      try {
        let pharmacies = [];
        
        console.log('üîÑ Chargement des pharmacies...');
        
        // Essayer de charger depuis l'API
        try {
          const response = await fetch('/api/pharmacies');
          if (response.ok) {
            pharmacies = await response.json();
            console.log('‚úÖ Pharmacies charg√©es depuis API:', pharmacies.length);
            // Sauvegarder dans localStorage
            localStorage.setItem('pharmacies', JSON.stringify(pharmacies));
          } else {
            throw new Error('API non disponible');
          }
        } catch (error) {
          console.log('‚ö†Ô∏è Fallback vers localStorage pour les pharmacies');
          // Fallback vers localStorage
          pharmacies = JSON.parse(localStorage.getItem('pharmacies')) || [];
        }
        
        // Si on n'a toujours pas de pharmacies, on laisse le tableau vide
        displayPharmacies(pharmacies);
        return pharmacies;
        
      } catch (error) {
        console.error('‚ùå Erreur chargement pharmacies:', error);
        showNotification('Erreur lors du chargement des pharmacies', 'error');
        return [];
      }
    }

    function displayPharmacies(pharmacies) {
      const pharmacieList = document.getElementById('pharmacieList');
      pharmacieList.innerHTML = '';

      if (pharmacies.length === 0) {
        pharmacieList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <i class="fa-solid fa-store-slash" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
            <p>Aucune pharmacie disponible</p>
            <p style="font-size: 12px; margin-top: 5px;">
              Cr√©ez d'abord des pharmacies dans la section "Pharmacies"
            </p>
          </div>
        `;
        return;
      }

      pharmacies.forEach(pharma => {
        const item = document.createElement('div');
        item.className = 'pharmacie-item';
        item.setAttribute('data-pharmacie-id', pharma._id);
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 5px 0;">
                ${pharma.nom} 
                <span class="online-indicator ${pharma.online ? 'online' : 'offline'}"></span>
                <small style="font-size: 12px; color: ${pharma.online ? '#28a745' : '#dc3545'}">
                  ${pharma.online ? 'En ligne' : 'Hors ligne'}
                </small>
              </h4>
              <p style="margin: 0 0 5px 0; color: #666;">
                <i class="fa-solid fa-location-dot"></i> ${pharma.adresse}
              </p>
              <p style="margin: 0; font-size: 12px; color: #888;">
                <i class="fa-solid fa-phone"></i> ${pharma.telephone}
              </p>
            </div>
            <div style="margin-left: 10px;">
              <button class="btn-small btn-primary select-pharmacie-btn" data-pharmacie-id="${pharma._id}">
                <i class="fa-solid fa-check"></i> S√©lectionner
              </button>
            </div>
          </div>
        `;
        
        // Ajouter l'√©v√©nement de clic sur l'√©l√©ment
        item.addEventListener('click', (e) => {
          // Ne pas d√©clencher si on clique sur le bouton (g√©r√© s√©par√©ment)
          if (!e.target.closest('.select-pharmacie-btn')) {
            selectPharmacie(pharma._id);
          }
        });
        
        // Ajouter l'√©v√©nement sur le bouton
        const selectBtn = item.querySelector('.select-pharmacie-btn');
        selectBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Emp√™cher la propagation du clic
          selectPharmacie(pharma._id);
        });
        
        pharmacieList.appendChild(item);
      });
    }

    // Fonction pour s√©lectionner une pharmacie
    function selectPharmacie(pharmacieId) {
      // D√©s√©lectionner tous les √©l√©ments
      document.querySelectorAll('.pharmacie-item').forEach(el => {
        el.classList.remove('selected');
      });
      
      // S√©lectionner l'√©l√©ment cliqu√©
      const selectedItem = document.querySelector(`[data-pharmacie-id="${pharmacieId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedPharmacieId = pharmacieId;
        document.getElementById('confirmSendBtn').disabled = false;
        
        // Mettre √† jour le texte du bouton de confirmation
        const pharmacie = getPharmacieById(pharmacieId);
        if (pharmacie) {
          document.getElementById('confirmSendBtn').innerHTML = 
            `<i class="fa-solid fa-paper-plane"></i> Envoyer √† ${pharmacie.nom}`;
        }
        
        showNotification(`Pharmacie "${pharmacie.nom}" s√©lectionn√©e`, 'info');
      }
    }

    // Fonction utilitaire pour r√©cup√©rer une pharmacie par ID
    function getPharmacieById(pharmacieId) {
      const pharmacies = JSON.parse(localStorage.getItem('pharmacies')) || [];
      return pharmacies.find(p => p._id === pharmacieId);
    }

    async function sendToPharmacie() {
      if (!selectedPharmacieId) {
        alert("Veuillez s√©lectionner une pharmacie");
        return;
      }

      if (!currentOrdonnanceId) {
        alert("Aucune ordonnance s√©lectionn√©e");
        return;
      }

      try {
        console.log('üì§ Envoi de l\'ordonnance √† la pharmacie...');
        
        const response = await fetch(`/api/ordonnances/${currentOrdonnanceId}/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pharmacieId: selectedPharmacieId
          })
        });

        if (response.ok) {
          const result = await response.json();
          showNotification('‚úÖ Ordonnance envoy√©e √† la pharmacie avec succ√®s!', 'success');
          closePharmacieModal();
        } else {
          throw new Error('Erreur lors de l\'envoi');
        }
      } catch (error) {
        console.error('Erreur API envoi pharmacie:', error);
        // Fallback vers localStorage
        sendToPharmacieLocalStorage();
      }
    }

    // Fallback: Envoyer √† pharmacie dans localStorage
    function sendToPharmacieLocalStorage() {
      const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
      const ordonnanceIndex = ordonnances.findIndex(ord => 
        ord.id === currentOrdonnanceId || ord._id === currentOrdonnanceId
      );

      if (ordonnanceIndex !== -1) {
        // R√©cup√©rer les informations de la pharmacie
        const pharmacie = getPharmacieById(selectedPharmacieId);
        
        // Mettre √† jour le statut de l'ordonnance
        ordonnances[ordonnanceIndex].statut = 'envoyee';
        ordonnances[ordonnanceIndex].pharmacieId = selectedPharmacieId;
        ordonnances[ordonnanceIndex].pharmacieNom = pharmacie ? pharmacie.nom : 'Pharmacie inconnue';
        ordonnances[ordonnanceIndex].dateEnvoi = new Date().toISOString();
        
        localStorage.setItem('ordonnances', JSON.stringify(ordonnances));

        showNotification(`‚úÖ Ordonnance envoy√©e √† ${ordonnances[ordonnanceIndex].pharmacieNom} avec succ√®s!`, 'success');
        closePharmacieModal();
      } else {
        alert('‚ùå Ordonnance non trouv√©e');
      }
    }

    // Gestion des √©v√©nements pour le modal des pharmacies
    document.querySelector('.modal-close').addEventListener('click', closePharmacieModal);
    document.getElementById('cancelSendBtn').addEventListener('click', closePharmacieModal);
    document.getElementById('confirmSendBtn').addEventListener('click', sendToPharmacie);

    document.getElementById("logout").addEventListener("click", function(e) {
      e.preventDefault();
      if(confirm("Voulez-vous vraiment vous d√©connecter ?")) {
        localStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }
    });

    // Affichage initial des patients
    document.addEventListener('DOMContentLoaded', function() {
      loadPatients();
    });
  </script>

</body>
</html>
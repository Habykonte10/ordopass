<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nouvelle Consultation - OrdoPass</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://meet.jit.si/external_api.js"></script>
  
  <!-- Styles pour la facturation -->
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .status.done { color:green; font-weight:bold; }
    .status.pending { color:orange; font-weight:bold; }
    .btn-outline { border:1px solid #2a5298; color:#2a5298; padding:8px 15px; border-radius:5px; cursor:pointer; background:#fff; }
    .btn-primary { background:#2a5298; color:#fff; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; }
    .btn-success { background:#28a745; color:#fff; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#fff; padding:25px; border-radius:8px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; }
    .modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:10px; margin-bottom:15px; box-sizing:border-box; border:1px solid #ddd; border-radius:5px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #ccc; }
    
    .consultation-form { background:white; padding:25px; border-radius:8px; margin:20px 0; }
    .form-section { margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #eee; }
    .form-section h3 { color:#2a5298; margin-bottom:15px; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:20px; }
    .form-group { margin-bottom:15px; }
    .form-label { display:block; margin-bottom:5px; font-weight:bold; color:#555; }
    .form-control { width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; box-sizing:border-box; }
    textarea.form-control { min-height:80px; resize:vertical; }
    .medication-item, .analysis-item, .facture-item { 
      background:#f9f9f9; border:1px solid #eee; border-radius:5px; padding:15px; margin-bottom:10px; 
    }
    .item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .remove-btn { background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; }
    .action-buttons { 
      display: flex; 
      gap: 10px; 
      margin-top: 25px; 
      flex-wrap: wrap; 
      justify-content: space-between; 
      align-items: center; 
    }
    .action-buttons-left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .action-buttons-right {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-success:hover {
      background: #218838;
    }

    .loading { 
      display: none; 
      text-align: center; 
      padding: 20px; 
      color: #2a5298; 
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2a5298;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ticket-info {
      background: #e8f4fd;
      border: 1px solid #2a5298;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .ticket-number {
      font-size: 24px;
      font-weight: bold;
      color: #2a5298;
      text-align: center;
      margin: 10px 0;
    }
    .ticket-warning {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    
    .ordonnance-section {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .ordonnance-preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 25px;
      border-radius: 8px;
      background: white;
      display: none;
    }
    .ordonnance-preview .logo {
      max-width: 120px;
      margin-bottom: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .signature {
      max-width: 150px;
      margin-top: 15px;
    }
    .medecin-name {
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .center-content {
      text-align: center;
    }
    .btn-secondary {
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .points-importants {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
    }
    .points-importants h4 {
      margin-top: 0;
      color: #856404;
    }
    .points-importants textarea {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      box-sizing: border-box;
    }
    
    /* Styles pour la facturation int√©gr√©e */
    .facturation-section {
      background: #f0f8ff;
      border: 1px solid #b8daff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .facture-preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 25px;
      border-radius: 8px;
      background: white;
      display: none;
    }
    .facture-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #2a5298;
      padding-bottom: 15px;
    }
    .facture-logo {
      max-width: 100px;
    }
    .facture-title {
      text-align: center;
      color: #2a5298;
      margin: 10px 0;
    }
    .facture-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .facture-table th, .facture-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .facture-table th {
      background: #f8f9fa;
      font-weight: bold;
    }
    .total-zone {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
    
    .teleconsultation-section {
      background: #f0f0f5;
      border: 1px solid #d6d6e7;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .teleconsultation-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .teleconsultation-option {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .teleconsultation-option:hover {
      border-color: #2a5298;
      transform: translateY(-2px);
    }
    .teleconsultation-option.selected {
      border-color: #2a5298;
      background: #f0f8ff;
    }
    .teleconsultation-icon {
      font-size: 40px;
      color: #2a5298;
      margin-bottom: 10px;
    }
    .video-container {
      background: #000;
      border-radius: 8px;
      margin: 20px 0;
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .video-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    .video-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .video-btn.primary {
      background: #2a5298;
      color: white;
    }
    .video-btn.danger {
      background: #dc3545;
      color: white;
    }
    .video-btn.success {
      background: #28a745;
      color: white;
    }
    .participant-list {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    .participant-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .participant-item:last-child {
      border-bottom: none;
    }
    .invite-link {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .invite-link input {
      flex: 1;
      border: none;
      background: transparent;
    }
    .invite-link button {
      background: #2a5298;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    
    #jitsi-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 9999;
    }
    #jitsi-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #jitsi-meet {
      width: 100%;
      height: 100%;
    }

    /* Styles pour les notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: #28a745;
    }

    .notification.error {
      background: #dc3545;
    }

    .notification.info {
      background: #2a5298;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .btn-warning {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-warning:hover {
      background: #e0a800;
    }
  </style>
</head>
<body class="dashboard-page">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="fa-solid fa-notes-medical"></i> ORDOPASS</div>
    <nav>
      <a href="medecin_dashboard.html"><i class="fa-solid fa-file-medical"></i> Consultations</a>
      <a href="patients.html"><i class="fa-solid fa-users"></i> Patients</a>
      <a href="teleconsultation.html"><i class="fa-solid fa-video"></i> T√©l√©consultation</a>
      <a href="pharmacies.html"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacies</a>
      <a href="medecin_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="parametres.html"><i class="fa-solid fa-gear"></i> Param√®tres</a>
      <a href="medecin_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="medecin_rendezvous.html"><i class="fa-solid fa-calendar-check"></i> Rendez-vous</a>
      <a href="medecin_ordonnance.html"><i class="fa-solid fa-prescription"></i> Ordonnances s√©curis√©es</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> D√©connexion</a>
    </nav>
  </aside>

  <!-- Contenu -->
  <main class="main-area">
    <header class="topbar">
      <h1><i class="fa-solid fa-file-medical"></i> Nouvelle Consultation</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay"></span>
      </div>
    </header>

    <section class="content">
      <div class="card">
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading">
          <div class="spinner"></div>
          <p>Enregistrement en cours...</p>
        </div>

        <form id="consultationForm" class="consultation-form">
          <!-- Informations de base -->
          <div class="form-section">
            <h3>Informations de la consultation</h3>
            
            <!-- Section Ticket -->
            <div class="ticket-info">
              <h4><i class="fa-solid fa-ticket"></i> Gestion du Ticket</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Num√©ro de ticket *</label>
                  <input type="text" class="form-control" id="ticket" required 
                         placeholder="Ex: HOP-2024-001">
                  <div class="ticket-warning" id="ticketWarning"></div>
                  <button type="button" class="btn-outline" onclick="generateHospitalTicket()" style="margin-top: 5px; width: 100%;">
                    <i class="fa-solid fa-gear"></i> G√©n√©rer un ticket hospitalier
                  </button>
                </div>
                <div class="form-group">
                  <label class="form-label">Type de consultation</label>
                  <select class="form-control" id="typeConsultation" onchange="updateTicketPrefix()">
                    <option value="consultation">Consultation Standard</option>
                    <option value="urgence">Urgence</option>
                    <option value="controle">Contr√¥le</option>
                    <option value="specialiste">Sp√©cialiste</option>
                    <option value="teleconsultation">Consultation en ligne</option>
                  </select>
                </div>
              </div>
              <div id="currentTicketDisplay" class="ticket-number"></div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Nom du patient *</label>
                <input type="text" class="form-control" id="nom" required placeholder="Entrez le nom du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Pr√©nom du patient *</label>
                <input type="text" class="form-control" id="prenom" required placeholder="Entrez le pr√©nom du patient">
              </div>
              <div class="form-group">
                <label class="form-label">√Çge *</label>
                <input type="number" class="form-control" id="age" placeholder="√Çge du patient" required>
              </div>
              <div class="form-group">
                <label class="form-label">Sexe *</label>
                <select class="form-control" id="genre" required>
                  <option value="">-- Choisir --</option>
                  <option>F</option>
                  <option>M</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">T√©l√©phone</label>
                <input type="tel" class="form-control" id="telephone" placeholder="Ex: +221 77 123 45 67">
              </div>
              <div class="form-group">
                <label class="form-label">Adresse</label>
                <input type="text" class="form-control" id="adresse" placeholder="Adresse du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Poids (optionnel)</label>
                <input type="text" class="form-control" id="poids" placeholder="Poids du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Image du patient (URL)</label>
                <input type="text" class="form-control" id="image" placeholder="https://example.com/photo.jpg">
              </div>
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-control" id="date" required>
              </div>
              <div class="form-group">
                <label class="form-label">Heure *</label>
                <input type="time" class="form-control" id="heure" required>
              </div>
              <div class="form-group">
                <label class="form-label">Motif de consultation *</label>
                <input type="text" class="form-control" id="motif" required placeholder="Ex: Fi√®vre, Maux de t√™te...">
              </div>
              <div class="form-group">
                <label class="form-label">Statut *</label>
                <select class="form-control" id="statut" required>
                  <option value="En attente">En attente</option>
                  <option value="En cours">En cours</option>
                  <option value="Termin√©">Termin√©</option>
                </select>
              </div>
            </div>
          </div>

          <!-- T√©l√©consultation -->
          <div class="form-section teleconsultation-section" id="teleconsultationSection">
            <h3><i class="fa-solid fa-video"></i> Consultation en ligne</h3>
            
            <div class="teleconsultation-options">
              <div class="teleconsultation-option" onclick="selectTeleconsultationOption('video')">
                <div class="teleconsultation-icon">
                  <i class="fa-solid fa-video"></i>
                </div>
                <h4>Vid√©oconf√©rence</h4>
                <p>Consultation en direct par vid√©o</p>
              </div>
              <div class="teleconsultation-option" onclick="selectTeleconsultationOption('audio')">
                <div class="teleconsultation-icon">
                  <i class="fa-solid fa-phone"></i>
                </div>
                <h4>Appel audio</h4>
                <p>Consultation par t√©l√©phone</p>
              </div>
              <div class="teleconsultation-option" onclick="selectTeleconsultationOption('chat')">
                <div class="teleconsultation-icon">
                  <i class="fa-solid fa-comments"></i>
                </div>
                <h4>Messagerie</h4>
                <p>Consultation par chat</p>
              </div>
            </div>

            <div id="videoConsultationOptions" style="display: none;">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Lien de la consultation</label>
                  <div class="invite-link">
                    <input type="text" id="consultationLink" readonly value="https://ordopass.sn/consultation/">
                    <button type="button" onclick="copyConsultationLink()">
                      <i class="fa-solid fa-copy"></i> Copier
                    </button>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Dur√©e pr√©vue (minutes)</label>
                  <input type="number" class="form-control" id="dureeConsultation" value="30" min="15" max="120">
                </div>
              </div>

              <div class="video-controls">
                <button type="button" class="video-btn primary" onclick="startJitsiMeeting()">
                  <i class="fa-solid fa-play"></i> D√©marrer la consultation vid√©o
                </button>
                <button type="button" class="video-btn success" onclick="generateConsultationLink()">
                  <i class="fa-solid fa-link"></i> G√©n√©rer le lien
                </button>
                <button type="button" class="video-btn danger" onclick="resetVideo()">
                  <i class="fa-solid fa-rotate-left"></i> R√©initialiser
                </button>
              </div>

              <div class="participant-list">
                <h4>Participants</h4>
                <div class="participant-item">
                  <img src="https://i.pravatar.cc/40" class="avatar" alt="M√©decin">
                  <div>
                    <strong>Dr. <span id="medecinName"></span></strong>
                    <p style="margin: 0; color: #666;">M√©decin</p>
                  </div>
                </div>
                <div class="participant-item">
                  <img src="https://i.pravatar.cc/40?img=5" class="avatar" alt="Patient">
                  <div>
                    <strong id="patientName"></strong>
                    <p style="margin: 0; color: #666;">Patient</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sympt√¥mes -->
          <div class="form-section">
            <h3>Sympt√¥mes</h3>
            <div class="form-group">
              <label class="form-label">Description des sympt√¥mes *</label>
              <textarea class="form-control" id="symptomes" placeholder="D√©crire les sympt√¥mes du patient..." required></textarea>
            </div>
          </div>

          <!-- Analyses √† faire -->
          <div class="form-section">
            <h3>Analyses m√©dicales</h3>
            <div class="form-group">
              <label class="form-label">Analyses prescrites</label>
              <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" class="form-control" id="newAnalysis" placeholder="Nom de l'analyse" style="flex:1;">
                <button type="button" class="btn-outline" onclick="addAnalysis()">
                  <i class="fa-solid fa-plus"></i> Ajouter
                </button>
              </div>
              <div id="analysesList"></div>
            </div>
          </div>

          <!-- Examens physiques -->
          <div class="form-section">
            <h3>Examens physiques</h3>
            <div class="form-group">
              <label class="form-label">R√©sultats des examens</label>
              <textarea class="form-control" id="examens" placeholder="R√©sultats des examens physiques..."></textarea>
            </div>
          </div>

          <!-- Ordonnances -->
          <div class="form-section ordonnance-section">
            <h3><i class="fa-solid fa-prescription"></i> Ordonnance m√©dicale</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Nom du m√©decin *</label>
                <input type="text" class="form-control" id="nomMedecin" placeholder="Dr ..." required>
              </div>
              <div class="form-group">
                <label class="form-label">M√©dicament *</label>
                <input type="text" class="form-control" id="medicament" placeholder="Nom du m√©dicament">
              </div>
              <div class="form-group">
                <label class="form-label">Dosage *</label>
                <input type="text" class="form-control" id="dosage" placeholder="Ex: 500mg">
              </div>
              <div class="form-group">
                <label class="form-label">Posologie *</label>
                <input type="text" class="form-control" id="posologie" placeholder="Ex: 1 comprim√© matin et soir">
              </div>
              <div class="form-group">
                <label class="form-label">Dur√©e *</label>
                <input type="text" class="form-control" id="duree" placeholder="Ex: 5 jours">
              </div>
            </div>
            <button type="button" class="btn-outline" onclick="addMedication()">
              <i class="fa-solid fa-plus"></i> Ajouter le m√©dicament
            </button>
            <div id="medicationsList" style="margin-top:15px;"></div>
            
            <!-- Points importants pour l'ordonnance -->
            <div class="points-importants">
              <h4><i class="fa-solid fa-exclamation-circle"></i> Points importants pour l'ordonnance</h4>
              <textarea class="form-control" id="pointsImportants" placeholder="Indications sp√©ciales, contre-indications, conseils particuliers..."></textarea>
            </div>
            
            <div style="margin-top: 20px;">
              <button type="button" class="btn-secondary" onclick="generateOrdonnancePreview()">
                <i class="fa-solid fa-eye"></i> Pr√©visualiser l'ordonnance
              </button>
              <button type="button" class="btn-primary" onclick="saveOrdonnance()">
                <i class="fa-solid fa-save"></i> Sauvegarder l'ordonnance
              </button>
              <button type="button" class="btn-success" id="ordonnancePdfBtn" onclick="generateOrdonnancePDF()" disabled>
                <i class="fa-solid fa-file-pdf"></i> T√©l√©charger PDF
              </button>
              <button type="button" class="btn-warning" onclick="openPharmacieModal()" id="sendOrdonnanceBtn" style="display: none;">
                <i class="fa-solid fa-paper-plane"></i> Envoyer √† pharmacie
              </button>
            </div>
            
            <!-- Aper√ßu de l'ordonnance -->
            <div class="ordonnance-preview" id="ordonnancePreview">
              <img id="logoImg" alt="Logo OrdoPass" class="logo">
              <h2 style="text-align: center;">Ordonnance m√©dicale</h2>
              <p class="medecin-name">M√©decin : <span id="pMedecin"></span></p>

              <div class="center-content">
                <p><b>Patient :</b> <span id="pNom"></span></p>
                <p><b>√Çge :</b> <span id="pAge"></span> ‚Ä¢ <b>Sexe :</b> <span id="pGenre"></span></p>
                <p><b>Adresse :</b> <span id="pAdresse"></span></p>
                <p><b>Poids :</b> <span id="pPoids"></span></p>
                <p><b>Date :</b> <span id="pDate"></span></p>
                <p><b>Code :</b> <span id="pCode"></span></p>
                <p><b>Prescription :</b><br><span id="pMedic" style="white-space: pre-line;"></span></p>
                
                <!-- Affichage des points importants -->
                <div id="pPointsImportants" style="text-align: left; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                  <strong>Points importants :</strong><br>
                  <span id="pPointsText"></span>
                </div>
              </div>

              <div id="qrcode" style="text-align: center; margin: 20px 0;"></div>
              <img id="signImg" alt="Signature du m√©decin" class="signature" style="display: block; margin: 0 auto;">
            </div>
          </div>

          <!-- Facturation int√©gr√©e -->
          <div class="form-section facturation-section">
            <h3><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Description *</label>
                <input type="text" class="form-control" id="factureDescription" placeholder="Ex: Consultation m√©dicale" required>
              </div>
              <div class="form-group">
                <label class="form-label">Montant (FCFA) *</label>
                <input type="number" class="form-control" id="factureMontant" placeholder="Montant de la consultation" required>
              </div>
              <div class="form-group">
                <label class="form-label">M√©thode de paiement</label>
                <select class="form-control" id="facturePaiement">
                  <option value="Esp√®ces">Esp√®ces</option>
                  <option value="Carte bancaire">Carte bancaire</option>
                  <option value="Wave">Wave</option>
                  <option value="Orange Money">Orange Money</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Facture pay√©e ?</label>
                <select class="form-control" id="facturePaye">
                  <option value="Non">Non</option>
                  <option value="Oui">Oui</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Type de document</label>
                <select class="form-control" id="typeFacture">
                  <option value="FACTURE">Facture</option>
                  <option value="FACTURE PROFORMA">Proforma</option>
                </select>
              </div>
            </div>
            
            <div style="margin-top: 20px;">
              <button type="button" class="btn-secondary" onclick="generateFacturePreview()">
                <i class="fa-solid fa-eye"></i> Pr√©visualiser la facture
              </button>
              <button type="button" class="btn-primary" onclick="saveFactureFromConsultation()">
                <i class="fa-solid fa-save"></i> Sauvegarder la facture
              </button>
              <button type="button" class="btn-success" id="facturePdfBtn" onclick="generateFacturePDF()" disabled>
                <i class="fa-solid fa-file-pdf"></i> T√©l√©charger PDF
              </button>
            </div>
            
            <!-- Aper√ßu de la facture -->
            <div class="facture-preview" id="facturePreview">
              <div class="facture-header">
                <div class="facture-logo">
                  <img src="https://via.placeholder.com/100x50/2a5298/ffffff?text=ORDOPASS" alt="Logo OrdoPass" style="width:100px;">
                </div>
                <div style="text-align: center;">
                  <h3 style="margin:0; color:#2a5298;">CLINIQUE ORDOPASS</h3>
                  <small>www.ordopass.sn</small>
                </div>
              </div>
              
              <h2 class="facture-title" id="factureTitle">FACTURE</h2>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                  <p><b>N¬∞ Patient :</b> <span id="facturePatientId"></span></p>
                  <p><b>Date :</b> <span id="factureDate"></span></p>
                </div>
                <div>
                  <p><b>Ticket :</b> <span id="factureTicket"></span></p>
                  <p><b>M√©decin :</b> <span id="factureMedecin"></span></p>
                </div>
              </div>
              
              <hr>
              
              <div style="margin-bottom: 20px;">
                <p><b>Patient :</b> <span id="facturePatient"></span></p>
                <p><b>√Çge :</b> <span id="factureAge"></span> ans</p>
                <p><b>Adresse :</b> <span id="factureAdresse"></span></p>
              </div>
              
              <table class="facture-table">
                <thead>
                  <tr>
                    <th>D√©signation</th>
                    <th>Qt√©</th>
                    <th>PU (FCFA)</th>
                    <th>Montant (FCFA)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td id="factureDescriptionPreview"></td>
                    <td>1</td>
                    <td id="facturePrixUnitaire"></td>
                    <td id="factureTotal"></td>
                  </tr>
                </tbody>
              </table>
              
              <div class="total-zone">
                <p><b>TOTAL G√âN√âRAL :</b> <span id="factureMontantTotal"></span> FCFA</p>
                <p><b>M√©thode de paiement :</b> <span id="facturePaiementPreview"></span></p>
                <p><b>Facture pay√©e :</b> <span id="facturePayePreview"></span></p>
              </div>
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="action-buttons">
            <div class="action-buttons-left">
              <button type="button" class="btn-success" onclick="savePatientAndConsultation()">
                <i class="fa-solid fa-user-plus"></i> Ajouter patient et consultation
              </button>
              <button type="button" class="btn-outline" onclick="goBack()">
                <i class="fa-solid fa-arrow-left"></i> Retour
              </button>
            </div>
            <div class="action-buttons-right">
              <button type="button" class="btn-danger" onclick="cancelForm()">
                <i class="fa-solid fa-times"></i> Annuler
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Jitsi Container -->
  <div id="jitsi-container">
    <button id="jitsi-close" onclick="resetVideo()">√ó</button>
    <div id="jitsi-meet"></div>
  </div>

  <!-- Pharmacie Modal -->
  <div id="pharmacieModal" class="modal">
    <div class="modal-content">
      <h3><i class="fa-solid fa-paper-plane"></i> Envoyer l'ordonnance √† une pharmacie</h3>
      <p>S√©lectionnez une pharmacie pour envoyer l'ordonnance :</p>
      <div id="pharmaciesList"></div>
      <div style="margin-top: 20px;">
        <button type="button" class="btn-success" onclick="sendOrdonnanceToPharmacie()">Envoyer</button>
        <button type="button" class="btn-outline" onclick="closePharmacieModal()">Annuler</button>
      </div>
    </div>
  </div>

  <script>
/* ===============================
   SESSION
================================ */
const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.role !== "medecin") {
  alert("‚ö†Ô∏è Acc√®s refus√©");
  location.href = "medecin_login.html";
}

document.getElementById("usernameDisplay").textContent = user.username || "M√©decin";

// Variables globales pour les fonctionnalit√©s
let medicationsList = [];
let analysesList = [];

/* ===============================
   INITIALISATION
================================ */
document.addEventListener('DOMContentLoaded', function() {
  // Initialiser la date et heure
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  document.getElementById('heure').value = `${hours}:${minutes}`;
  
  // Remplir le nom du m√©decin
  if (user.username) {
    document.getElementById('nomMedecin').value = user.username;
  }
  
  // G√©n√©rer un ticket automatiquement au chargement
  generateHospitalTicket();
  
  // √âcouter les changements sur le champ ticket
  document.getElementById('ticket').addEventListener('blur', checkTicketAvailability);
  document.getElementById('ticket').addEventListener('input', function() {
    const ticket = this.value;
    if (ticket) {
      document.getElementById('currentTicketDisplay').innerHTML = 
        `<i class="fa-solid fa-ticket"></i> Ticket actuel : <strong>${ticket}</strong>`;
    }
  });
});

/* ===============================
   FONCTIONS ESSENTIELLES POUR LE FORMULAIRE
================================ */

// Fonction pour ajouter un m√©dicament
function addMedication() {
  const medicament = document.getElementById('medicament').value;
  const dosage = document.getElementById('dosage').value;
  const posologie = document.getElementById('posologie').value;
  const duree = document.getElementById('duree').value;
  
  if (medicament && dosage && posologie && duree) {
    medicationsList.push({
      medicament,
      dosage,
      posologie,
      duree
    });
    
    // Afficher dans la liste
    const listDiv = document.getElementById('medicationsList');
    const medDiv = document.createElement('div');
    medDiv.className = 'medication-item';
    medDiv.innerHTML = `
      <div class="item-header">
        <strong>${medicament}</strong>
        <button type="button" class="remove-btn" onclick="removeMedication(${medicationsList.length-1})">
          <i class="fa-solid fa-trash"></i> Supprimer
        </button>
      </div>
      <p><strong>Dosage :</strong> ${dosage}</p>
      <p><strong>Posologie :</strong> ${posologie}</p>
      <p><strong>Dur√©e :</strong> ${duree}</p>
    `;
    listDiv.appendChild(medDiv);
    
    // R√©initialiser les champs
    document.getElementById('medicament').value = '';
    document.getElementById('dosage').value = '';
    document.getElementById('posologie').value = '';
    document.getElementById('duree').value = '';
  }
}

function removeMedication(index) {
  medicationsList.splice(index, 1);
  document.getElementById('medicationsList').innerHTML = '';
  medicationsList.forEach((med, i) => {
    const listDiv = document.getElementById('medicationsList');
    const medDiv = document.createElement('div');
    medDiv.className = 'medication-item';
    medDiv.innerHTML = `
      <div class="item-header">
        <strong>${med.medicament}</strong>
        <button type="button" class="remove-btn" onclick="removeMedication(${i})">
          <i class="fa-solid fa-trash"></i> Supprimer
        </button>
      </div>
      <p><strong>Dosage :</strong> ${med.dosage}</p>
      <p><strong>Posologie :</strong> ${med.posologie}</p>
      <p><strong>Dur√©e :</strong> ${med.duree}</p>
    `;
    listDiv.appendChild(medDiv);
  });
}

// Fonction pour ajouter une analyse
function addAnalysis() {
  const analysisInput = document.getElementById('newAnalysis');
  const analysisName = analysisInput.value.trim();
  
  if (analysisName) {
    analysesList.push(analysisName);
    
    // Afficher dans la liste
    const listDiv = document.getElementById('analysesList');
    const analysisDiv = document.createElement('div');
    analysisDiv.className = 'analysis-item';
    analysisDiv.innerHTML = `
      <div class="item-header">
        <span>${analysisName}</span>
        <button type="button" class="remove-btn" onclick="removeAnalysis(${analysesList.length-1})">
          <i class="fa-solid fa-trash"></i> Supprimer
        </button>
      </div>
    `;
    listDiv.appendChild(analysisDiv);
    
    // R√©initialiser le champ
    analysisInput.value = '';
  }
}

function removeAnalysis(index) {
  analysesList.splice(index, 1);
  document.getElementById('analysesList').innerHTML = '';
  analysesList.forEach((analysis, i) => {
    const listDiv = document.getElementById('analysesList');
    const analysisDiv = document.createElement('div');
    analysisDiv.className = 'analysis-item';
    analysisDiv.innerHTML = `
      <div class="item-header">
        <span>${analysis}</span>
        <button type="button" class="remove-btn" onclick="removeAnalysis(${i})">
          <i class="fa-solid fa-trash"></i> Supprimer
        </button>
      </div>
    `;
    listDiv.appendChild(analysisDiv);
  });
}

/* ===============================
   FONCTIONS POUR TICKET
================================ */
function generateHospitalTicket() {
  const type = document.getElementById('typeConsultation').value;
  const now = new Date();
  const year = now.getFullYear();
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  const day = now.getDate().toString().padStart(2, '0');
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  
  let prefix = 'CONS';
  switch(type) {
    case 'urgence': prefix = 'URG'; break;
    case 'controle': prefix = 'CTRL'; break;
    case 'specialiste': prefix = 'SPEC'; break;
    case 'teleconsultation': prefix = 'TELEC'; break;
  }
  
  const ticket = `${prefix}-${year}${month}${day}-${random}`;
  document.getElementById('ticket').value = ticket;
  
  // Mettre √† jour l'affichage du ticket actuel
  document.getElementById('currentTicketDisplay').innerHTML = 
    `<i class="fa-solid fa-ticket"></i> Ticket actuel : <strong>${ticket}</strong>`;
  
  // V√©rifier la disponibilit√©
  checkTicketAvailability();
  
  return ticket;
}

function checkTicketAvailability() {
  const ticket = document.getElementById('ticket').value;
  const warning = document.getElementById('ticketWarning');
  
  if (!ticket || ticket.trim() === '') {
    warning.textContent = '‚ö†Ô∏è Veuillez g√©n√©rer ou saisir un ticket';
    warning.style.color = '#dc3545';
    return false;
  }
  
  // V√©rifier dans localStorage si le ticket existe d√©j√†
  const consultations = JSON.parse(localStorage.getItem('consultations')) || [];
  const existing = consultations.find(c => c.ticket === ticket);
  
  if (existing) {
    warning.textContent = '‚ö†Ô∏è Ce ticket est d√©j√† utilis√©';
    warning.style.color = '#dc3545';
    return false;
  } else {
    warning.textContent = '‚úì Ticket disponible';
    warning.style.color = '#28a745';
    return true;
  }
}

function updateTicketPrefix() {
  const currentTicket = document.getElementById('ticket').value;
  
  // Si le ticket est vide ou est un ticket g√©n√©r√© pr√©c√©demment
  if (!currentTicket || currentTicket.startsWith('CONS-') || currentTicket.startsWith('URG-') || 
      currentTicket.startsWith('CTRL-') || currentTicket.startsWith('SPEC-') || currentTicket.startsWith('TELEC-')) {
    generateHospitalTicket();
  } else {
    // Si c'est un ticket personnalis√©, juste v√©rifier la disponibilit√©
    checkTicketAvailability();
  }
}

/* ===============================
   FONCTION POUR ENREGISTRER PATIENT ET CONSULTATION
================================ */
function savePatientAndConsultation() {
  // V√©rifier la disponibilit√© du ticket
  if (!checkTicketAvailability()) {
    showNotification('Veuillez utiliser un ticket disponible', 'error');
    return;
  }
  
  // Validation des champs obligatoires
  const requiredFields = ['nom', 'prenom', 'age', 'genre', 'date', 'heure', 'motif', 'symptomes', 'statut', 'ticket'];
  for (const fieldId of requiredFields) {
    const field = document.getElementById(fieldId);
    if (!field.value.trim()) {
      showNotification(`Le champ "${fieldId}" est obligatoire`, 'error');
      field.focus();
      return;
    }
  }
  
  // Afficher l'indicateur de chargement
  document.getElementById('loadingIndicator').style.display = 'block';
  
  // 1. Enregistrer le patient
  const patient = {
    id: Date.now(),
    nom: document.getElementById('nom').value,
    prenom: document.getElementById('prenom').value,
    age: document.getElementById('age').value,
    genre: document.getElementById('genre').value,
    telephone: document.getElementById('telephone').value,
    adresse: document.getElementById('adresse').value,
    poids: document.getElementById('poids').value,
    image: document.getElementById('image').value,
    createdAt: new Date().toISOString(),

    // üëá AJOUT POUR PATIENTS : compatibilit√© avec patients.html
    name: document.getElementById('prenom').value + ' ' + document.getElementById('nom').value,
    phone: document.getElementById('telephone').value,
    address: document.getElementById('adresse').value,
    added: new Date().toLocaleDateString('fr-FR')  // format JJ/MM/AAAA
  };
  
  let patients = JSON.parse(localStorage.getItem('patients')) || [];
  patients.push(patient);
  localStorage.setItem('patients', JSON.stringify(patients));
  
  // 2. Enregistrer la consultation (avec patientName et image)
  const consultation = {
    id: Date.now(),
    patientId: patient.id,
    ticket: document.getElementById('ticket').value,
    typeConsultation: document.getElementById('typeConsultation').value,
    date: document.getElementById('date').value,
    heure: document.getElementById('heure').value,
    motif: document.getElementById('motif').value,
    symptomes: document.getElementById('symptomes').value,
    analyses: analysesList,
    examens: document.getElementById('examens').value,
    statut: document.getElementById('statut').value,
    medecin: user.username,
    ordonnance: medicationsList.length > 0 ? medicationsList : null,
    facture: {
      description: document.getElementById('factureDescription').value,
      montant: document.getElementById('factureMontant').value
    },
    createdAt: new Date().toISOString(),
    // üëá AJOUTS N√âCESSAIRES POUR L‚ÄôAFFICHAGE DANS LE DASHBOARD
    patientName: patient.prenom + ' ' + patient.nom,
    image: patient.image
  };
  
  let consultations = JSON.parse(localStorage.getItem('consultations')) || [];
  consultations.push(consultation);
  localStorage.setItem('consultations', JSON.stringify(consultations));
  
  // Cacher l'indicateur de chargement
  document.getElementById('loadingIndicator').style.display = 'none';
  
  showNotification('Patient et consultation enregistr√©s avec succ√®s !', 'success');
  
  // Redirection apr√®s 2 secondes
  setTimeout(() => {
    window.location.href = 'medecin_dashboard.html';
  }, 2000);
}

/* ===============================
   FONCTIONS POUR ORDONNANCE
================================ */
function generateOrdonnancePreview() {
  // Remplir les donn√©es de l'aper√ßu
  document.getElementById('pMedecin').textContent = document.getElementById('nomMedecin').value;
  document.getElementById('pNom').textContent = 
    document.getElementById('prenom').value + ' ' + document.getElementById('nom').value;
  document.getElementById('pAge').textContent = document.getElementById('age').value;
  document.getElementById('pGenre').textContent = document.getElementById('genre').value;
  document.getElementById('pAdresse').textContent = document.getElementById('adresse').value || 'Non sp√©cifi√©';
  document.getElementById('pPoids').textContent = document.getElementById('poids').value || 'Non sp√©cifi√©';
  document.getElementById('pDate').textContent = document.getElementById('date').value;
  document.getElementById('pCode').textContent = document.getElementById('ticket').value;
  
  // G√©n√©rer la liste des m√©dicaments
  let medsText = '';
  if (medicationsList.length > 0) {
    medicationsList.forEach(med => {
      medsText += `‚Ä¢ ${med.medicament} (${med.dosage})\n`;
      medsText += `  Posologie : ${med.posologie}\n`;
      medsText += `  Dur√©e : ${med.duree}\n\n`;
    });
  } else {
    medsText = document.getElementById('medicament').value + ' ' + 
               document.getElementById('dosage').value + ' - ' +
               document.getElementById('posologie').value + ' - ' +
               document.getElementById('duree').value;
  }
  document.getElementById('pMedic').textContent = medsText;
  
  // Points importants
  document.getElementById('pPointsText').textContent = document.getElementById('pointsImportants').value || 'Aucun';
  
  // Afficher l'aper√ßu
  document.getElementById('ordonnancePreview').style.display = 'block';
}

function saveOrdonnance() {
  // Cr√©er l'objet ordonnance
  const ordonnance = {
    id: Date.now(),
    patient: document.getElementById('prenom').value + ' ' + document.getElementById('nom').value,
    date: new Date().toLocaleDateString(),
    medecin: document.getElementById('nomMedecin').value,
    medicaments: medicationsList,
    pointsImportants: document.getElementById('pointsImportants').value,
    consultationId: document.getElementById('ticket').value
  };
  
  // Sauvegarder dans localStorage
  let ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  ordonnances.push(ordonnance);
  localStorage.setItem('ordonnances', JSON.stringify(ordonnances));
  
  // Activer le bouton PDF
  document.getElementById('ordonnancePdfBtn').disabled = false;
  document.getElementById('sendOrdonnanceBtn').style.display = 'inline-flex';
  
  // Afficher notification
  showNotification('Ordonnance sauvegard√©e avec succ√®s !', 'success');
}

function generateOrdonnancePDF() {
  // Cette fonction g√©n√®re le PDF de l'ordonnance
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Contenu du PDF
  doc.text('Ordonnance M√©dicale', 20, 20);
  doc.text('M√©decin: ' + document.getElementById('nomMedecin').value, 20, 30);
  doc.text('Patient: ' + document.getElementById('prenom').value + ' ' + document.getElementById('nom').value, 20, 40);
  doc.text('Date: ' + new Date().toLocaleDateString(), 20, 50);
  
  let y = 70;
  doc.text('Prescription:', 20, y);
  y += 10;
  
  if (medicationsList.length > 0) {
    medicationsList.forEach(med => {
      doc.text(`‚Ä¢ ${med.medicament} (${med.dosage})`, 25, y);
      y += 10;
      doc.text(`  Posologie: ${med.posologie}`, 30, y);
      y += 10;
      doc.text(`  Dur√©e: ${med.duree}`, 30, y);
      y += 10;
    });
  }
  
  doc.save(`ordonnance-${document.getElementById('ticket').value}.pdf`);
}

function openPharmacieModal() {
  // Charger la liste des pharmacies
  const pharmacies = JSON.parse(localStorage.getItem('pharmacies')) || [];
  const pharmacieListDiv = document.getElementById('pharmaciesList');
  pharmacieListDiv.innerHTML = '';
  
  if (pharmacies.length === 0) {
    pharmacieListDiv.innerHTML = '<p>Aucune pharmacie enregistr√©e.</p>';
  } else {
    pharmacies.forEach(pharmacie => {
      const div = document.createElement('div');
      div.className = 'pharmacie-item';
      div.style.padding = '10px';
      div.style.border = '1px solid #ddd';
      div.style.marginBottom = '10px';
      div.style.borderRadius = '5px';
      div.innerHTML = `
        <input type="radio" name="pharmacie" value="${pharmacie.id}" id="pharmacie_${pharmacie.id}">
        <label for="pharmacie_${pharmacie.id}">
          <strong>${pharmacie.nom}</strong><br>
          <small>${pharmacie.adresse}</small>
        </label>
      `;
      pharmacieListDiv.appendChild(div);
    });
  }
  
  document.getElementById('pharmacieModal').style.display = 'flex';
}

function closePharmacieModal() {
  document.getElementById('pharmacieModal').style.display = 'none';
}

function sendOrdonnanceToPharmacie() {
  const selected = document.querySelector('input[name="pharmacie"]:checked');
  if (!selected) {
    showNotification('Veuillez s√©lectionner une pharmacie', 'error');
    return;
  }
  
  // R√©cup√©rer l'ordonnance
  const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
  const derniereOrdonnance = ordonnances[ordonnances.length - 1];
  
  if (derniereOrdonnance) {
    // Envoyer l'ordonnance √† la pharmacie (simulation)
    showNotification(`Ordonnance envoy√©e √† la pharmacie ID: ${selected.value}`, 'success');
    closePharmacieModal();
  } else {
    showNotification('Aucune ordonnance √† envoyer', 'error');
  }
}

/* ===============================
   FONCTIONS POUR FACTURE
================================ */
function generateFacturePreview() {
  // Remplir les donn√©es de l'aper√ßu
  document.getElementById('factureTitle').textContent = document.getElementById('typeFacture').value;
  document.getElementById('facturePatient').textContent = 
    document.getElementById('prenom').value + ' ' + document.getElementById('nom').value;
  document.getElementById('factureAge').textContent = document.getElementById('age').value;
  document.getElementById('factureAdresse').textContent = document.getElementById('adresse').value || 'Non sp√©cifi√©';
  document.getElementById('factureDate').textContent = document.getElementById('date').value;
  document.getElementById('factureTicket').textContent = document.getElementById('ticket').value;
  document.getElementById('factureMedecin').textContent = document.getElementById('nomMedecin').value;
  
  document.getElementById('factureDescriptionPreview').textContent = document.getElementById('factureDescription').value;
  const montant = document.getElementById('factureMontant').value;
  document.getElementById('facturePrixUnitaire').textContent = montant;
  document.getElementById('factureTotal').textContent = montant;
  document.getElementById('factureMontantTotal').textContent = montant;
  
  document.getElementById('facturePaiementPreview').textContent = document.getElementById('facturePaiement').value;
  document.getElementById('facturePayePreview').textContent = document.getElementById('facturePaye').value;
  
  // Afficher l'aper√ßu
  document.getElementById('facturePreview').style.display = 'block';
}

function saveFactureFromConsultation() {
  // Cr√©er l'objet facture
  const facture = {
    id: Date.now(),
    patient: document.getElementById('prenom').value + ' ' + document.getElementById('nom').value,
    date: new Date().toLocaleDateString(),
    description: document.getElementById('factureDescription').value,
    montant: parseFloat(document.getElementById('factureMontant').value),
    paiement: document.getElementById('facturePaiement').value,
    paye: document.getElementById('facturePaye').value,
    type: document.getElementById('typeFacture').value,
    consultationId: document.getElementById('ticket').value
  };
  
  // Sauvegarder dans localStorage
  let factures = JSON.parse(localStorage.getItem('factures')) || [];
  factures.push(facture);
  localStorage.setItem('factures', JSON.stringify(factures));
  
  // Activer le bouton PDF
  document.getElementById('facturePdfBtn').disabled = false;
  
  // Afficher notification
  showNotification('Facture enregistr√©e avec succ√®s !', 'success');
}

function generateFacturePDF() {
  // Cette fonction g√©n√®re le PDF de la facture
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Contenu du PDF
  doc.text('Facture', 20, 20);
  doc.text('M√©decin: ' + document.getElementById('nomMedecin').value, 20, 30);
  doc.text('Patient: ' + document.getElementById('prenom').value + ' ' + document.getElementById('nom').value, 20, 40);
  doc.text('Date: ' + new Date().toLocaleDateString(), 20, 50);
  doc.text('Description: ' + document.getElementById('factureDescription').value, 20, 60);
  doc.text('Montant: ' + document.getElementById('factureMontant').value + ' FCFA', 20, 70);
  doc.text('M√©thode de paiement: ' + document.getElementById('facturePaiement').value, 20, 80);
  doc.text('Statut: ' + document.getElementById('facturePaye').value, 20, 90);
  
  doc.save(`facture-${document.getElementById('ticket').value}.pdf`);
}

/* ===============================
   FONCTIONS POUR T√âL√âCONSULTATION
================================ */
function selectTeleconsultationOption(type) {
  const options = document.querySelectorAll('.teleconsultation-option');
  options.forEach(opt => opt.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  
  const videoOptions = document.getElementById('videoConsultationOptions');
  if (type === 'video') {
    videoOptions.style.display = 'block';
    document.getElementById('patientName').textContent = 
      document.getElementById('prenom').value + ' ' + document.getElementById('nom').value;
    document.getElementById('medecinName').textContent = user.username || 'M√©decin';
  } else {
    videoOptions.style.display = 'none';
  }
}

function generateConsultationLink() {
  const patientId = document.getElementById('prenom').value.toLowerCase() + 
                    document.getElementById('nom').value.toLowerCase().replace(/\s/g, '');
  const link = `https://ordopass.sn/consultation/${patientId}-${Date.now()}`;
  document.getElementById('consultationLink').value = link;
  showNotification('Lien de consultation g√©n√©r√© !', 'success');
}

function copyConsultationLink() {
  const linkInput = document.getElementById('consultationLink');
  linkInput.select();
  document.execCommand('copy');
  showNotification('Lien copi√© dans le presse-papier !', 'success');
}

let jitsiApi = null;

function startJitsiMeeting() {
  const roomName = `ordopass-${Date.now()}`;
  const domain = 'meet.jit.si';
  const options = {
    roomName: roomName,
    width: '100%',
    height: '100%',
    parentNode: document.querySelector('#jitsi-meet'),
    userInfo: {
      displayName: user.username || 'M√©decin'
    }
  };
  
  const jitsiContainer = document.getElementById('jitsi-container');
  jitsiContainer.style.display = 'block';
  
  jitsiApi = new JitsiMeetExternalAPI(domain, options);
  
  document.getElementById('consultationLink').value = `https://${domain}/${roomName}`;
}

function resetVideo() {
  if (jitsiApi) {
    jitsiApi.dispose();
    jitsiApi = null;
  }
  document.getElementById('jitsi-container').style.display = 'none';
  document.getElementById('consultationLink').value = 'https://ordopass.sn/consultation/';
}

/* ===============================
   FONCTIONS UTILITAIRES
================================ */
function showNotification(message, type) {
  // Cr√©er la notification
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  // Supprimer apr√®s 3 secondes
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

function goBack() {
  if (confirm('Voulez-vous vraiment quitter ? Les donn√©es non enregistr√©es seront perdues.')) {
    window.history.back();
  }
}

function cancelForm() {
  if (confirm('√ätes-vous s√ªr de vouloir annuler cette consultation ?')) {
    window.location.href = 'medecin_dashboard.html';
  }
}

/* ===============================
   D√âCONNEXION
================================ */
document.getElementById('logout').addEventListener('click', function(e) {
  e.preventDefault();
  localStorage.removeItem('user');
  window.location.href = 'medecin_login.html';
});
</script>

</body>
</html>
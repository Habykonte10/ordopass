
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nouvelle Consultation - OrdoPass</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://meet.jit.si/external_api.js"></script>
  
  <!-- Styles pour la facturation -->
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .status.done { color:green; font-weight:bold; }
    .status.pending { color:orange; font-weight:bold; }
    .btn-outline { border:1px solid #2a5298; color:#2a5298; padding:8px 15px; border-radius:5px; cursor:pointer; background:#fff; }
    .btn-primary { background:#2a5298; color:#fff; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; }
    .btn-success { background:#28a745; color:#fff; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#fff; padding:25px; border-radius:8px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; }
    .modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:10px; margin-bottom:15px; box-sizing:border-box; border:1px solid #ddd; border-radius:5px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #ccc; }
    
    .consultation-form { background:white; padding:25px; border-radius:8px; margin:20px 0; }
    .form-section { margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #eee; }
    .form-section h3 { color:#2a5298; margin-bottom:15px; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:20px; }
    .form-group { margin-bottom:15px; }
    .form-label { display:block; margin-bottom:5px; font-weight:bold; color:#555; }
    .form-control { width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; box-sizing:border-box; }
    textarea.form-control { min-height:80px; resize:vertical; }
    .medication-item, .analysis-item, .facture-item { 
      background:#f9f9f9; border:1px solid #eee; border-radius:5px; padding:15px; margin-bottom:10px; 
    }
    .item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .remove-btn { background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; }
    .action-buttons { 
      display: flex; 
      gap: 10px; 
      margin-top: 25px; 
      flex-wrap: wrap; 
      justify-content: space-between; 
      align-items: center; 
    }
    .action-buttons-left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .action-buttons-right {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-success:hover {
      background: #218838;
    }

    .loading { 
      display: none; 
      text-align: center; 
      padding: 20px; 
      color: #2a5298; 
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2a5298;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ticket-info {
      background: #e8f4fd;
      border: 1px solid #2a5298;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .ticket-number {
      font-size: 24px;
      font-weight: bold;
      color: #2a5298;
      text-align: center;
      margin: 10px 0;
    }
    .ticket-warning {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    
    .ordonnance-section {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .ordonnance-preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 25px;
      border-radius: 8px;
      background: white;
      display: none;
    }
    .ordonnance-preview .logo {
      max-width: 120px;
      margin-bottom: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .signature {
      max-width: 150px;
      margin-top: 15px;
    }
    .medecin-name {
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .center-content {
      text-align: center;
    }
    .btn-secondary {
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .points-importants {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
    }
    .points-importants h4 {
      margin-top: 0;
      color: #856404;
    }
    .points-importants textarea {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      box-sizing: border-box;
    }
    
    /* Styles pour la facturation intégrée */
    .facturation-section {
      background: #f0f8ff;
      border: 1px solid #b8daff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .facture-preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 25px;
      border-radius: 8px;
      background: white;
      display: none;
    }
    .facture-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #2a5298;
      padding-bottom: 15px;
    }
    .facture-logo {
      max-width: 100px;
    }
    .facture-title {
      text-align: center;
      color: #2a5298;
      margin: 10px 0;
    }
    .facture-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .facture-table th, .facture-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .facture-table th {
      background: #f8f9fa;
      font-weight: bold;
    }
    .total-zone {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
    
    .teleconsultation-section {
      background: #f0f0f5;
      border: 1px solid #d6d6e7;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .teleconsultation-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .teleconsultation-option {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .teleconsultation-option:hover {
      border-color: #2a5298;
      transform: translateY(-2px);
    }
    .teleconsultation-option.selected {
      border-color: #2a5298;
      background: #f0f8ff;
    }
    .teleconsultation-icon {
      font-size: 40px;
      color: #2a5298;
      margin-bottom: 10px;
    }
    .video-container {
      background: #000;
      border-radius: 8px;
      margin: 20px 0;
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .video-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    .video-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .video-btn.primary {
      background: #2a5298;
      color: white;
    }
    .video-btn.danger {
      background: #dc3545;
      color: white;
    }
    .video-btn.success {
      background: #28a745;
      color: white;
    }
    .participant-list {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    .participant-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .participant-item:last-child {
      border-bottom: none;
    }
    .invite-link {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .invite-link input {
      flex: 1;
      border: none;
      background: transparent;
    }
    .invite-link button {
      background: #2a5298;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    
    #jitsi-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 9999;
    }
    #jitsi-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #jitsi-meet {
      width: 100%;
      height: 100%;
    }

    /* Styles pour les notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: #28a745;
    }

    .notification.error {
      background: #dc3545;
    }

    .notification.info {
      background: #2a5298;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body class="dashboard-page">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="fa-solid fa-notes-medical"></i> ORDOPASS</div>
    <nav>
      <a href="medecin_dashboard.html"><i class="fa-solid fa-file-medical"></i> Consultations</a>
      <a href="patients.html"><i class="fa-solid fa-users"></i> Patients</a>
      <a href="teleconsultation.html"><i class="fa-solid fa-video"></i> Téléconsultation</a>
      <a href="pharmacies.html"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacies</a>
      <a href="medecin_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="parametres.html"><i class="fa-solid fa-gear"></i> Paramètres</a>
      <a href="medecin_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="medecin_rendezvous.html"><i class="fa-solid fa-calendar-check"></i> Rendez-vous</a>
      <a href="medecin_ordonnance.html"><i class="fa-solid fa-prescription"></i> Ordonnances sécurisées</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
    </nav>
  </aside>

  <!-- Contenu -->
  <main class="main-area">
    <header class="topbar">
      <h1><i class="fa-solid fa-file-medical"></i> Nouvelle Consultation</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay"></span>
      </div>
    </header>

    <section class="content">
      <div class="card">
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading">
          <div class="spinner"></div>
          <p>Enregistrement en cours...</p>
        </div>

        <form id="consultationForm" class="consultation-form">
          <!-- Informations de base -->
          <div class="form-section">
            <h3>Informations de la consultation</h3>
            
            <!-- Section Ticket -->
            <div class="ticket-info">
              <h4><i class="fa-solid fa-ticket"></i> Gestion du Ticket</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Numéro de ticket *</label>
                  <input type="text" class="form-control" id="ticket" required 
                         placeholder="Ex: HOP-2024-001" 
                         onblur="checkTicketAvailability()">
                  <div class="ticket-warning" id="ticketWarning"></div>
                  <button type="button" class="btn-outline" onclick="generateHospitalTicket()" style="margin-top: 5px; width: 100%;">
                    <i class="fa-solid fa-gear"></i> Générer un ticket hospitalier
                  </button>
                </div>
                <div class="form-group">
                  <label class="form-label">Type de consultation</label>
                  <select class="form-control" id="typeConsultation" onchange="updateTicketPrefix()">
                    <option value="consultation">Consultation Standard</option>
                    <option value="urgence">Urgence</option>
                    <option value="controle">Contrôle</option>
                    <option value="specialiste">Spécialiste</option>
                    <option value="teleconsultation">Consultation en ligne</option>
                  </select>
                </div>
              </div>
              <div id="currentTicketDisplay" class="ticket-number"></div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Nom du patient *</label>
                <input type="text" class="form-control" id="nom" required placeholder="Entrez le nom du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Prénom du patient *</label>
                <input type="text" class="form-control" id="prenom" required placeholder="Entrez le prénom du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Âge *</label>
                <input type="number" class="form-control" id="age" placeholder="Âge du patient" required>
              </div>
              <div class="form-group">
                <label class="form-label">Sexe *</label>
                <select class="form-control" id="genre" required>
                  <option value="">-- Choisir --</option>
                  <option>F</option>
                  <option>M</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Téléphone</label>
                <input type="tel" class="form-control" id="telephone" placeholder="Ex: +221 77 123 45 67">
              </div>
              <div class="form-group">
                <label class="form-label">Adresse</label>
                <input type="text" class="form-control" id="adresse" placeholder="Adresse du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Poids (optionnel)</label>
                <input type="text" class="form-control" id="poids" placeholder="Poids du patient">
              </div>
              <div class="form-group">
                <label class="form-label">Image du patient (URL)</label>
                <input type="text" class="form-control" id="image" placeholder="https://example.com/photo.jpg">
              </div>
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-control" id="date" required>
              </div>
              <div class="form-group">
                <label class="form-label">Heure *</label>
                <input type="time" class="form-control" id="heure" required>
              </div>
              <div class="form-group">
                <label class="form-label">Motif de consultation *</label>
                <input type="text" class="form-control" id="motif" required placeholder="Ex: Fièvre, Maux de tête...">
              </div>
              <div class="form-group">
                <label class="form-label">Statut *</label>
                <select class="form-control" id="statut" required>
                  <option value="En attente">En attente</option>
                  <option value="En cours">En cours</option>
                  <option value="Terminé">Terminé</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Téléconsultation -->
          <div class="form-section teleconsultation-section" id="teleconsultationSection">
            <h3><i class="fa-solid fa-video"></i> Consultation en ligne</h3>
            
            <div class="teleconsultation-options">
              <div class="teleconsultation-option" onclick="selectTeleconsultationOption('video')">
                <div class="teleconsultation-icon">
                  <i class="fa-solid fa-video"></i>
                </div>
                <h4>Vidéoconférence</h4>
                <p>Consultation en direct par vidéo</p>
              </div>
              <div class="teleconsultation-option" onclick="selectTeleconsultationOption('audio')">
                <div class="teleconsultation-icon">
                  <i class="fa-solid fa-phone"></i>
                </div>
                <h4>Appel audio</h4>
                <p>Consultation par téléphone</p>
              </div>
              <div class="teleconsultation-option" onclick="selectTeleconsultationOption('chat')">
                <div class="teleconsultation-icon">
                  <i class="fa-solid fa-comments"></i>
                </div>
                <h4>Messagerie</h4>
                <p>Consultation par chat</p>
              </div>
            </div>

            <div id="videoConsultationOptions" style="display: none;">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Lien de la consultation</label>
                  <div class="invite-link">
                    <input type="text" id="consultationLink" readonly value="https://ordopass.sn/consultation/">
                    <button type="button" onclick="copyConsultationLink()">
                      <i class="fa-solid fa-copy"></i> Copier
                    </button>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Durée prévue (minutes)</label>
                  <input type="number" class="form-control" id="dureeConsultation" value="30" min="15" max="120">
                </div>
              </div>

              <div class="video-controls">
                <button type="button" class="video-btn primary" onclick="startJitsiMeeting()">
                  <i class="fa-solid fa-play"></i> Démarrer la consultation vidéo
                </button>
                <button type="button" class="video-btn success" onclick="generateConsultationLink()">
                  <i class="fa-solid fa-link"></i> Générer le lien
                </button>
                <button type="button" class="video-btn danger" onclick="resetVideo()">
                  <i class="fa-solid fa-rotate-left"></i> Réinitialiser
                </button>
              </div>

              <div class="participant-list">
                <h4>Participants</h4>
                <div class="participant-item">
                  <img src="https://i.pravatar.cc/40" class="avatar" alt="Médecin">
                  <div>
                    <strong>Dr. <span id="medecinName"></span></strong>
                    <p style="margin: 0; color: #666;">Médecin</p>
                  </div>
                </div>
                <div class="participant-item">
                  <img src="https://i.pravatar.cc/40?img=5" class="avatar" alt="Patient">
                  <div>
                    <strong id="patientName"></strong>
                    <p style="margin: 0; color: #666;">Patient</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Symptômes -->
          <div class="form-section">
            <h3>Symptômes</h3>
            <div class="form-group">
              <label class="form-label">Description des symptômes *</label>
              <textarea class="form-control" id="symptomes" placeholder="Décrire les symptômes du patient..." required></textarea>
            </div>
          </div>

          <!-- Analyses à faire -->
          <div class="form-section">
            <h3>Analyses médicales</h3>
            <div class="form-group">
              <label class="form-label">Analyses prescrites</label>
              <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" class="form-control" id="newAnalysis" placeholder="Nom de l'analyse" style="flex:1;">
                <button type="button" class="btn-outline" onclick="addAnalysis()">
                  <i class="fa-solid fa-plus"></i> Ajouter
                </button>
              </div>
              <div id="analysesList"></div>
            </div>
          </div>

          <!-- Examens physiques -->
          <div class="form-section">
            <h3>Examens physiques</h3>
            <div class="form-group">
              <label class="form-label">Résultats des examens</label>
              <textarea class="form-control" id="examens" placeholder="Résultats des examens physiques..."></textarea>
            </div>
          </div>

          <!-- Ordonnances -->
          <div class="form-section ordonnance-section">
            <h3><i class="fa-solid fa-prescription"></i> Ordonnance médicale</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Nom du médecin *</label>
                <input type="text" class="form-control" id="nomMedecin" placeholder="Dr ..." required>
              </div>
              <div class="form-group">
                <label class="form-label">Médicament *</label>
                <input type="text" class="form-control" id="medicament" placeholder="Nom du médicament">
              </div>
              <div class="form-group">
                <label class="form-label">Dosage *</label>
                <input type="text" class="form-control" id="dosage" placeholder="Ex: 500mg">
              </div>
              <div class="form-group">
                <label class="form-label">Posologie *</label>
                <input type="text" class="form-control" id="posologie" placeholder="Ex: 1 comprimé matin et soir">
              </div>
              <div class="form-group">
                <label class="form-label">Durée *</label>
                <input type="text" class="form-control" id="duree" placeholder="Ex: 5 jours">
              </div>
            </div>
            <button type="button" class="btn-outline" onclick="addMedication()">
              <i class="fa-solid fa-plus"></i> Ajouter le médicament
            </button>
            <div id="medicationsList" style="margin-top:15px;"></div>
            
            <!-- Points importants pour l'ordonnance -->
            <div class="points-importants">
              <h4><i class="fa-solid fa-exclamation-circle"></i> Points importants pour l'ordonnance</h4>
              <textarea class="form-control" id="pointsImportants" placeholder="Indications spéciales, contre-indications, conseils particuliers..."></textarea>
            </div>
            
            <div style="margin-top: 20px;">
              <button type="button" class="btn-secondary" onclick="generateOrdonnancePreview()">
                <i class="fa-solid fa-eye"></i> Prévisualiser l'ordonnance
              </button>
              <button type="button" class="btn-primary" onclick="saveOrdonnance()">
                <i class="fa-solid fa-save"></i> Sauvegarder l'ordonnance
              </button>
              <button type="button" class="btn-success" id="ordonnancePdfBtn" onclick="generateOrdonnancePDF()" disabled>
                <i class="fa-solid fa-file-pdf"></i> Télécharger PDF
              </button>
              <button type="button" class="btn-warning" onclick="openPharmacieModal()" id="sendOrdonnanceBtn" style="display: none;">
                <i class="fa-solid fa-paper-plane"></i> Envoyer à pharmacie
              </button>
            </div>
            
            <!-- Aperçu de l'ordonnance -->
            <div class="ordonnance-preview" id="ordonnancePreview">
              <img id="logoImg" alt="Logo OrdoPass" class="logo">
              <h2 style="text-align: center;">Ordonnance médicale</h2>
              <p class="medecin-name">Médecin : <span id="pMedecin"></span></p>

              <div class="center-content">
                <p><b>Patient :</b> <span id="pNom"></span></p>
                <p><b>Âge :</b> <span id="pAge"></span> • <b>Sexe :</b> <span id="pGenre"></span></p>
                <p><b>Adresse :</b> <span id="pAdresse"></span></p>
                <p><b>Poids :</b> <span id="pPoids"></span></p>
                <p><b>Date :</b> <span id="pDate"></span></p>
                <p><b>Code :</b> <span id="pCode"></span></p>
                <p><b>Prescription :</b><br><span id="pMedic" style="white-space: pre-line;"></span></p>
                
                <!-- Affichage des points importants -->
                <div id="pPointsImportants" style="text-align: left; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                  <strong>Points importants :</strong><br>
                  <span id="pPointsText"></span>
                </div>
              </div>

              <div id="qrcode" style="text-align: center; margin: 20px 0;"></div>
              <img id="signImg" alt="Signature du médecin" class="signature" style="display: block; margin: 0 auto;">
            </div>
          </div>

          <!-- Facturation intégrée -->
          <div class="form-section facturation-section">
            <h3><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Description *</label>
                <input type="text" class="form-control" id="factureDescription" placeholder="Ex: Consultation médicale" required>
              </div>
              <div class="form-group">
                <label class="form-label">Montant (FCFA) *</label>
                <input type="number" class="form-control" id="factureMontant" placeholder="Montant de la consultation" required>
              </div>
              <div class="form-group">
                <label class="form-label">Méthode de paiement</label>
                <select class="form-control" id="facturePaiement">
                  <option value="Espèces">Espèces</option>
                  <option value="Carte bancaire">Carte bancaire</option>
                  <option value="Wave">Wave</option>
                  <option value="Orange Money">Orange Money</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Facture payée ?</label>
                <select class="form-control" id="facturePaye">
                  <option value="Non">Non</option>
                  <option value="Oui">Oui</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Type de document</label>
                <select class="form-control" id="typeFacture">
                  <option value="FACTURE">Facture</option>
                  <option value="FACTURE PROFORMA">Proforma</option>
                </select>
              </div>
            </div>
            
            <div style="margin-top: 20px;">
              <button type="button" class="btn-secondary" onclick="generateFacturePreview()">
                <i class="fa-solid fa-eye"></i> Prévisualiser la facture
              </button>
              <button type="button" class="btn-primary" onclick="saveFactureFromConsultation()">
                <i class="fa-solid fa-save"></i> Sauvegarder la facture
              </button>
              <button type="button" class="btn-success" id="facturePdfBtn" onclick="generateFacturePDF()" disabled>
                <i class="fa-solid fa-file-pdf"></i> Télécharger PDF
              </button>
            </div>
            
            <!-- Aperçu de la facture -->
            <div class="facture-preview" id="facturePreview">
              <div class="facture-header">
                <div class="facture-logo">
                  <img src="https://via.placeholder.com/100x50/2a5298/ffffff?text=ORDOPASS" alt="Logo OrdoPass" style="width:100px;">
                </div>
                <div style="text-align: center;">
                  <h3 style="margin:0; color:#2a5298;">CLINIQUE ORDOPASS</h3>
                  <small>www.ordopass.sn</small>
                </div>
              </div>
              
              <h2 class="facture-title" id="factureTitle">FACTURE</h2>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                  <p><b>N° Patient :</b> <span id="facturePatientId"></span></p>
                  <p><b>Date :</b> <span id="factureDate"></span></p>
                </div>
                <div>
                  <p><b>Ticket :</b> <span id="factureTicket"></span></p>
                  <p><b>Médecin :</b> <span id="factureMedecin"></span></p>
                </div>
              </div>
              
              <hr>
              
              <div style="margin-bottom: 20px;">
                <p><b>Patient :</b> <span id="facturePatient"></span></p>
                <p><b>Âge :</b> <span id="factureAge"></span> ans</p>
                <p><b>Adresse :</b> <span id="factureAdresse"></span></p>
              </div>
              
              <table class="facture-table">
                <thead>
                  <tr>
                    <th>Désignation</th>
                    <th>Qté</th>
                    <th>PU (FCFA)</th>
                    <th>Montant (FCFA)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td id="factureDescriptionPreview"></td>
                    <td>1</td>
                    <td id="facturePrixUnitaire"></td>
                    <td id="factureTotal"></td>
                  </tr>
                </tbody>
              </table>
              
              <div class="total-zone">
                <p><b>TOTAL GÉNÉRAL :</b> <span id="factureMontantTotal"></span> FCFA</p>
                <p><b>Méthode de paiement :</b> <span id="facturePaiementPreview"></span></p>
                <p><b>Facture payée :</b> <span id="facturePayePreview"></span></p>
              </div>
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="action-buttons">
            <div class="action-buttons-left">
              <button type="submit" class="btn-primary">
                <i class="fa-solid fa-floppy-disk"></i> Enregistrer la consultation
              </button>
              <button type="button" class="btn-success" onclick="savePatientAndConsultation()">
                <i class="fa-solid fa-user-plus"></i> Ajouter patient et consultation
              </button>
              <button type="button" class="btn-outline" onclick="goBack()">
                <i class="fa-solid fa-arrow-left"></i> Retour
              </button>
            </div>
            <div class="action-buttons-right">
              <button type="button" class="btn-danger" onclick="cancelForm()">
                <i class="fa-solid fa-times"></i> Annuler
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script>
    const { jsPDF } = window.jspdf;

    // Variables globales
    let analyses = [];
    let medications = [];
    let currentTicketPrefix = 'CONS';
    let currentOrdonnanceCode = '';
    let currentFactureCode = '';
    let selectedTeleconsultationType = '';
    let consultationLink = '';
    let jitsiApi = null;

    // Configuration pour l'ordonnance
    const logoBase64 = "data:image/png;base64,BASE64_LOGO_ICI";  
    const signBase64 = "data:image/png;base64,BASE64_SIGNATURE_ICI";  

    // Fonction pour sauvegarder la facture depuis la consultation
    function saveFactureFromConsultation() {
        const nom = document.getElementById("nom").value.trim();
        const prenom = document.getElementById("prenom").value.trim();
        const age = document.getElementById("age").value.trim();
        const adresse = document.getElementById("adresse").value.trim();
        const ticket = document.getElementById("ticket").value.trim();
        const medecin = document.getElementById("nomMedecin").value.trim();
        const description = document.getElementById("factureDescription").value.trim();
        const montant = document.getElementById("factureMontant").value;
        const paiement = document.getElementById("facturePaiement").value;
        const facturePaye = document.getElementById("facturePaye").value;
        const typeFacture = document.getElementById("typeFacture").value;

        if (!description || !montant) {
            alert("Veuillez remplir tous les champs obligatoires de la facture");
            return;
        }

        try {
            // Récupérer ou initialiser les factures dans localStorage
            const facturesLocal = JSON.parse(localStorage.getItem("factures")) || [];
            const newFactureId = facturesLocal.length > 0 ? Math.max(...facturesLocal.map(f => f.id)) + 1 : 1;

            // Générer un code unique pour la facture
            const factureCode = currentFactureCode || 'FAC' + Date.now().toString(36).toUpperCase();

            // Créer l'objet facture avec la même structure que la page de facturation
            const factureData = {
                id: newFactureId,
                patientId: ticket, // Utiliser le ticket comme identifiant patient
                patientName: `${nom} ${prenom}`,
                age: age,
                adresse: adresse,
                description: description,
                montant: parseFloat(montant),
                paiement: paiement,
                facturePaye: facturePaye,
                typeFacture: typeFacture,
                date: new Date().toLocaleDateString(),
                statut: facturePaye === 'Oui' ? 'Payée' : 'Non payée',
                createdAt: new Date().toISOString()
            };

            // Sauvegarder dans localStorage
            facturesLocal.push(factureData);
            localStorage.setItem("factures", JSON.stringify(facturesLocal));

            currentFactureCode = factureCode;
            
            showNotification('✅ Facture sauvegardée avec succès!', 'success');
            console.log('✅ Facture sauvegardée depuis consultation:', factureData);

        } catch (error) {
            console.error('❌ Erreur lors de la sauvegarde de la facture:', error);
            showNotification('Erreur lors de la sauvegarde de la facture', 'error');
        }
    }

    // Générer l'aperçu de la facture
    function generateFacturePreview() {
        const nom = document.getElementById("nom").value.trim();
        const prenom = document.getElementById("prenom").value.trim();
        const age = document.getElementById("age").value.trim();
        const adresse = document.getElementById("adresse").value.trim();
        const ticket = document.getElementById("ticket").value.trim();
        const medecin = document.getElementById("nomMedecin").value.trim();
        const description = document.getElementById("factureDescription").value.trim();
        const montant = document.getElementById("factureMontant").value;
        const paiement = document.getElementById("facturePaiement").value;
        const facturePaye = document.getElementById("facturePaye").value;
        const typeFacture = document.getElementById("typeFacture").value;
        const dateNow = new Date().toLocaleDateString("fr-FR");

        // Validation des champs obligatoires
        if (!description || !montant) {
            alert("Veuillez remplir tous les champs obligatoires de la facture");
            return;
        }

        // Générer un code unique pour la facture
        currentFactureCode = 'FAC' + Date.now().toString(36).toUpperCase();

        // Injection HTML
        document.getElementById("factureTitle").textContent = typeFacture;
        document.getElementById("facturePatientId").textContent = currentFactureCode;
        document.getElementById("factureDate").textContent = dateNow;
        document.getElementById("factureTicket").textContent = ticket;
        document.getElementById("factureMedecin").textContent = medecin;
        document.getElementById("facturePatient").textContent = `${nom} ${prenom}`;
        document.getElementById("factureAge").textContent = age;
        document.getElementById("factureAdresse").textContent = adresse;
        document.getElementById("factureDescriptionPreview").textContent = description;
        document.getElementById("facturePrixUnitaire").textContent = parseFloat(montant).toLocaleString();
        document.getElementById("factureTotal").textContent = parseFloat(montant).toLocaleString();
        document.getElementById("factureMontantTotal").textContent = parseFloat(montant).toLocaleString();
        document.getElementById("facturePaiementPreview").textContent = paiement;
        document.getElementById("facturePayePreview").textContent = facturePaye;

        // Afficher l'aperçu
        document.getElementById("facturePreview").style.display = "block";
        document.getElementById("facturePdfBtn").disabled = false;
    }

    // Générer le PDF de la facture
    function generateFacturePDF() {
        const factureContent = document.getElementById("facturePreview");
        const typeFacture = document.getElementById("typeFacture").value;
        
        html2canvas(factureContent).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p", "mm", "a4");
            const imgWidth = 190;
            const pageHeight = 295;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let position = 10;

            pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
            pdf.save(typeFacture.replace(" ", "_").toLowerCase() + ".pdf");
        });
    }

    // Fonction pour afficher les notifications
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Supprimer après 5 secondes
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Fonction de debug pour vérifier le localStorage
    function debugStorage() {
        console.log('=== DEBUG LOCALSTORAGE ===');
        console.log('Patients:', JSON.parse(localStorage.getItem('patients')) || []);
        console.log('Consultations:', JSON.parse(localStorage.getItem('consultations')) || []);
        console.log('Ordonnances:', JSON.parse(localStorage.getItem('ordonnances')) || []);
        console.log('Factures:', JSON.parse(localStorage.getItem('factures')) || []);
        console.log('Tickets utilisés:', JSON.parse(localStorage.getItem('usedTickets')) || []);
        console.log('Téléconsultations:', JSON.parse(localStorage.getItem('teleconsultations')) || []);
        console.log('========================');
    }

    // Afficher/masquer le loading
    function showLoading(show) {
        document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        document.getElementById('consultationForm').style.display = show ? 'none' : 'block';
    }

    // Mettre à jour le préfixe du ticket selon le type de consultation
    function updateTicketPrefix() {
        const type = document.getElementById('typeConsultation').value;
        const prefixes = {
            'consultation': 'CONS',
            'urgence': 'URG',
            'controle': 'CTRL',
            'specialiste': 'SPEC',
            'teleconsultation': 'TELECONS'
        };
        currentTicketPrefix = prefixes[type] || 'CONS';
        
        // Afficher/masquer la section téléconsultation
        if (type === 'teleconsultation') {
            document.getElementById('teleconsultationSection').style.display = 'block';
        } else {
            document.getElementById('teleconsultationSection').style.display = 'none';
            selectedTeleconsultationType = '';
            document.getElementById('videoConsultationOptions').style.display = 'none';
        }
        
        generateHospitalTicket();
    }

    // Sélectionner une option de téléconsultation
    function selectTeleconsultationOption(type) {
        selectedTeleconsultationType = type;
        
        // Retirer la sélection de toutes les options
        document.querySelectorAll('.teleconsultation-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Ajouter la sélection à l'option choisie
        event.currentTarget.classList.add('selected');
        
        // Afficher les options vidéo si vidéo sélectionnée
        if (type === 'video') {
            document.getElementById('videoConsultationOptions').style.display = 'block';
            generateConsultationLink();
        } else {
            document.getElementById('videoConsultationOptions').style.display = 'none';
        }
        
        // Mettre à jour les noms des participants
        updateParticipantNames();
    }

    // Générer un lien de consultation unique
    function generateConsultationLink() {
        const ticket = document.getElementById('ticket').value;
        const uniqueId = Date.now().toString(36);
        consultationLink = `https://ordopass.sn/consultation/${ticket}-${uniqueId}`;
        document.getElementById('consultationLink').value = consultationLink;
        return consultationLink;
    }

    // Copier le lien de consultation
    function copyConsultationLink() {
        const linkInput = document.getElementById('consultationLink');
        linkInput.select();
        document.execCommand('copy');
        alert('Lien copié dans le presse-papier !');
    }

    // Démarrer une réunion Jitsi
    function startJitsiMeeting() {
        const ticket = document.getElementById('ticket').value;
        const roomName = `OrdoPass-${ticket}`;
        
        // Afficher le conteneur Jitsi
        document.getElementById('jitsi-container').style.display = 'block';
        
        // Initialiser Jitsi Meet
        const domain = 'meet.jit.si';
        const options = {
            roomName: roomName,
            width: '100%',
            height: '100%',
            parentNode: document.getElementById('jitsi-meet'),
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'closedcaptions', 'desktop', 'embedmeeting',
                    'fullscreen', 'fodeviceselection', 'hangup', 'profile', 'chat',
                    'recording', 'livestreaming', 'etherpad', 'sharedvideo', 'settings',
                    'raisehand', 'videoquality', 'filmstrip', 'invite', 'feedback',
                    'stats', 'shortcuts', 'tileview', 'videobackgroundblur', 'download',
                    'help', 'mute-everyone', 'security'
                ],
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                DEFAULT_BACKGROUND: '#2a5298',
                DISABLE_VIDEO_BACKGROUND: false,
                DISABLE_FOCUS_INDICATOR: false,
                DISABLE_DOMINANT_SPEAKER_INDICATOR: false,
                SETTINGS_SECTIONS: ['devices', 'language', 'moderator', 'profile', 'calendar'],
                SHOW_CHROME_EXTENSION_BANNER: false
            },
            configOverwrite: {
                disableModeratorIndicator: false,
                startScreenSharing: false,
                enableEmailInStats: false,
                enableWelcomePage: false,
                enableClosePage: false,
                prejoinPageEnabled: false,
                disableInviteFunctions: false,
                disableThirdPartyRequests: true,
                enableNoAudioDetection: true,
                enableNoisyMicDetection: true,
                startWithAudioMuted: false,
                startWithVideoMuted: false,
                defaultLanguage: 'fr',
                disableAddingBackgroundImages: true,
                subject: `Consultation OrdoPass - ${ticket}`
            },
            userInfo: {
                displayName: `Dr. ${document.getElementById('nomMedecin').value || 'Médecin'}`,
                email: ''
            }
        };

        jitsiApi = new JitsiMeetExternalAPI(domain, options);
        
        // Événement quand la réunion est prête
        jitsiApi.addEventListener('videoConferenceJoined', () => {
            console.log('Rejoint la conférence Jitsi');
        });
        
        // Événement quand la réunion est terminée
        jitsiApi.addEventListener('videoConferenceLeft', () => {
            console.log('Quitté la conférence Jitsi');
            closeJitsiMeeting();
        });
        
        // Événement quand un participant rejoint
        jitsiApi.addEventListener('participantJoined', (participant) => {
            console.log('Participant rejoint:', participant);
        });
    }

    // Fermer la réunion Jitsi
    function closeJitsiMeeting() {
        if (jitsiApi) {
            jitsiApi.dispose();
            jitsiApi = null;
        }
        document.getElementById('jitsi-container').style.display = 'none';
    }

    // Réinitialiser la vidéo
    function resetVideo() {
        document.getElementById('videoConsultationOptions').style.display = 'none';
        selectedTeleconsultationType = '';
        document.querySelectorAll('.teleconsultation-option').forEach(option => {
            option.classList.remove('selected');
        });
    }

    // Mettre à jour les noms des participants
    function updateParticipantNames() {
        const medecinName = document.getElementById('nomMedecin').value || 'Médecin';
        const patientName = document.getElementById('nom').value + ' ' + document.getElementById('prenom').value;
        
        document.getElementById('medecinName').textContent = medecinName;
        document.getElementById('patientName').textContent = patientName;
    }

    // Générer un ticket hospitalier réaliste
    function generateHospitalTicket() {
        const today = new Date();
        const year = today.getFullYear();
        
        // Récupérer les tickets déjà utilisés
        const usedTickets = JSON.parse(localStorage.getItem('usedTickets')) || [];
        const consultations = JSON.parse(localStorage.getItem('consultations')) || [];
        
        // Compter les consultations de l'année en cours
        const yearConsultations = consultations.filter(c => {
            const consultYear = new Date(c.date).getFullYear();
            return consultYear === year;
        });
        
        // Générer le prochain numéro séquentiel
        let nextNumber = yearConsultations.length + 1;
        let newTicket = `${currentTicketPrefix}-${year}-${nextNumber.toString().padStart(3, '0')}`;
        
        // Vérifier si le ticket existe déjà
        while (usedTickets.includes(newTicket) || consultations.some(c => c.ticket === newTicket)) {
            nextNumber++;
            newTicket = `${currentTicketPrefix}-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }
        
        document.getElementById('ticket').value = newTicket;
        document.getElementById('currentTicketDisplay').textContent = `Ticket: ${newTicket}`;
        document.getElementById('ticketWarning').textContent = '';
        document.getElementById('ticketWarning').style.color = 'green';
        
        checkTicketAvailability();
    }

    // Vérifier la disponibilité du ticket
    function checkTicketAvailability() {
        const ticketInput = document.getElementById('ticket');
        const ticket = ticketInput.value.trim();
        const warningElement = document.getElementById('ticketWarning');
        
        if (!ticket) {
            warningElement.textContent = '';
            return true;
        }
        
        // Vérifier le format du ticket
        const ticketRegex = /^(CONS|URG|CTRL|SPEC|TELECONS)-\d{4}-\d{3}$/;
        if (!ticketRegex.test(ticket)) {
            warningElement.textContent = '❌ Format de ticket invalide. Format attendu: XXX-AAAA-NNN';
            warningElement.style.color = 'red';
            return false;
        }
        
        // Vérifier si le ticket est déjà utilisé
        const usedTickets = JSON.parse(localStorage.getItem('usedTickets')) || [];
        const consultations = JSON.parse(localStorage.getItem('consultations')) || [];
        const isTicketUsed = usedTickets.includes(ticket) || consultations.some(c => c.ticket === ticket);
        
        if (isTicketUsed) {
            warningElement.textContent = '❌ Ce ticket est déjà utilisé pour un autre patient';
            warningElement.style.color = 'red';
            ticketInput.style.borderColor = 'red';
            return false;
        } else {
            warningElement.textContent = '✅ Ticket disponible';
            warningElement.style.color = 'green';
            ticketInput.style.borderColor = 'green';
            return true;
        }
    }

    // Marquer un ticket comme utilisé
    function markTicketAsUsed(ticket) {
        const usedTickets = JSON.parse(localStorage.getItem('usedTickets')) || [];
        if (!usedTickets.includes(ticket)) {
            usedTickets.push(ticket);
            localStorage.setItem('usedTickets', JSON.stringify(usedTickets));
        }
    }

    // Ajouter une analyse
    function addAnalysis() {
      const analysisInput = document.getElementById('newAnalysis');
      const analysis = analysisInput.value.trim();
      
      if (analysis) {
        analyses.push(analysis);
        updateAnalysesList();
        analysisInput.value = '';
        analysisInput.focus();
      } else {
        alert('Veuillez entrer le nom de l\'analyse');
      }
    }

    // Mettre à jour la liste des analyses
    function updateAnalysesList() {
      const container = document.getElementById('analysesList');
      container.innerHTML = '';

      if (analyses.length === 0) {
        container.innerHTML = '<p style="color:#666; font-style:italic;">Aucune analyse ajoutée</p>';
        return;
      }

      analyses.forEach((analysis, index) => {
        const item = document.createElement('div');
        item.className = 'analysis-item';
        item.innerHTML = `
          <div class="item-header">
            <span><i class="fa-solid fa-flask"></i> ${analysis}</span>
            <button type="button" class="remove-btn" onclick="removeAnalysis(${index})">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    // Supprimer une analyse
    function removeAnalysis(index) {
      analyses.splice(index, 1);
      updateAnalysesList();
    }

    // Ajouter un médicament
    function addMedication() {
      const medicament = document.getElementById('medicament').value.trim();
      const dosage = document.getElementById('dosage').value.trim();
      const posologie = document.getElementById('posologie').value.trim();
      const duree = document.getElementById('duree').value.trim();

      if (medicament && dosage && posologie && duree) {
        medications.push({
          medicament,
          dosage,
          posologie,
          duree
        });

        updateMedicationsList();
        clearMedicationForm();
      } else {
        alert('Veuillez remplir tous les champs du médicament');
      }
    }

    // Mettre à jour la liste des médicaments
    function updateMedicationsList() {
      const container = document.getElementById('medicationsList');
      container.innerHTML = '';

      if (medications.length === 0) {
        container.innerHTML = '<p style="color:#666; font-style:italic;">Aucun médicament ajouté</p>';
        return;
      }

      medications.forEach((med, index) => {
        const item = document.createElement('div');
        item.className = 'medication-item';
        item.innerHTML = `
          <div class="item-header">
            <strong><i class="fa-solid fa-pills"></i> ${med.medicament} - ${med.dosage}</strong>
            <button type="button" class="remove-btn" onclick="removeMedication(${index})">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
          <div><strong>Posologie:</strong> ${med.posologie}</div>
          <div><strong>Durée:</strong> ${med.duree}</div>
        `;
        container.appendChild(item);
      });
    }

    // Supprimer un médicament
    function removeMedication(index) {
      medications.splice(index, 1);
      updateMedicationsList();
    }

    // Vider le formulaire médicament
    function clearMedicationForm() {
      document.getElementById('medicament').value = '';
      document.getElementById('dosage').value = '';
      document.getElementById('posologie').value = '';
      document.getElementById('duree').value = '';
      document.getElementById('medicament').focus();
    }

    // Générer l'aperçu de l'ordonnance
    function generateOrdonnancePreview() {
        const medecin = document.getElementById("nomMedecin").value.trim();
        const nom = document.getElementById("nom").value.trim();
        const prenom = document.getElementById("prenom").value.trim();
        const age = document.getElementById("age").value.trim() + " ans";
        const genre = document.getElementById("genre").value;
        const adresse = document.getElementById("adresse").value.trim();
        const poids = document.getElementById("poids").value.trim();
        const dateField = document.getElementById("date").value;
        const pointsImportants = document.getElementById("pointsImportants").value.trim();
        const dateNow = dateField ? new Date(dateField).toLocaleDateString("fr-FR") : new Date().toLocaleDateString("fr-FR");

        // Validation des champs obligatoires
        if (!medecin || !nom || !prenom || !age || !genre) {
            alert("Veuillez remplir tous les champs obligatoires (nom du médecin, nom, prénom, âge et sexe du patient)");
            return;
        }

        // Formater les médicaments pour l'ordonnance
        let medicText = "";
        medications.forEach(med => {
            medicText += `${med.medicament} ${med.dosage}\n`;
            medicText += `Posologie: ${med.posologie}\n`;
            medicText += `Durée: ${med.duree}\n\n`;
        });

        // Injection HTML
        document.getElementById("pMedecin").innerText = medecin;
        document.getElementById("pNom").innerText = `${nom} ${prenom}`;
        document.getElementById("pAge").innerText = age + " ans";
        document.getElementById("pGenre").innerText = genre;
        document.getElementById("pAdresse").innerText = adresse;
        document.getElementById("pPoids").innerText = poids || "-";
        document.getElementById("pDate").innerText = dateNow;
        document.getElementById("pMedic").innerText = medicText || "Aucun médicament prescrit";
        document.getElementById("pPointsText").innerText = pointsImportants || "Aucun point particulier";

        // Afficher ou masquer la section points importants
        if (pointsImportants) {
            document.getElementById("pPointsImportants").style.display = "block";
        } else {
            document.getElementById("pPointsImportants").style.display = "none";
        }

        // Générer un code unique pour l'ordonnance
        currentOrdonnanceCode = 'ORD' + Date.now().toString(36).toUpperCase();
        document.getElementById("pCode").innerText = currentOrdonnanceCode;

        // QR code
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { 
            text: `https://ordopass.sn/verify?code=${currentOrdonnanceCode}`, 
            width: 100, 
            height: 100 
        });

        // Afficher l'aperçu
        document.getElementById("ordonnancePreview").style.display = "block";
        document.getElementById("ordonnancePdfBtn").disabled = false;
        document.getElementById("sendOrdonnanceBtn").style.display = "inline-block";
    }

    // Sauvegarder l'ordonnance
    function saveOrdonnance() {
        const medecin = document.getElementById("nomMedecin").value.trim();
        const nom = document.getElementById("nom").value.trim();
        const prenom = document.getElementById("prenom").value.trim();
        const age = document.getElementById("age").value.trim();
        const genre = document.getElementById("genre").value;
        const adresse = document.getElementById("adresse").value.trim();
        const poids = document.getElementById("poids").value.trim();
        const dateField = document.getElementById("date").value;
        const pointsImportants = document.getElementById("pointsImportants").value.trim();

        if (!medecin || !nom || !prenom || !age || !genre) {
            alert("Veuillez remplir tous les champs obligatoires de l'ordonnance");
            return;
        }

        if (medications.length === 0) {
            alert("Veuillez ajouter au moins un médicament à l'ordonnance");
            return;
        }

        try {
            // Récupérer ou initialiser les ordonnances dans localStorage
            const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
            const newOrdonnanceId = ordonnances.length > 0 ? Math.max(...ordonnances.map(o => o.id)) + 1 : 1;

            // Générer un code unique pour l'ordonnance
            const ordonnanceCode = currentOrdonnanceCode || 'ORD' + Date.now().toString(36).toUpperCase();

            // Créer l'objet ordonnance
            const ordonnanceData = {
                id: newOrdonnanceId,
                _id: 'ord_' + Date.now(),
                code: ordonnanceCode,
                medecinNom: medecin,
                patientNom: `${nom} ${prenom}`,
                patientAge: age,
                patientGenre: genre,
                patientAdresse: adresse,
                patientPoids: poids,
                medicaments: medications,
                pointsImportants: pointsImportants,
                dateOrd: dateField || new Date().toISOString().split('T')[0],
                statut: 'active',
                createdAt: new Date().toISOString()
            };

            // Sauvegarder dans localStorage
            ordonnances.push(ordonnanceData);
            localStorage.setItem('ordonnances', JSON.stringify(ordonnances));

            currentOrdonnanceCode = ordonnanceCode;
            
            showNotification('✅ Ordonnance sauvegardée avec succès! Code: ' + ordonnanceCode, 'success');
            console.log('✅ Ordonnance sauvegardée:', ordonnanceData);

        } catch (error) {
            console.error('❌ Erreur lors de la sauvegarde de l\'ordonnance:', error);
            showNotification('Erreur lors de la sauvegarde de l\'ordonnance', 'error');
        }
    }

    // Générer le PDF de l'ordonnance
    function generateOrdonnancePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const medecin = document.getElementById("nomMedecin").value.trim();
        const nom = document.getElementById("nom").value.trim();
        const prenom = document.getElementById("prenom").value.trim();
        const age = document.getElementById("age").value.trim() + " ans";
        const genre = document.getElementById("genre").value;
        const adresse = document.getElementById("adresse").value.trim();
        const poids = document.getElementById("poids").value.trim();
        const dateField = document.getElementById("date").value;
        const pointsImportants = document.getElementById("pointsImportants").value.trim();
        const dateNow = dateField ? new Date(dateField).toLocaleDateString("fr-FR") : new Date().toLocaleDateString("fr-FR");
        const code = currentOrdonnanceCode;

        // Formater les médicaments pour le PDF
        let medicText = "";
        medications.forEach(med => {
            medicText += `${med.medicament} ${med.dosage}\n`;
            medicText += `Posologie: ${med.posologie}\n`;
            medicText += `Durée: ${med.duree}\n\n`;
        });

        // En-tête
        doc.setFillColor(42, 82, 152);
        doc.rect(0, 0, 210, 25, "F");
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("Ordonnance médicale", 105, 15, { align: "center" });

        // Informations médecin
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text(`Médecin : ${medecin}`, 105, 35, { align: "center" });

        // Informations patient
        doc.setFontSize(12);
        doc.text(`Patient : ${nom} ${prenom}`, 20, 50);
        doc.text(`Âge : ${age}`, 20, 58);
        doc.text(`Sexe : ${genre}`, 20, 66);
        doc.text(`Adresse : ${adresse}`, 20, 74);
        if (poids) doc.text(`Poids : ${poids}`, 20, 82);
        doc.text(`Date : ${dateNow}`, 20, 90);
        doc.text(`Code : ${code}`, 20, 98);

        // Prescription
        doc.setFontSize(13);
        doc.setTextColor(42, 82, 152);
        doc.text("PRESCRIPTION MÉDICALE", 20, 115);
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        const splitText = doc.splitTextToSize(medicText, 170);
        doc.text(splitText, 20, 125);

        // Points importants
        if (pointsImportants) {
            doc.setFontSize(13);
            doc.setTextColor(42, 82, 152);
            doc.text("POINTS IMPORTANTS", 20, 160);
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            const pointsSplit = doc.splitTextToSize(pointsImportants, 170);
            doc.text(pointsSplit, 20, 170);
        }

        // Signature et QR Code
        doc.setFontSize(10);
        doc.text("Signature et cachet du médecin:", 20, 200);
        doc.addImage(signBase64, "PNG", 20, 205, 40, 20);

        const qrImg = document.querySelector("#qrcode img");
        if (qrImg) {
            doc.addImage(qrImg.src, "PNG", 150, 190, 40, 40);
        }

        // Pied de page
        doc.setFillColor(42, 82, 152);
        doc.rect(0, 275, 210, 20, "F");
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.text("OrdoPass - Système sécurisé de gestion des ordonnances", 105, 283, { align: "center" });
        doc.text("www.ordopass.sn - contact@ordopass.sn - +221 77 123 45 67", 105, 289, { align: "center" });

        doc.save(`ordonnance_${nom}_${prenom}_${code}.pdf`);
    }

    // Fonction pour sauvegarder le patient ET la consultation
    async function savePatientAndConsultation() {
        console.log("🚀 Début de l'enregistrement patient + consultation");
        
        // Validation des champs obligatoires
        const requiredFields = ['ticket', 'nom', 'prenom', 'date', 'heure', 'motif', 'symptomes'];
        const missingFields = requiredFields.filter(field => {
            const value = document.getElementById(field).value.trim();
            return !value;
        });
        
        if (missingFields.length > 0) {
            alert('Veuillez remplir tous les champs obligatoires (*)');
            missingFields.forEach(field => {
                document.getElementById(field).style.borderColor = 'red';
            });
            return;
        }

        // Vérifier la disponibilité du ticket
        if (!checkTicketAvailability()) {
            alert('❌ Veuillez corriger le numéro de ticket avant de continuer');
            return;
        }

        // Réinitialiser les bordures
        requiredFields.forEach(field => {
            document.getElementById(field).style.borderColor = '';
        });

        showLoading(true);

        try {
            // Récupérer les données du formulaire
            const formData = {
                ticket: document.getElementById('ticket').value.trim(),
                nom: document.getElementById('nom').value.trim(),
                prenom: document.getElementById('prenom').value.trim(),
                telephone: document.getElementById('telephone').value.trim(),
                adresse: document.getElementById('adresse').value.trim(),
                image: document.getElementById('image').value.trim() || 'https://i.pravatar.cc/40',
                date: document.getElementById('date').value,
                heure: document.getElementById('heure').value,
                motif: document.getElementById('motif').value.trim(),
                statut: document.getElementById('statut').value,
                symptomes: document.getElementById('symptomes').value.trim(),
                analyses: [...analyses],
                examens: document.getElementById('examens').value.trim(),
                medications: [...medications],
                typeConsultation: document.getElementById('typeConsultation').value,
                teleconsultationType: selectedTeleconsultationType,
                consultationLink: consultationLink
            };

            console.log('📋 Données à enregistrer:', formData);

            // 1. GESTION DU PATIENT
            let patientId;
            const patientFullName = `${formData.nom} ${formData.prenom}`.toLowerCase();
            
            // Rechercher le patient dans localStorage
            const localPatients = JSON.parse(localStorage.getItem('patients')) || [];
            const existingPatient = localPatients.find(patient => 
                patient.name.toLowerCase() === patientFullName ||
                (patient.nom && patient.prenom && 
                 `${patient.nom} ${patient.prenom}`.toLowerCase() === patientFullName)
            );

            if (existingPatient) {
                // Patient existant
                patientId = existingPatient.id;
                console.log('✅ Patient existant trouvé:', existingPatient);
                
                // Mettre à jour les informations si nécessaire
                if (formData.telephone || formData.adresse) {
                    const updatedPatient = {
                        ...existingPatient,
                        phone: formData.telephone || existingPatient.phone,
                        address: formData.adresse || existingPatient.address,
                        lastVisit: formData.date
                    };
                    
                    const patientIndex = localPatients.findIndex(p => p.id === patientId);
                    localPatients[patientIndex] = updatedPatient;
                    localStorage.setItem('patients', JSON.stringify(localPatients));
                    console.log('🔄 Patient mis à jour:', updatedPatient);
                }
            } else {
                // Créer un nouveau patient
                const newPatientId = localPatients.length > 0 ? Math.max(...localPatients.map(p => p.id)) + 1 : 1;
                
                const newPatient = {
                    id: newPatientId,
                    name: `${formData.nom} ${formData.prenom}`,
                    nom: formData.nom,
                    prenom: formData.prenom,
                    age: document.getElementById('age').value || 30,
                    phone: formData.telephone,
                    address: formData.adresse,
                    image: formData.image,
                    added: new Date().toISOString().split('T')[0],
                    gender: document.getElementById('genre').value || 'Non spécifié',
                    lastVisit: formData.date,
                    email: '',
                    birthdate: '',
                    idNumber: '',
                    paymentMethod: 'Wave',
                    insurance: 'Oui',
                    status: 'Actif'
                };

                localPatients.push(newPatient);
                localStorage.setItem('patients', JSON.stringify(localPatients));
                patientId = newPatientId;
                
                console.log('✅ Nouveau patient créé:', newPatient);
            }

            // 2. GESTION DE LA CONSULTATION
            const consultations = JSON.parse(localStorage.getItem('consultations')) || [];
            const newConsultationId = consultations.length > 0 ? Math.max(...consultations.map(c => c.id)) + 1 : 1;

            const consultationData = {
                id: newConsultationId,
                patientId: patientId,
                patientName: `${formData.nom} ${formData.prenom}`,
                ticket: formData.ticket,
                nom: formData.nom,
                prenom: formData.prenom,
                image: formData.image,
                date: formData.date,
                heure: formData.heure,
                motif: formData.motif,
                statut: formData.statut,
                symptoms: formData.symptomes,
                analyses: formData.analyses,
                examens: formData.examens ? [formData.examens] : [],
                typeConsultation: formData.typeConsultation,
                teleconsultationType: formData.teleconsultationType,
                consultationLink: formData.consultationLink,
                createdAt: new Date().toISOString()
            };

            consultations.push(consultationData);
            localStorage.setItem('consultations', JSON.stringify(consultations));

            // 3. GESTION DE LA TÉLÉCONSULTATION
            if (formData.teleconsultationType) {
                const teleconsultations = JSON.parse(localStorage.getItem('teleconsultations')) || [];
                const newTeleconsultationId = teleconsultations.length > 0 ? Math.max(...teleconsultations.map(t => t.id)) + 1 : 1;
                
                const teleconsultationData = {
                    id: newTeleconsultationId,
                    consultationId: newConsultationId,
                    patientId: patientId,
                    patientName: `${formData.nom} ${formData.prenom}`,
                    type: formData.teleconsultationType,
                    link: formData.consultationLink,
                    duree: document.getElementById('dureeConsultation')?.value || 30,
                    statut: 'Planifiée',
                    date: formData.date,
                    heure: formData.heure,
                    createdAt: new Date().toISOString()
                };
                
                teleconsultations.push(teleconsultationData);
                localStorage.setItem('teleconsultations', JSON.stringify(teleconsultations));
                console.log('✅ Téléconsultation créée:', teleconsultationData);
            }

            // 4. MARQUER LE TICKET COMME UTILISÉ
            markTicketAsUsed(formData.ticket);

            console.log('✅ Consultation créée:', consultationData);

            // 5. GESTION DES ORDONNANCES
            if (medications.length > 0) {
                const ordonnances = JSON.parse(localStorage.getItem('ordonnances')) || [];
                const newOrdonnanceId = ordonnances.length > 0 ? Math.max(...ordonnances.map(o => o.id)) + 1 : 1;
                
                const ordonnanceCode = currentOrdonnanceCode || 'ORD' + Date.now().toString(36).toUpperCase();
                
                const ordonnanceData = {
                    id: newOrdonnanceId,
                    _id: 'ord_' + Date.now(),
                    patientId: patientId,
                    patientName: `${formData.nom} ${formData.prenom}`,
                    consultationId: newConsultationId,
                    code: ordonnanceCode,
                    medecinNom: document.getElementById('nomMedecin').value || document.getElementById('usernameDisplay').textContent || 'Dr. Inconnu',
                    patientNom: `${formData.nom} ${formData.prenom}`,
                    patientAge: document.getElementById('age').value,
                    patientGenre: document.getElementById('genre').value,
                    patientAdresse: formData.adresse,
                    patientPoids: document.getElementById('poids').value,
                    medicaments: formData.medications,
                    pointsImportants: document.getElementById('pointsImportants').value,
                    dateOrd: formData.date,
                    statut: 'active',
                    createdAt: new Date().toISOString()
                };
                
                ordonnances.push(ordonnanceData);
                localStorage.setItem('ordonnances', JSON.stringify(ordonnances));
                
                console.log('✅ Ordonnance créée:', ordonnanceData);
            }

            // 6. GESTION DES FACTURES
            const factureDescription = document.getElementById("factureDescription").value.trim();
            const factureMontant = document.getElementById("factureMontant").value;
            
            if (factureDescription && factureMontant) {
                // Utiliser la fonction de sauvegarde de facture intégrée
                saveFactureFromConsultation();
            }

            // 7. MISE À JOUR DES STATISTIQUES
            updateStats();

            // Afficher le message de succès
            showLoading(false);
            
            // Vérification finale
            const patientsFinal = JSON.parse(localStorage.getItem('patients')) || [];
            const consultationsFinal = JSON.parse(localStorage.getItem('consultations')) || [];
            
            console.log('📊 VÉRIFICATION FINALE:');
            console.log('Patients:', patientsFinal.length);
            console.log('Consultations:', consultationsFinal.length);
            
            const patientAction = existingPatient ? 'mis à jour' : 'créé';
            let successMessage = `✅ Patient ${patientAction} et consultation enregistrés avec succès!\n\nPatient: ${formData.nom} ${formData.prenom}\nTicket: ${formData.ticket}\nConsultation: ${formData.motif}\nDate: ${formData.date}`;
            
            if (formData.teleconsultationType) {
                successMessage += `\n\n📞 Téléconsultation ${formData.teleconsultationType} planifiée`;
                if (formData.consultationLink) {
                    successMessage += `\nLien: ${formData.consultationLink}`;
                }
            }
            
            alert(successMessage);
            
            // Rediriger vers la liste des patients
            setTimeout(() => {
                window.location.href = 'patients.html';
            }, 2000);

        } catch (error) {
            console.error('❌ Erreur critique:', error);
            showLoading(false);
            alert('❌ Erreur lors de l\'enregistrement: ' + error.message);
        }
    }

    // Mettre à jour les statistiques
    function updateStats() {
        const stats = JSON.parse(localStorage.getItem('stats')) || {
            totalPatients: 0,
            totalConsultations: 0,
            consultationsToday: 0,
            teleconsultations: 0
        };
        
        const patients = JSON.parse(localStorage.getItem('patients')) || [];
        const consultations = JSON.parse(localStorage.getItem('consultations')) || [];
        const teleconsultations = JSON.parse(localStorage.getItem('teleconsultations')) || [];
        const today = new Date().toISOString().split('T')[0];
        
        stats.totalPatients = patients.length;
        stats.totalConsultations = consultations.length;
        stats.consultationsToday = consultations.filter(c => c.date === today).length;
        stats.teleconsultations = teleconsultations.length;
        
        localStorage.setItem('stats', JSON.stringify(stats));
    }

    // Annuler et retourner
    function cancelForm() {
        if (confirm('Voulez-vous vraiment annuler cette consultation ? Les données saisies seront perdues.')) {
            window.location.href = 'medecin_dashboard.html';
        }
    }

    function goBack() {
        window.history.back();
    }

    // Déconnexion
    document.getElementById('logout').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    });

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Vérification de sécurité
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user || user.role !== 'medecin') {
            alert('Accès non autorisé');
            window.location.href = 'index.html';
            return;
        }
        
        document.getElementById('usernameDisplay').textContent = user.username || 'Médecin';
        document.getElementById('nomMedecin').value = user.username || 'Dr. Inconnu';

        // Générer un ticket hospitalier par défaut
        generateHospitalTicket();

        // Date du jour par défaut
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;

        // Heure actuelle par défaut
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        document.getElementById('heure').value = `${hours}:${minutes}`;

        // Initialiser les listes vides
        updateAnalysesList();
        updateMedicationsList();

        // Initialiser l'ordonnance
        document.getElementById("logoImg").src = logoBase64;
        document.getElementById("signImg").src = signBase64;

        // Masquer la section téléconsultation par défaut
        document.getElementById('teleconsultationSection').style.display = 'none';

        // Debug
        debugStorage();
    });
  </script>
</body>
</html>
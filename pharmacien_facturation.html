<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pharmacien - Facturation</title>

<link rel="stylesheet" href="style1.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.statusBadge{
  padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;
}
.paid{background:#E8F5E9;color:#4CAF50;}
.unpaid{background:#FFEBEE;color:#E53935;}
</style>
</head>

<body>
<div class="container">

<!-- ‚úÖ SIDEBAR IDENTIQUE ORDONNANCES -->
<aside class="sidebar">
<div class="logo">ORDO<span>PASS</span></div>
<nav class="menu">
<a href="pharmacien_dashboard.html"><i class="fa-solid fa-prescription"></i> Ordonnances</a>
<a href="pharmacien_medecins.html"><i class="fa-solid fa-user-md"></i> M√©decins</a>
<a href="pharmacien_stock.html"><i class="fa-solid fa-boxes-stacked"></i> Gestion Stock</a>
<a href="pharmacien_facturation.html" class="active"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
<a href="pharmacien_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
<a href="pharmacien_parametres.html"><i class="fa-solid fa-gear"></i> Param√®tres</a>
<a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> D√©connexion</a>
</nav>
</aside>

<!-- ‚úÖ CONTENU -->
<main class="main">
<div class="topbar">
<div class="title">Facturation</div>
<div class="user-box">
<div>
<div id="userName"></div>
<small>Connect√©</small>
</div>
</div>
</div>

<section class="card">

<h2>Nouvelle facture</h2>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
<select id="typeDoc">
<option value="FACTURE">FACTURE</option>
<option value="PROFORMA">PROFORMA</option>
</select>

<input id="factureNumero" placeholder="N¬∞ facture"/>
<input id="clientNom" placeholder="Nom client"/>
<input id="clientTel" placeholder="T√©l√©phone"/>
<input type="date" id="factureDate"/>

<select id="modePaiement">
<option>Esp√®ces</option>
<option>Wave</option>
<option>Orange Money</option>
<option>Carte</option>
</select>

<select id="statutPaiement">
<option value="non_pay√©">Non pay√©</option>
<option value="pay√©">Pay√©</option>
</select>
</div>

<hr style="margin:20px 0">

<table class="table" id="medTable">
<thead>
<tr>
<th>M√©dicament</th>
<th>Qt√©</th>
<th>Prix</th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody></tbody>
</table>

<br>
<button class="btn btn-primary" onclick="addRow()">Ajouter</button>

<div style="text-align:right;margin-top:15px;font-weight:bold">
TOTAL : <span id="grandTotal">0</span> FCFA
</div>

<br>
<button class="btn btn-success" onclick="saveFacture()">Enregistrer</button>
<button class="btn btn-primary" onclick="generatePDF()">PDF</button>

</section>

<section class="card">
<h3>Historique factures</h3>
<div id="historyList"></div>
</section>

</main>
</div>

<script>
const user=JSON.parse(localStorage.getItem("user"));
if(!user||user.role!=="pharmacie"){
alert("Acc√®s refus√©");location.href="index.html";
}
userName.textContent=user.username;

factureDate.value=new Date().toISOString().split('T')[0];
factureNumero.value="F-"+Date.now().toString().slice(-6);

function addRow(){
const tbody=document.querySelector("#medTable tbody");
const row=document.createElement("tr");
row.innerHTML=`
<td><input></td>
<td><input type="number" value="1" onchange="calc()"></td>
<td><input type="number" value="0" onchange="calc()"></td>
<td class="rowTotal">0</td>
<td><button onclick="this.parentElement.parentElement.remove();calc()">X</button></td>
`;
tbody.appendChild(row);
}

function calc(){
let total=0;
document.querySelectorAll("#medTable tbody tr").forEach(r=>{
const q=r.children[1].querySelector("input").value;
const p=r.children[2].querySelector("input").value;
const t=q*p;
r.querySelector(".rowTotal").innerText=t;
total+=t;
});
grandTotal.innerText=total;
}

function saveFacture(){
const items=[];
document.querySelectorAll("#medTable tbody tr").forEach(r=>{
items.push({
name:r.children[0].querySelector("input").value,
q:r.children[1].querySelector("input").value,
p:r.children[2].querySelector("input").value,
t:r.querySelector(".rowTotal").innerText
});
});

const facture={
type:typeDoc.value,
numero:factureNumero.value,
client:clientNom.value,
tel:clientTel.value,
date:factureDate.value,
mode:modePaiement.value,
statut:statutPaiement.value,
total:grandTotal.innerText,
items
};

let list=JSON.parse(localStorage.getItem("factures")||"[]");
list.unshift(facture);
localStorage.setItem("factures",JSON.stringify(list));

loadHistory();
alert("Facture enregistr√©e");
}

function loadHistory(){
const list=JSON.parse(localStorage.getItem("factures")||"[]");
historyList.innerHTML="";
list.forEach(f=>{
historyList.innerHTML+=`
<div style="border:1px solid #ddd;padding:10px;margin-bottom:8px;border-radius:6px">
<b>${f.type}</b> ${f.numero} ‚Äî ${f.client} ‚Äî ${f.total} FCFA
<br>üí≥ ${f.mode}
<br><span class="statusBadge ${f.statut==="pay√©"?"paid":"unpaid"}">${f.statut}</span>
<br>
<button onclick='printSaved(${JSON.stringify(f)})'>PDF</button>
</div>`;
});
}

function generatePDF(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();

doc.setFontSize(18);
doc.text(typeDoc.value+" PHARMACIE",70,20);

doc.setFontSize(12);
doc.text("Client: "+clientNom.value,20,40);
doc.text("Tel: "+clientTel.value,20,50);
doc.text("Date: "+factureDate.value,150,40);
doc.text("N¬∞: "+factureNumero.value,150,50);
doc.text("Paiement: "+modePaiement.value,20,60);
doc.text("Statut: "+statutPaiement.value,150,60);

let y=80;
document.querySelectorAll("#medTable tbody tr").forEach(r=>{
const n=r.children[0].querySelector("input").value;
const q=r.children[1].querySelector("input").value;
const p=r.children[2].querySelector("input").value;
const t=r.querySelector(".rowTotal").innerText;
doc.text(`${n} | ${q} x ${p} = ${t}`,20,y);
y+=10;
});

y+=10;
doc.setFontSize(14);
doc.text("TOTAL: "+grandTotal.innerText+" FCFA",20,y);

doc.save(typeDoc.value+"_"+factureNumero.value+".pdf");
}

function printSaved(f){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();

doc.setFontSize(18);
doc.text(f.type+" PHARMACIE",70,20);

doc.setFontSize(12);
doc.text("Client: "+f.client,20,40);
doc.text("Tel: "+f.tel,20,50);
doc.text("Date: "+f.date,150,40);
doc.text("N¬∞: "+f.numero,150,50);
doc.text("Paiement: "+f.mode,20,60);
doc.text("Statut: "+f.statut,150,60);

let y=80;
f.items.forEach(i=>{
doc.text(`${i.name} | ${i.q} x ${i.p} = ${i.t}`,20,y);
y+=10;
});

y+=10;
doc.setFontSize(14);
doc.text("TOTAL: "+f.total+" FCFA",20,y);

doc.save(f.type+"_"+f.numero+".pdf");
}

document.getElementById("logout").onclick=()=>{
localStorage.clear();
location.href="index.html";
};

loadHistory();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pharmacien - Facturation</title>

<link rel="stylesheet" href="style1.css" />
<script src="https://kit.fontawesome.com/a2d9d5a64b.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.facture-section{
  margin-top:20px;
}

input{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  width:100%;
}

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

.table th, .table td{
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}

.table th{
  background:#0d6efd;
  color:white;
}

.btn{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.btn-primary{ background:#0d6efd;color:white; }
.btn-success{ background:#28a745;color:white; }

.total-box{
  text-align:right;
  margin-top:20px;
  font-weight:bold;
  font-size:18px;
}
</style>
</head>

<body>
<div class="container">

  <!-- ✅ SIDEBAR IDENTIQUE -->
  <aside class="sidebar">
    <div class="logo">ORDO<span>PASS</span></div>
    <nav class="menu">
      <a href="pharmacien_dashboard.html"><i class="fa-solid fa-prescription"></i> Ordonnances</a>
      <a href="pharmacien_medecins.html"><i class="fa-solid fa-user-md"></i> Médecins</a>
      <a href="pharmacien_stock.html"><i class="fa-solid fa-boxes-stacked"></i> Gestion Stock</a>
      <a href="pharmacien_facturation.html" class="active"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="pharmacien_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="pharmacien_parametres.html"><i class="fa-solid fa-gear"></i> Paramètres</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
    </nav>
  </aside>

  <!-- ✅ CONTENU -->
  <main class="main">
    <div class="topbar">
      <div class="title">Facturation Pharmacie</div>
      <div class="user-box">
        <div>
          <div id="userName">Pharmacie</div>
          <small id="userStatus">Chargement...</small>
        </div>
      </div>
    </div>

    <section class="card facture-section">

      <h2>Créer une facture</h2>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
        <input type="text" id="clientNom" placeholder="Nom du client">
        <input type="date" id="factureDate">
        <input type="text" id="clientTel" placeholder="Téléphone">
        <input type="text" id="factureNumero" placeholder="N° Facture">
      </div>

      <hr style="margin:20px 0;">

      <h3>Médicaments</h3>

      <table class="table" id="medTable">
        <thead>
          <tr>
            <th>Médicament</th>
            <th>Qté</th>
            <th>Prix</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <br>
      <button class="btn btn-primary" onclick="addRow()">
        <i class="fa fa-plus"></i> Ajouter médicament
      </button>

      <div class="total-box">
        TOTAL : <span id="grandTotal">0</span> FCFA
      </div>

      <br><br>

      <button class="btn btn-success" onclick="generatePDF()">
        <i class="fa fa-file-pdf"></i> Générer PDF
      </button>

    </section>
  </main>
</div>

<script>

const user = JSON.parse(localStorage.getItem("user"));

if (!user || user.role !== "pharmacie") {
  alert("⚠️ Accès refusé");
  location.href = "index.html";
}

document.getElementById("userName").textContent = user.username;
document.getElementById("userStatus").textContent = "Connecté";

document.getElementById("logout").addEventListener("click",()=>{
  localStorage.clear();
  location.href="index.html";
});

document.getElementById("factureDate").value =
  new Date().toISOString().split('T')[0];

function addRow(){
  const tbody=document.querySelector("#medTable tbody");
  const row=document.createElement("tr");

  row.innerHTML=`
    <td><input type="text"></td>
    <td><input type="number" value="1" onchange="calculate()"></td>
    <td><input type="number" value="0" onchange="calculate()"></td>
    <td class="rowTotal">0</td>
    <td><button onclick="this.parentElement.parentElement.remove();calculate()">X</button></td>
  `;

  tbody.appendChild(row);
}

function calculate(){
  let total=0;
  document.querySelectorAll("#medTable tbody tr").forEach(row=>{
    const q=row.children[1].querySelector("input").value;
    const p=row.children[2].querySelector("input").value;
    const t=q*p;
    row.querySelector(".rowTotal").innerText=t;
    total+=t;
  });
  document.getElementById("grandTotal").innerText=total;
}

function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("PHARMACIE ORDOPASS",70,20);

  doc.setFontSize(12);
  doc.text("Client: "+clientNom.value,20,40);
  doc.text("Téléphone: "+clientTel.value,20,50);
  doc.text("Date: "+factureDate.value,150,40);
  doc.text("Facture N°: "+factureNumero.value,150,50);

  let y=70;
  document.querySelectorAll("#medTable tbody tr").forEach(row=>{
    const name=row.children[0].querySelector("input").value;
    const q=row.children[1].querySelector("input").value;
    const p=row.children[2].querySelector("input").value;
    const t=row.querySelector(".rowTotal").innerText;

    doc.text(`${name} | ${q} x ${p} = ${t}`,20,y);
    y+=10;
  });

  y+=10;
  doc.setFontSize(14);
  doc.text("TOTAL: "+grandTotal.innerText+" FCFA",20,y);

  doc.save("facture_pharmacie.pdf");
}

</script>

</body>
</html>

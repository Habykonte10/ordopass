<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pharmacien - Facturation</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">

<link rel="stylesheet" href="style1.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* Vos styles existants (inchang√©s) */
  body {
    background: #f4f7fb;
    font-family: 'Inter', 'Segoe UI', sans-serif;
  }
  .container { background: transparent; }
  .card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 25px;
    border: none;
    transition: transform 0.2s;
  }
  .card:hover { box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
  h2, h3 {
    color: #1a2b4c;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h2 i, h3 i { color: #2a5298; font-size: 1.5rem; }
  [style*="display:grid"] {
    background: #f9fafc;
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 15px;
  }
  select, input {
    border: 2px solid #eef2f6;
    border-radius: 12px;
    padding: 12px 15px;
    font-size: 14px;
    transition: all 0.2s;
    background: white;
  }
  select:focus, input:focus {
    border-color: #2a5298;
    outline: none;
    box-shadow: 0 0 0 4px rgba(42,82,152,0.1);
  }
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
  }
  .table thead th {
    background: #f0f4fa;
    color: #1e293b;
    font-weight: 600;
    padding: 12px;
    border-radius: 12px;
  }
  .table tbody tr {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.02);
  }
  .table tbody td {
    padding: 12px;
    border: none;
  }
  .table tbody td input {
    width: 100%;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
  }
  .table tbody td button {
    background: #fee2e2;
    color: #b91c1c;
    border: none;
    border-radius: 10px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
  }
  .table tbody td button:hover {
    background: #fecaca;
    transform: scale(1.05);
  }
  .rowTotal { font-weight: 600; color: #1e293b; }
  .btn {
    border: none;
    border-radius: 40px;
    padding: 12px 25px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .btn-primary {
    background: linear-gradient(145deg, #2a5298, #1e3a6b);
    color: white;
  }
  .btn-primary:hover {
    background: #1e3c72;
    transform: translateY(-2px);
  }
  .btn-success {
    background: #10b981;
    color: white;
  }
  .btn-success:hover {
    background: #0e9f6e;
    transform: translateY(-2px);
  }
  #grandTotal {
    font-size: 1.4rem;
    color: #2a5298;
    font-weight: 700;
  }

  /* Historique des factures - avec deux boutons */
  #historyList > div {
    background: white;
    border: none !important;
    border-radius: 20px !important;
    padding: 18px 22px !important;
    margin-bottom: 15px !important;
    box-shadow: 0 5px 20px rgba(0,0,0,0.03);
    transition: all 0.2s;
    border-left: 5px solid #2a5298 !important;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
  }
  #historyList > div:hover {
    transform: translateX(5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  }
  #historyList > div b { font-size: 1.1rem; color: #1e293b; }
  #historyList > div br { display: none; }
  #historyList > div > *:not(button) { margin-right: 20px; }
  #historyList > div .btn-icon {
    background: #2a5298;
    color: white;
    border: none;
    border-radius: 30px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-left: 5px;
  }
  #historyList > div .btn-icon:hover { background: #1e3c72; }
  #historyList > div .btn-icon i { font-size: 12px; }

  .statusBadge {
    padding: 6px 14px !important;
    border-radius: 40px !important;
    font-weight: 600;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .paid {
    background: #d1fae5 !important;
    color: #065f46 !important;
  }
  .paid::before {
    font-family: "Font Awesome 6 Free";
    content: "\f00c";
    font-weight: 900;
  }
  .unpaid {
    background: #fee2e2 !important;
    color: #b91c1c !important;
  }
  .unpaid::before {
    font-family: "Font Awesome 6 Free";
    content: "\f00d";
    font-weight: 900;
  }

  @media (max-width: 700px) {
    [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
    #historyList > div { flex-direction: column; align-items: flex-start; gap: 10px; }
  }
</style>
</head>

<body>
<div class="container">

<aside class="sidebar">
<div class="logo">ORDO<span>PASS</span></div>
<nav class="menu">
<a href="pharmacien_dashboard.html"><i class="fa-solid fa-prescription"></i> Ordonnances</a>
<a href="pharmacien_medecins.html"><i class="fa-solid fa-user-md"></i> M√©decins</a>
<a href="pharmacien_stock.html"><i class="fa-solid fa-boxes-stacked"></i> Gestion Stock</a>
<a href="pharmacien_facturation.html" class="active"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
<a href="pharmacien_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
<a href="pharmacien_parametres.html"><i class="fa-solid fa-gear"></i> Param√®tres</a>
<a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> D√©connexion</a>
</nav>
</aside>

<main class="main">
<div class="topbar">
<div class="title">Facturation</div>
<div class="user-box">
<div>
<div id="userName"></div>
<small>Connect√©</small>
</div>
</div>
</div>

<section class="card">
<h2><i class="fa-solid fa-file-invoice"></i> Nouvelle facture</h2>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
<select id="typeDoc">
<option value="FACTURE">FACTURE</option>
<option value="PROFORMA">PROFORMA</option>
</select>
<input id="factureNumero" placeholder="N¬∞ facture"/>
<input id="clientNom" placeholder="Nom client"/>
<input id="clientTel" placeholder="T√©l√©phone"/>
<input type="date" id="factureDate"/>
<select id="modePaiement">
<option>Esp√®ces</option>
<option>Wave</option>
<option>Orange Money</option>
<option>Carte</option>
</select>
<select id="statutPaiement">
<option value="non_pay√©">Non pay√©</option>
<option value="pay√©">Pay√©</option>
</select>
</div>

<hr style="margin:20px 0; border:1px solid #eef2f6;">

<table class="table" id="medTable">
<thead>
<tr><th>M√©dicament</th><th>Qt√©</th><th>Prix</th><th>Total</th><th></th></tr>
</thead>
<tbody></tbody>
</table>

<br>
<button class="btn btn-primary" onclick="addRow()"><i class="fa-solid fa-plus"></i> Ajouter</button>

<div style="text-align:right;margin-top:15px;font-weight:bold">
TOTAL : <span id="grandTotal">0</span> FCFA
</div>

<br>
<button class="btn btn-success" onclick="saveFacture()"><i class="fa-solid fa-save"></i> Enregistrer</button>
<button class="btn btn-primary" onclick="generatePDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
</section>

<section class="card">
<h3><i class="fa-solid fa-clock-rotate-left"></i> Historique factures</h3>
<div id="historyList"></div>
</section>

</main>
</div>

<script>
// Donn√©es utilisateur
const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.role !== "pharmacie") {
  alert("Acc√®s refus√©");
  location.href = "index.html";
}
document.getElementById("userName").textContent = user.username;

// Initialisation date et num√©ro
document.getElementById("factureDate").value = new Date().toISOString().split('T')[0];
document.getElementById("factureNumero").value = "F-" + Date.now().toString().slice(-6);

// Fonctions existantes
function addRow() {
  const tbody = document.querySelector("#medTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input></td>
    <td><input type="number" value="1" onchange="calc()"></td>
    <td><input type="number" value="0" onchange="calc()"></td>
    <td class="rowTotal">0</td>
    <td><button onclick="this.parentElement.parentElement.remove();calc()">X</button></td>
  `;
  tbody.appendChild(row);
}

function calc() {
  let total = 0;
  document.querySelectorAll("#medTable tbody tr").forEach(r => {
    const q = r.children[1].querySelector("input").value;
    const p = r.children[2].querySelector("input").value;
    const t = q * p;
    r.querySelector(".rowTotal").innerText = t;
    total += t;
  });
  document.getElementById("grandTotal").innerText = total;
}

function saveFacture() {
  const items = [];
  document.querySelectorAll("#medTable tbody tr").forEach(r => {
    items.push({
      name: r.children[0].querySelector("input").value,
      q: r.children[1].querySelector("input").value,
      p: r.children[2].querySelector("input").value,
      t: r.querySelector(".rowTotal").innerText
    });
  });

  const facture = {
    type: document.getElementById("typeDoc").value,
    numero: document.getElementById("factureNumero").value,
    client: document.getElementById("clientNom").value,
    tel: document.getElementById("clientTel").value,
    date: document.getElementById("factureDate").value,
    mode: document.getElementById("modePaiement").value,
    statut: document.getElementById("statutPaiement").value,
    total: document.getElementById("grandTotal").innerText,
    items
  };

  let list = JSON.parse(localStorage.getItem("factures") || "[]");
  list.unshift(facture);
  localStorage.setItem("factures", JSON.stringify(list));

  loadHistory();
  alert("Facture enregistr√©e");
}

function loadHistory() {
  const list = JSON.parse(localStorage.getItem("factures") || "[]");
  const historyDiv = document.getElementById("historyList");
  historyDiv.innerHTML = "";
  list.forEach(f => {
    const escaped = JSON.stringify(f).replace(/'/g, "\\'");
    historyDiv.innerHTML += `
      <div>
        <b><i class="fa-solid fa-file-invoice"></i> ${f.type}</b> ${f.numero} ‚Äî ${f.client} ‚Äî <strong>${f.total} FCFA</strong>
        <span>üí≥ ${f.mode}</span>
        <span class="statusBadge ${f.statut === "pay√©" ? "paid" : "unpaid"}">${f.statut}</span>
        <div>
          <button class="btn-icon" onclick='viewPDF(${escaped})'><i class="fa-solid fa-eye"></i> Voir</button>
          <button class="btn-icon" onclick='downloadPDF(${escaped})'><i class="fa-solid fa-download"></i> PDF</button>
        </div>
      </div>
    `;
  });
}

// ========== FONCTIONS PDF AM√âLIOR√âES ==========
function generatePDF() {
  const facture = {
    type: document.getElementById("typeDoc").value,
    numero: document.getElementById("factureNumero").value,
    client: document.getElementById("clientNom").value,
    tel: document.getElementById("clientTel").value,
    date: document.getElementById("factureDate").value,
    mode: document.getElementById("modePaiement").value,
    statut: document.getElementById("statutPaiement").value,
    total: document.getElementById("grandTotal").innerText,
    items: []
  };
  document.querySelectorAll("#medTable tbody tr").forEach(r => {
    facture.items.push({
      name: r.children[0].querySelector("input").value,
      q: r.children[1].querySelector("input").value,
      p: r.children[2].querySelector("input").value,
      t: r.querySelector(".rowTotal").innerText
    });
  });
  createStyledPDF(facture, true); // true = download
}

function downloadPDF(facture) {
  createStyledPDF(facture, true);
}

function viewPDF(facture) {
  createStyledPDF(facture, false); // false = open in new tab
}

function createStyledPDF(f, download = true) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  // Couleurs
  const primaryColor = [42, 82, 152]; // #2a5298
  const lightGray = [240, 240, 240];
  const darkGray = [80, 80, 80];

  // En-t√™te
  doc.setFillColor(...primaryColor);
  doc.rect(0, 0, 210, 30, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(22);
  doc.setFont("helvetica", "bold");
  doc.text("ORDO PASS PHARMACIE", 105, 18, { align: 'center' });
  
  // Sous-titre
  doc.setFontSize(14);
  doc.setFont("helvetica", "normal");
  doc.text(f.type, 105, 26, { align: 'center' });

  // Informations facture
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.setFont("helvetica", "bold");
  doc.text("N¬∞ Facture :", 20, 45);
  doc.text("Date :", 20, 52);
  doc.text("Client :", 20, 59);
  doc.text("T√©l√©phone :", 20, 66);
  doc.setFont("helvetica", "normal");
  doc.text(f.numero, 60, 45);
  doc.text(f.date, 60, 52);
  doc.text(f.client, 60, 59);
  doc.text(f.tel, 60, 66);

  doc.setFont("helvetica", "bold");
  doc.text("Mode de paiement :", 130, 45);
  doc.text("Statut :", 130, 52);
  doc.setFont("helvetica", "normal");
  doc.text(f.mode, 170, 45);
  doc.text(f.statut, 170, 52);

  // Ligne de s√©paration
  doc.setDrawColor(...primaryColor);
  doc.setLineWidth(0.5);
  doc.line(20, 75, 190, 75);

  // En-t√™te du tableau
  let y = 85;
  doc.setFillColor(...lightGray);
  doc.rect(20, y-5, 170, 8, 'F');
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text("D√©signation", 22, y);
  doc.text("Qt√©", 100, y);
  doc.text("Prix unit.", 120, y);
  doc.text("Total", 160, y);
  y += 8;

  // Lignes du tableau
  doc.setFont("helvetica", "normal");
  let total = 0;
  f.items.forEach(item => {
    if (item.name) {
      doc.text(item.name.substring(0, 30), 22, y);
      doc.text(item.q.toString(), 102, y);
      doc.text(item.p.toString(), 122, y);
      doc.text(item.t.toString(), 162, y);
      y += 7;
      total += parseFloat(item.t) || 0;
    }
  });

  // Total
  y += 5;
  doc.setDrawColor(...primaryColor);
  doc.setLineWidth(0.3);
  doc.line(120, y-2, 190, y-2);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("TOTAL : " + total + " FCFA", 150, y+5);

  // Pied de page
  doc.setFontSize(9);
  doc.setTextColor(...darkGray);
  doc.text("Merci de votre confiance !", 105, 280, { align: 'center' });
  doc.text("ORDO PASS - Votre sant√©, notre priorit√©", 105, 285, { align: 'center' });

  if (download) {
    doc.save(f.type + "_" + f.numero + ".pdf");
  } else {
    doc.output('dataurlnewwindow'); // Ouvre dans un nouvel onglet
  }
}

// D√©connexion
document.getElementById("logout").onclick = () => {
  localStorage.clear();
  location.href = "index.html";
};

// Charger l'historique au d√©marrage
loadHistory();
</script>
</body>
</html>
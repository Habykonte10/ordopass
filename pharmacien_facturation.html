<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Système Intégré Pharmacie RDC</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #006b3f, #009245);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(30%, -30%);
    }
    
    .header-content {
      position: relative;
      z-index: 1;
    }
    
    .header-content h1 {
      margin-bottom: 10px;
      font-size: 2.5em;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-content p {
      font-size: 1.1em;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    
    .user-info {
      position: absolute;
      top: 30px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 25px;
      backdrop-filter: blur(10px);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      color: #006b3f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    .system-switcher {
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-top: 20px;
      max-width: 600px;
    }
    
    .system-btn {
      padding: 12px 25px;
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .system-btn.active {
      background: white;
      color: #006b3f;
      border-color: white;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }
    
    .system-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }
    
    /* Navigation */
    .main-nav {
      background: white;
      padding: 15px 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      display: flex;
      gap: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      flex-wrap: wrap;
    }
    
    .nav-btn {
      padding: 12px 25px;
      border: none;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      color: #333;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .nav-btn:hover {
      background: #006b3f;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,107,63,0.2);
    }
    
    .nav-btn.active {
      background: #006b3f;
      color: white;
      box-shadow: 0 4px 12px rgba(0,107,63,0.3);
    }
    
    .notification-badge {
      background: #dc3545;
      color: white;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 5px;
      min-width: 20px;
      text-align: center;
    }
    
    /* Main Content */
    .main-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .main-content.active {
      display: block;
    }
    
    /* Dashboard */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .dashboard-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .dashboard-card h3 {
      color: #006b3f;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .stat-icon.total { background: #e3f2fd; color: #1976d2; }
    .stat-icon.payees { background: #e8f5e9; color: #2e7d32; }
    .stat-icon.en-cours { background: #fff3e0; color: #f57c00; }
    .stat-icon.montant { background: #f3e5f5; color: #7b1fa2; }
    .stat-icon.ordonnances { background: #e1f5fe; color: #0288d1; }
    .stat-icon.medicaments { background: #f3e5f5; color: #7b1fa2; }
    .stat-icon.envoyee { background: #fff3cd; color: #856404; }
    .stat-icon.delivree { background: #d1ecf1; color: #0c5460; }
    
    .stat-info h3 {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    .stat-info p {
      color: #666;
      font-size: 0.9em;
    }
    
    /* Actions Bar */
    .actions-bar {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .search-box {
      flex: 1;
      min-width: 300px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 20px 12px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #006b3f;
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      min-width: 150px;
    }
    
    /* Tables */
    .table-container {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    
    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h3 {
      color: #006b3f;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .table-actions {
      display: flex;
      gap: 10px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table thead {
      background: #f8f9fa;
    }
    
    .data-table th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .data-table tbody tr {
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    
    .data-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .data-table td {
      padding: 18px 20px;
      vertical-align: middle;
    }
    
    .facture-num, .ordonnance-num {
      font-weight: bold;
      color: #006b3f;
    }
    
    .client-info, .patient-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .client-name, .patient-name {
      font-weight: 500;
    }
    
    .client-phone, .patient-phone {
      font-size: 0.9em;
      color: #666;
    }
    
    .montant {
      font-weight: bold;
      font-size: 1.1em;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-payee { background: #d4edda; color: #155724; }
    .status-en_attente { background: #fff3cd; color: #856404; }
    .status-en_retard { background: #f8d7da; color: #721c24; }
    .status-brouillon { background: #e2e3e5; color: #383d41; }
    .status-annulee { background: #f8d7da; color: #721c24; }
    
    .status-envoye, .status-envoyee { background: #fff3cd; color: #856404; }
    .status-en_cours { background: #cce5ff; color: #004085; }
    .status-pret { background: #d4edda; color: #155724; }
    .status-delivree { background: #d1ecf1; color: #0c5460; }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn-icon.view { background: #e3f2fd; color: #1976d2; }
    .btn-icon.edit { background: #fff3e0; color: #f57c00; }
    .btn-icon.print { background: #e8f5e9; color: #2e7d32; }
    .btn-icon.delete { background: #f8d7da; color: #dc3545; }
    .btn-icon.link { background: #e1f5fe; color: #0288d1; }
    .btn-icon.sync { background: #e1f5fe; color: #17a2b8; }
    
    .btn-icon:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }
    
    /* Prescription Details Styles (from first system) */
    .prescription-details {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      animation: fadeIn 0.5s ease;
    }
    
    .prescription-header {
      background: linear-gradient(135deg, #2a5298, #3498db);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }
    
    .prescription-header h1 {
      margin-bottom: 10px;
      font-size: 2em;
    }
    
    .status-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .prescription-content {
      padding: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .section:last-child {
      border-bottom: none;
    }
    
    .section h3 {
      color: #2a5298;
      margin-bottom: 15px;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .info-item {
      padding: 10px 0;
    }
    
    .info-item strong {
      color: #555;
      margin-bottom: 5px;
      display: block;
      font-size: 0.9em;
    }
    
    .info-item span {
      font-size: 1.1em;
      color: #333;
      font-weight: 500;
    }
    
    .medicament-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #3498db;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .medicament-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .medicament-header h4 {
      color: #2a5298;
      font-size: 1.2em;
      margin: 0;
    }
    
    .medicament-number {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .medicament-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }
    
    .medicament-remarque {
      margin-top: 10px;
      padding: 10px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .instructions {
      background: #e8f4fd;
      padding: 20px;
      border-radius: 8px;
      font-size: 1em;
      line-height: 1.6;
    }
    
    /* Facture Section */
    .facture-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
      border: 2px solid #dee2e6;
    }
    
    .facture-header {
      background: #2a5298;
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .facture-content {
      background: white;
      padding: 25px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .facture-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .facture-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #28a745;
    }
    
    .facture-table-container {
      overflow-x: auto;
      margin: 25px 0;
    }
    
    .facture-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .facture-table th {
      background: #2a5298;
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }
    
    .facture-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }
    
    .facture-table tr:hover {
      background-color: #f8f9fa;
    }
    
    .total-row {
      background: #f8f9fa !important;
      font-weight: bold;
      font-size: 1.1em;
    }
    
    .total-row td {
      padding: 15px;
      border-top: 2px solid #2a5298;
    }
    
    .linked-info {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #28a745;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .code-badge {
      background: #2a5298;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-family: monospace;
      font-weight: bold;
      font-size: 1.1em;
      letter-spacing: 1px;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 25px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #006b3f;
      color: white;
    }
    
    .btn-primary:hover {
      background: #00532f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,107,63,0.3);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    
    .btn-warning:hover {
      background: #e68900;
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }
    
    .btn-outline {
      background: white;
      border: 2px solid #006b3f;
      color: #006b3f;
    }
    
    .btn-outline:hover {
      background: #006b3f;
      color: white;
      transform: translateY(-2px);
    }
    
    .btn-sm {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #006b3f;
    }
    
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      padding: 25px 30px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      color: #006b3f;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      background: #f5f5f5;
      border-radius: 50%;
    }
    
    .modal-content {
      padding: 30px;
    }
    
    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state i {
      font-size: 64px;
      color: #ccc;
      margin-bottom: 20px;
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }
    
    .loading i {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    /* Error State */
    .error-message {
      text-align: center;
      padding: 40px;
      background: #f8d7da;
      border-radius: 8px;
      color: #721c24;
      border-left: 4px solid #f5c6cb;
    }
    
    /* Pagination */
    .pagination {
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #eee;
    }
    
    .pagination-info {
      color: #666;
      font-size: 0.9em;
    }
    
    .pagination-controls {
      display: flex;
      gap: 10px;
    }
    
    .pagination-btn {
      padding: 8px 15px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pagination-btn:hover:not(:disabled) {
      background: #f8f9fa;
      border-color: #006b3f;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .page-numbers {
      display: flex;
      gap: 5px;
    }
    
    .page-number {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .page-number.active {
      background: #006b3f;
      color: white;
      border-color: #006b3f;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .main-nav {
        overflow-x: auto;
        padding: 15px;
      }
      
      .nav-btn {
        white-space: nowrap;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        text-align: center;
      }
      
      .user-info {
        position: relative;
        top: 0;
        right: 0;
        justify-content: center;
        margin-top: 20px;
      }
      
      .system-switcher {
        flex-direction: column;
      }
      
      .actions-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: 100%;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .data-table {
        display: block;
        overflow-x: auto;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .action-buttons {
        justify-content: center;
      }
      
      .modal {
        max-height: 95vh;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1><i class="fas fa-clinic-medical"></i> Pharmacie RDC - Système Intégré</h1>
        <p>Gestion complète des ordonnances et factures - Synchronisation automatique</p>
        
        <div class="system-switcher">
          <button class="system-btn active" data-system="dashboard">
            <i class="fas fa-tachometer-alt"></i> Tableau de bord
          </button>
          <button class="system-btn" data-system="factures">
            <i class="fas fa-file-invoice-dollar"></i> Factures
          </button>
          <button class="system-btn" data-system="ordonnances">
            <i class="fas fa-prescription"></i> Ordonnances
          </button>
          <button class="system-btn" data-system="details">
            <i class="fas fa-search"></i> Détails Ordonnance
          </button>
        </div>
      </div>
      
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">PR</div>
        <div>
          <div style="font-weight: bold;" id="userName">Pharmacien</div>
          <div style="font-size: 0.9em; opacity: 0.9;" id="userRole">Administrateur</div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="main-nav" id="mainNav">
      <!-- Les boutons de navigation seront chargés dynamiquement -->
    </div>

    <!-- Dashboard Content -->
    <div class="main-content active" id="dashboardContent">
      <div class="stats-container" id="dashboardStats">
        <!-- Les stats seront chargées dynamiquement -->
      </div>
      
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3><i class="fas fa-chart-line"></i> Activité récente</h3>
          <div id="recentActivity">
            <!-- Activité récente -->
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-exclamation-circle"></i> Alertes importantes</h3>
          <div id="alertsContainer">
            <!-- Alertes -->
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3><i class="fas fa-bolt"></i> Actions rapides</h3>
          <div class="quick-actions" style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-outline" id="quickNewFacture">
              <i class="fas fa-plus-circle"></i> Nouvelle facture
            </button>
            <button class="btn btn-outline" id="quickImportOrdonnance">
              <i class="fas fa-prescription"></i> Importer ordonnance
            </button>
            <button class="btn btn-outline" id="quickViewStock">
              <i class="fas fa-boxes"></i> Vérifier stock
            </button>
            <button class="btn btn-outline" id="quickGenerateReport">
              <i class="fas fa-chart-bar"></i> Rapport journalier
            </button>
            <button class="btn btn-info" id="quickSyncData">
              <i class="fas fa-sync-alt"></i> Synchroniser données
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Factures Content -->
    <div class="main-content" id="facturesContent">
      <!-- Actions Bar -->
      <div class="actions-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchFactures" placeholder="Rechercher une facture...">
        </div>
        <div class="filter-group">
          <select class="filter-select" id="statusFilterFactures">
            <option value="">Tous les statuts</option>
            <option value="payee">Payée</option>
            <option value="en_attente">En attente</option>
            <option value="en_retard">En retard</option>
            <option value="brouillon">Brouillon</option>
          </select>
          <select class="filter-select" id="dateFilterFactures">
            <option value="">Toutes les dates</option>
            <option value="today">Aujourd'hui</option>
            <option value="week">Cette semaine</option>
            <option value="month">Ce mois</option>
          </select>
          <button class="btn btn-primary" id="newFactureBtn">
            <i class="fas fa-plus"></i> Nouvelle facture
          </button>
          <button class="btn btn-outline" id="importOrdonnanceBtn">
            <i class="fas fa-file-import"></i> Importer ordonnance
          </button>
        </div>
      </div>

      <!-- Factures Table -->
      <div class="table-container">
        <div class="table-header">
          <h3><i class="fas fa-file-invoice"></i> Liste des Factures</h3>
          <div class="table-actions">
            <button class="btn btn-outline" id="exportFacturesBtn">
              <i class="fas fa-download"></i> Exporter
            </button>
            <button class="btn btn-outline" id="refreshFacturesBtn">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <table class="data-table" id="facturesTable">
          <thead>
            <tr>
              <th width="50"><input type="checkbox" id="selectAllFactures"></th>
              <th>N° Facture</th>
              <th>Client</th>
              <th>Date</th>
              <th>Montant</th>
              <th>Statut</th>
              <th>Ordonnance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="facturesTableBody">
            <!-- Les factures seront chargées ici -->
          </tbody>
        </table>

        <div class="pagination">
          <div class="pagination-info" id="facturesPaginationInfo">
            Affichage de 1 à 10 sur 0 factures
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="prevPageFactures">
              <i class="fas fa-chevron-left"></i> Précédent
            </button>
            <div class="page-numbers" id="pageNumbersFactures"></div>
            <button class="pagination-btn" id="nextPageFactures">
              Suivant <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ordonnances Content -->
    <div class="main-content" id="ordonnancesContent">
      <!-- Actions Bar -->
      <div class="actions-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchOrdonnances" placeholder="Rechercher une ordonnance...">
        </div>
        <div class="filter-group">
          <select class="filter-select" id="statusFilterOrdonnances">
            <option value="">Tous les statuts</option>
            <option value="envoyee">À traiter</option>
            <option value="en_cours">En cours</option>
            <option value="pret">Prête</option>
            <option value="delivree">Délivrée</option>
          </select>
          <select class="filter-select" id="dateFilterOrdonnances">
            <option value="">Toutes les dates</option>
            <option value="today">Aujourd'hui</option>
            <option value="week">Cette semaine</option>
            <option value="month">Ce mois</option>
          </select>
          <button class="btn btn-primary" id="newOrdonnanceBtn">
            <i class="fas fa-plus"></i> Nouvelle ordonnance
          </button>
          <button class="btn btn-outline" id="scanOrdonnanceBtn">
            <i class="fas fa-camera"></i> Scanner QR Code
          </button>
        </div>
      </div>

      <!-- Ordonnances Table -->
      <div class="table-container">
        <div class="table-header">
          <h3><i class="fas fa-prescription"></i> Liste des Ordonnances</h3>
          <div class="table-actions">
            <button class="btn btn-outline" id="exportOrdonnancesBtn">
              <i class="fas fa-download"></i> Exporter
            </button>
            <button class="btn btn-outline" id="refreshOrdonnancesBtn">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <table class="data-table" id="ordonnancesTable">
          <thead>
            <tr>
              <th width="50"><input type="checkbox" id="selectAllOrdonnances"></th>
              <th>Code</th>
              <th>Patient</th>
              <th>Médecin</th>
              <th>Date</th>
              <th>Statut</th>
              <th>Facture</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordonnancesTableBody">
            <!-- Les ordonnances seront chargées ici -->
          </tbody>
        </table>

        <div class="pagination">
          <div class="pagination-info" id="ordonnancesPaginationInfo">
            Affichage de 1 à 10 sur 0 ordonnances
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="prevPageOrdonnances">
              <i class="fas fa-chevron-left"></i> Précédent
            </button>
            <div class="page-numbers" id="pageNumbersOrdonnances"></div>
            <button class="pagination-btn" id="nextPageOrdonnances">
              Suivant <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Ordonnance Content -->
    <div class="main-content" id="detailsContent">
      <div id="detailsLoadingState" class="loading">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top: 20px; font-size: 1.1em;">Chargement du système de détails...</p>
      </div>
      
      <div id="detailsContainer" style="display: none;">
        <!-- Le contenu des détails sera chargé dynamiquement -->
      </div>
    </div>

    <!-- Modal pour créer/modifier une facture -->
    <div class="modal-overlay" id="factureModal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalFactureTitle"><i class="fas fa-file-invoice-dollar"></i> Nouvelle Facture</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
          <form id="factureForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="numeroFacture">N° Facture *</label>
                <input type="text" class="form-control" id="numeroFacture" required>
              </div>
              <div class="form-group">
                <label for="dateFacturation">Date de facturation *</label>
                <input type="date" class="form-control" id="dateFacturation" required>
              </div>
              <div class="form-group">
                <label for="clientNom">Nom du client *</label>
                <input type="text" class="form-control" id="clientNom" required>
              </div>
              <div class="form-group">
                <label for="clientTelephone">Téléphone client</label>
                <input type="tel" class="form-control" id="clientTelephone">
              </div>
              <div class="form-group">
                <label for="clientEmail">Email client</label>
                <input type="email" class="form-control" id="clientEmail">
              </div>
              <div class="form-group">
                <label for="clientAdresse">Adresse client</label>
                <textarea class="form-control" id="clientAdresse" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label for="ordonnanceCode">Code Ordonnance</label>
                <div style="display: flex; gap: 10px;">
                  <input type="text" class="form-control" id="ordonnanceCode" style="flex: 1;">
                  <button type="button" class="btn btn-outline btn-sm" id="linkOrdonnanceBtn">
                    <i class="fas fa-link"></i> Lier
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label for="statutFacture">Statut *</label>
                <select class="form-control" id="statutFacture" required>
                  <option value="brouillon">Brouillon</option>
                  <option value="en_attente">En attente</option>
                  <option value="payee">Payée</option>
                  <option value="en_retard">En retard</option>
                  <option value="annulee">Annulée</option>
                </select>
              </div>
              <div class="form-group">
                <label for="methodePaiement">Méthode de paiement</label>
                <select class="form-control" id="methodePaiement">
                  <option value="">Non spécifié</option>
                  <option value="especes">Espèces</option>
                  <option value="carte">Carte bancaire</option>
                  <option value="cheque">Chèque</option>
                  <option value="virement">Virement</option>
                  <option value="assurance">Assurance</option>
                  <option value="mobile_money">Mobile Money</option>
                </select>
              </div>
              <div class="form-group">
                <label for="dateLimitePaiement">Date limite de paiement</label>
                <input type="date" class="form-control" id="dateLimitePaiement">
              </div>
              <div class="form-group">
                <label for="remarquesFacture">Remarques</label>
                <textarea class="form-control" id="remarquesFacture" rows="3"></textarea>
              </div>
            </div>

            <!-- Section Médicaments -->
            <h4 style="margin: 30px 0 20px; color: #006b3f;">
              <i class="fas fa-pills"></i> Médicaments
            </h4>
            <div id="medicamentsContainer">
              <!-- Les lignes de médicaments seront ajoutées ici dynamiquement -->
            </div>

            <button type="button" class="btn btn-outline" id="addMedicamentBtn" style="margin-bottom: 30px;">
              <i class="fas fa-plus"></i> Ajouter un médicament
            </button>

            <!-- Calculs -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px;">
              <div style="display: flex; justify-content: flex-end;">
                <div style="min-width: 300px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Sous-total:</span>
                    <span id="sousTotal">0 FCF</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>TVA (16%):</span>
                    <span id="tva">0 FCF</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Remise:</span>
                    <div>
                      <input type="number" id="remise" min="0" step="100" value="0" 
                             style="width: 100px; text-align: right; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"> FCF
                    </div>
                  </div>
                  <hr style="margin: 15px 0;">
                  <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em;">
                    <span>TOTAL:</span>
                    <span id="total">0 FCF</span>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelFactureBtn">Annuler</button>
          <button class="btn btn-success" id="saveFactureBtn">
            <i class="fas fa-save"></i> Enregistrer
          </button>
          <button class="btn btn-primary" id="printFactureBtn" style="display: none;">
            <i class="fas fa-print"></i> Imprimer
          </button>
        </div>
      </div>
    </div>

    <!-- Modal pour créer/modifier une ordonnance -->
    <div class="modal-overlay" id="ordonnanceModal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modalOrdonnanceTitle"><i class="fas fa-prescription"></i> Nouvelle Ordonnance</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
          <form id="ordonnanceForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="codeOrdonnance">Code Ordonnance *</label>
                <input type="text" class="form-control" id="codeOrdonnance" required>
              </div>
              <div class="form-group">
                <label for="dateOrdonnance">Date de prescription *</label>
                <input type="date" class="form-control" id="dateOrdonnance" required>
              </div>
              <div class="form-group">
                <label for="patientNom">Nom du patient *</label>
                <input type="text" class="form-control" id="patientNom" required>
              </div>
              <div class="form-group">
                <label for="patientAge">Âge</label>
                <input type="number" class="form-control" id="patientAge" min="0" max="120">
              </div>
              <div class="form-group">
                <label for="patientGenre">Genre</label>
                <select class="form-control" id="patientGenre">
                  <option value="">Non spécifié</option>
                  <option value="M">Masculin</option>
                  <option value="F">Féminin</option>
                </select>
              </div>
              <div class="form-group">
                <label for="patientTelephone">Téléphone patient</label>
                <input type="tel" class="form-control" id="patientTelephone">
              </div>
              <div class="form-group">
                <label for="patientAdresse">Adresse patient</label>
                <textarea class="form-control" id="patientAdresse" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label for="medecinNom">Nom du médecin *</label>
                <input type="text" class="form-control" id="medecinNom" required>
              </div>
              <div class="form-group">
                <label for="medecinSpecialite">Spécialité</label>
                <input type="text" class="form-control" id="medecinSpecialite">
              </div>
              <div class="form-group">
                <label for="statutOrdonnance">Statut *</label>
                <select class="form-control" id="statutOrdonnance" required>
                  <option value="envoyee">À traiter</option>
                  <option value="en_cours">En cours</option>
                  <option value="pret">Prête</option>
                  <option value="delivree">Délivrée</option>
                  <option value="annulee">Annulée</option>
                </select>
              </div>
              <div class="form-group">
                <label for="instructions">Instructions</label>
                <textarea class="form-control" id="instructions" rows="3"></textarea>
              </div>
            </div>

            <!-- Section Médicaments -->
            <h4 style="margin: 30px 0 20px; color: #006b3f;">
              <i class="fas fa-pills"></i> Médicaments Prescrits
            </h4>
            <div id="ordonnanceMedicamentsContainer">
              <!-- Les lignes de médicaments seront ajoutées ici dynamiquement -->
            </div>

            <button type="button" class="btn btn-outline" id="addOrdonnanceMedicamentBtn" style="margin-bottom: 30px;">
              <i class="fas fa-plus"></i> Ajouter un médicament
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelOrdonnanceBtn">Annuler</button>
          <button class="btn btn-success" id="saveOrdonnanceBtn">
            <i class="fas fa-save"></i> Enregistrer
          </button>
          <button class="btn btn-primary" id="createFactureFromOrdonnanceBtn" style="display: none;">
            <i class="fas fa-file-invoice-dollar"></i> Créer facture
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmation -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <h3>Confirmation</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
          <p id="confirmMessage">Êtes-vous sûr de vouloir effectuer cette action ?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelConfirmBtn">Annuler</button>
          <button class="btn btn-danger" id="confirmActionBtn">Confirmer</button>
        </div>
      </div>
    </div>

    <!-- Modal d'importation d'ordonnance -->
    <div class="modal-overlay" id="importOrdonnanceModal">
      <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
          <h3><i class="fas fa-file-import"></i> Importer une ordonnance</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
          <div class="form-group">
            <label>Sélectionner une ordonnance à importer</label>
            <select class="form-control" id="selectOrdonnanceImport">
              <option value="">Choisir une ordonnance...</option>
              <!-- Les ordonnances seront chargées dynamiquement -->
            </select>
          </div>
          
          <div id="ordonnanceImportPreview" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;">
            <!-- Aperçu de l'ordonnance -->
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <label>Options d'importation</label>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="importPatientInfo" checked>
                <span>Importer les informations du patient</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="importMedicaments" checked>
                <span>Importer les médicaments</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="autoCalculatePrices" checked>
                <span>Calculer automatiquement les prix</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelImportBtn">Annuler</button>
          <button class="btn btn-primary" id="confirmImportBtn">Importer</button>
        </div>
      </div>
    </div>

    <!-- Modal de synchronisation -->
    <div class="modal-overlay" id="syncModal">
      <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
          <h3><i class="fas fa-sync-alt"></i> Synchronisation des données</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
          <div id="syncProgress" style="text-align: center;">
            <i class="fas fa-sync fa-spin fa-3x" style="color: #006b3f; margin-bottom: 20px;"></i>
            <h4>Synchronisation en cours...</h4>
            <p>Veuillez patienter pendant la synchronisation des données.</p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Ordonnances:</span>
                <span id="syncOrdonnancesStatus">En attente...</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Factures:</span>
                <span id="syncFacturesStatus">En attente...</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Stock:</span>
                <span id="syncStockStatus">En attente...</span>
              </div>
            </div>
            
            <div style="margin-top: 30px;">
              <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                <div id="syncProgressBar" style="background: #006b3f; height: 100%; width: 0%; transition: width 0.5s;"></div>
              </div>
              <div style="text-align: center; margin-top: 10px; font-weight: bold;" id="syncProgressText">0%</div>
            </div>
          </div>
          
          <div id="syncComplete" style="display: none; text-align: center;">
            <i class="fas fa-check-circle fa-3x" style="color: #28a745; margin-bottom: 20px;"></i>
            <h4>Synchronisation terminée !</h4>
            <p>Les données ont été synchronisées avec succès.</p>
            
            <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 30px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Ordonnances synchronisées:</span>
                <span id="syncOrdonnancesResult">0</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Factures synchronisées:</span>
                <span id="syncFacturesResult">0</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>Dernière synchronisation:</span>
                <span id="syncTimestamp">Maintenant</span>
              </div>
            </div>
          </div>
          
          <div id="syncError" style="display: none; text-align: center;">
            <i class="fas fa-exclamation-triangle fa-3x" style="color: #dc3545; margin-bottom: 20px;"></i>
            <h4>Erreur de synchronisation</h4>
            <p id="syncErrorMessage">Une erreur est survenue lors de la synchronisation.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelSyncBtn" style="display: none;">Fermer</button>
          <button class="btn btn-primary" id="retrySyncBtn" style="display: none;">Réessayer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== VARIABLES GLOBALES ==========
    let factures = [];
    let ordonnances = [];
    let medicamentsStock = [];
    let currentPage = {
      factures: 1,
      ordonnances: 1
    };
    let itemsPerPage = 10;
    let selectedFactures = new Set();
    let selectedOrdonnances = new Set();
    let editingFactureId = null;
    let editingOrdonnanceId = null;
    let currentSystem = 'dashboard';
    let currentPrescription = null;
    let currentFacture = null;

    // ========== INITIALISATION ==========
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Système intégré Pharmacie RDC démarré');
      
      // Initialiser l'utilisateur
      initializeUser();
      
      // Initialiser les données
      loadAllData();
      
      // Configurer les écouteurs d'événements
      setupEventListeners();
      
      // Initialiser l'interface
      setupInterface();
      
      // Générer un numéro de facture par défaut
      generateFactureNumber();
      generateOrdonnanceCode();
      
      // Ajouter une ligne de médicament par défaut
      addMedicamentRow();
      addOrdonnanceMedicamentRow();
      
      // Afficher une notification de bienvenue
      showNotification('Système intégré prêt à l\'emploi', 'success');
      
      // Synchronisation automatique
      setTimeout(syncPharmacyData, 1000);
    });

    function initializeUser() {
      let user = JSON.parse(localStorage.getItem('currentUser'));
      
      if (!user) {
        user = {
          id: 'user_1',
          nom: 'Pharmacien RDC',
          role: 'Administrateur',
          email: 'pharmacien@rdc.cd',
          telephone: '+243 81 234 5678',
          pharmacie: 'Pharmacie RDC Principale'
        };
        localStorage.setItem('currentUser', JSON.stringify(user));
      }
      
      document.getElementById('userName').textContent = user.nom;
      document.getElementById('userRole').textContent = user.role;
      document.getElementById('userAvatar').textContent = user.nom.substring(0, 2).toUpperCase();
    }

    // ========== CHARGEMENT DES DONNÉES ==========
    function loadAllData() {
      console.log('📂 Chargement de toutes les données...');
      
      // Charger les factures
      const savedFactures = localStorage.getItem('pharmacyFactures');
      factures = savedFactures ? JSON.parse(savedFactures) : generateSampleFactures();
      
      // Charger les ordonnances
      const savedOrdonnances = localStorage.getItem('pharmacyOrdonnances');
      ordonnances = savedOrdonnances ? JSON.parse(savedOrdonnances) : generateSampleOrdonnances();
      
      // Charger l'inventaire
      const savedStock = localStorage.getItem('pharmacyStock');
      medicamentsStock = savedStock ? JSON.parse(savedStock) : generateSampleStock();
      
      console.log(`✅ Données chargées: ${factures.length} factures, ${ordonnances.length} ordonnances, ${medicamentsStock.length} médicaments en stock`);
      
      // Sauvegarder si données d'exemple générées
      if (!savedFactures) saveFactures();
      if (!savedOrdonnances) saveOrdonnances();
      if (!savedStock) saveStock();
      
      // Mettre à jour les interfaces
      updateDashboard();
      renderFactures();
      renderOrdonnances();
      updateNavigation();
    }

    function generateSampleFactures() {
      const sampleClients = [
        { nom: 'Marie Kabasele', telephone: '+243 81 234 5678' },
        { nom: 'Jean Mulumba', telephone: '+243 82 345 6789' },
        { nom: 'Sophie Ngalula', telephone: '+243 89 123 4567' },
        { nom: 'Pierre Tshisekedi', telephone: '+243 84 567 8901' },
        { nom: 'Julie Ilunga', telephone: '+243 97 654 3210' }
      ];
      
      const sampleMedicaments = [
        { nom: 'Paracétamol 500mg', prix: 500 },
        { nom: 'Ibuprofène 400mg', prix: 750 },
        { nom: 'Amoxicilline 1g', prix: 2500 },
        { nom: 'Vitamine C 1000mg', prix: 1500 },
        { nom: 'Aspirine 500mg', prix: 600 },
        { nom: 'Doliprane 1000mg', prix: 800 },
        { nom: 'Nivaquine', prix: 1200 },
        { nom: 'Coartem', prix: 3500 }
      ];
      
      const factures = [];
      const startDate = new Date();
      startDate.setMonth(startDate.getMonth() - 3);
      
      for (let i = 0; i < 15; i++) {
        const client = sampleClients[Math.floor(Math.random() * sampleClients.length)];
        const numItems = Math.floor(Math.random() * 3) + 1;
        const medicaments = [];
        
        let sousTotal = 0;
        for (let j = 0; j < numItems; j++) {
          const med = sampleMedicaments[Math.floor(Math.random() * sampleMedicaments.length)];
          const quantite = Math.floor(Math.random() * 3) + 1;
          const prix = med.prix;
          medicaments.push({
            nom: med.nom,
            dosage: med.nom.split(' ')[1],
            quantite: quantite,
            prix: prix
          });
          sousTotal += prix * quantite;
        }
        
        const tva = sousTotal * 0.16;
        const total = sousTotal + tva;
        
        const dateFacturation = new Date(startDate);
        dateFacturation.setDate(startDate.getDate() + i * 3);
        
        const statuts = ['payee', 'en_attente', 'en_retard', 'brouillon'];
        const statut = statuts[Math.floor(Math.random() * statuts.length)];
        
        const methodesPaiement = ['especes', 'carte', 'mobile_money', 'assurance'];
        
        // Lier certaines factures à des ordonnances
        const ordonnanceCode = i % 3 === 0 ? `ORD-${2024000 + i}` : null;
        
        factures.push({
          id: 'facture_' + (i + 1),
          numeroFacture: 'FACT-' + (2024000 + i),
          clientNom: client.nom,
          clientTelephone: client.telephone,
          clientEmail: client.nom.toLowerCase().replace(' ', '.') + '@gmail.com',
          dateFacturation: dateFacturation.toISOString(),
          dateLimitePaiement: new Date(dateFacturation.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString(),
          medicaments: medicaments,
          sousTotal: sousTotal,
          tva: tva,
          remise: 0,
          total: total,
          statut: statut,
          methodePaiement: methodesPaiement[Math.floor(Math.random() * methodesPaiement.length)],
          ordonnanceCode: ordonnanceCode,
          ordonnanceId: ordonnanceCode ? 'ordonnance_' + (i + 1) : null,
          pharmacienNom: 'Pharmacien Principal',
          remarques: i % 3 === 0 ? 'Patient régulier' : '',
          createdAt: dateFacturation.toISOString(),
          updatedAt: new Date().toISOString()
        });
      }
      
      return factures;
    }

    function generateSampleOrdonnances() {
      const samplePatients = [
        { nom: 'David Lukusa', age: 35, telephone: '+243 81 111 2222' },
        { nom: 'Sarah Mbayo', age: 28, telephone: '+243 82 222 3333' },
        { nom: 'Samuel Kanda', age: 45, telephone: '+243 83 333 4444' },
        { nom: 'Esther Nzuzi', age: 52, telephone: '+243 84 444 5555' },
        { nom: 'Marc Tumba', age: 60, telephone: '+243 85 555 6666' }
      ];
      
      const sampleMedecins = [
        { nom: 'Dr. Koffi Olomide', specialite: 'Généraliste' },
        { nom: 'Dr. Marie Nzeba', specialite: 'Pédiatre' },
        { nom: 'Dr. Paul Desir', specialite: 'Cardiologue' },
        { nom: 'Dr. Julie Makiese', specialite: 'Dermatologue' }
      ];
      
      const medicamentsPrescriptibles = [
        { nom: 'Paracétamol 500mg', dosage: '500mg', posologie: '1 comprimé 3 fois par jour' },
        { nom: 'Ibuprofène 400mg', dosage: '400mg', posologie: '1 comprimé 2 fois par jour' },
        { nom: 'Amoxicilline 1g', dosage: '1g', posologie: '1 comprimé matin et soir' },
        { nom: 'Vitamine C 1000mg', dosage: '1000mg', posologie: '1 comprimé par jour' },
        { nom: 'Aspirine 500mg', dosage: '500mg', posologie: '1 comprimé si douleur' },
        { nom: 'Nivaquine', dosage: '100mg', posologie: '2 comprimés par semaine' },
        { nom: 'Coartem', dosage: '20/120mg', posologie: '4 comprimés matin et soir pendant 3 jours' }
      ];
      
      const ordonnances = [];
      const startDate = new Date();
      startDate.setMonth(startDate.getMonth() - 2);
      
      for (let i = 0; i < 12; i++) {
        const patient = samplePatients[Math.floor(Math.random() * samplePatients.length)];
        const medecin = sampleMedecins[Math.floor(Math.random() * sampleMedecins.length)];
        const numMedicaments = Math.floor(Math.random() * 3) + 1;
        const medicaments = [];
        
        for (let j = 0; j < numMedicaments; j++) {
          const med = medicamentsPrescriptibles[Math.floor(Math.random() * medicamentsPrescriptibles.length)];
          medicaments.push({
            nom: med.nom,
            dosage: med.dosage,
            posologie: med.posologie,
            quantite: Math.floor(Math.random() * 2) + 1,
            duree: '7 jours'
          });
        }
        
        const dateOrdonnance = new Date(startDate);
        dateOrdonnance.setDate(startDate.getDate() + i * 2);
        
        const statuts = ['envoyee', 'en_cours', 'pret', 'delivree'];
        const statut = statuts[Math.floor(Math.random() * statuts.length)];
        
        // Lier certaines ordonnances à des factures
        const factureAssociee = i % 3 === 0 ? `FACT-${2024000 + i}` : null;
        
        ordonnances.push({
          id: 'ordonnance_' + (i + 1),
          code: `ORD-${2024000 + i}`,
          patientNom: patient.nom,
          patientAge: patient.age,
          patientGenre: Math.random() > 0.5 ? 'M' : 'F',
          patientTelephone: patient.telephone,
          patientAdresse: 'Kinshasa, RDC',
          medecinNom: medecin.nom,
          medecinSpecialite: medecin.specialite,
          dateOrd: dateOrdonnance.toISOString(),
          medicaments: medicaments,
          statut: statut,
          factureAssociee: factureAssociee,
          factureId: factureAssociee ? 'facture_' + (i + 1) : null,
          instructions: 'Prendre les médicaments après les repas',
          pharmacieNom: 'Pharmacie RDC',
          createdAt: dateOrdonnance.toISOString(),
          updatedAt: new Date().toISOString()
        });
      }
      
      return ordonnances;
    }

    function generateSampleStock() {
      const medicaments = [
        { code: 'PARA500', nom: 'Paracétamol 500mg', categorie: 'Antidouleur', quantite: 150, seuil: 50, prixAchat: 300, prixVente: 500 },
        { code: 'IBUP400', nom: 'Ibuprofène 400mg', categorie: 'Anti-inflammatoire', quantite: 80, seuil: 30, prixAchat: 500, prixVente: 750 },
        { code: 'AMOX1000', nom: 'Amoxicilline 1g', categorie: 'Antibiotique', quantite: 45, seuil: 20, prixAchat: 1800, prixVente: 2500 },
        { code: 'VITC1000', nom: 'Vitamine C 1000mg', categorie: 'Vitamine', quantite: 120, seuil: 40, prixAchat: 1000, prixVente: 1500 },
        { code: 'ASPI500', nom: 'Aspirine 500mg', categorie: 'Antidouleur', quantite: 90, seuil: 30, prixAchat: 400, prixVente: 600 },
        { code: 'NIVA100', nom: 'Nivaquine', categorie: 'Antipaludéen', quantite: 60, seuil: 20, prixAchat: 800, prixVente: 1200 },
        { code: 'COARTEM', nom: 'Coartem', categorie: 'Antipaludéen', quantite: 40, seuil: 15, prixAchat: 2500, prixVente: 3500 }
      ];
      
      return medicaments;
    }

    // ========== SAUVEGARDE DES DONNÉES ==========
    function saveFactures() {
      localStorage.setItem('pharmacyFactures', JSON.stringify(factures));
      console.log('💾 Factures sauvegardées:', factures.length);
    }

    function saveOrdonnances() {
      localStorage.setItem('pharmacyOrdonnances', JSON.stringify(ordonnances));
      console.log('💾 Ordonnances sauvegardées:', ordonnances.length);
    }

    function saveStock() {
      localStorage.setItem('pharmacyStock', JSON.stringify(medicamentsStock));
    }

    function saveAllData() {
      saveFactures();
      saveOrdonnances();
      saveStock();
      console.log('💾 Toutes les données sauvegardées');
    }

    // ========== SYNCHRONISATION DES DONNÉES ==========
    function syncPharmacyData() {
      console.log('🔄 Synchronisation des données...');
      
      // Afficher le modal de synchronisation
      openSyncModal();
      
      let progress = 0;
      const totalSteps = 3;
      
      // Étape 1: Synchroniser les ordonnances
      setTimeout(() => {
        document.getElementById('syncOrdonnancesStatus').textContent = 'Synchronisation...';
        progress = 33;
        document.getElementById('syncProgressBar').style.width = progress + '%';
        document.getElementById('syncProgressText').textContent = progress + '%';
        
        syncOrdonnancesData();
      }, 500);
      
      // Étape 2: Synchroniser les factures
      setTimeout(() => {
        document.getElementById('syncFacturesStatus').textContent = 'Synchronisation...';
        progress = 66;
        document.getElementById('syncProgressBar').style.width = progress + '%';
        document.getElementById('syncProgressText').textContent = progress + '%';
        
        syncFacturesData();
      }, 1500);
      
      // Étape 3: Synchroniser le stock
      setTimeout(() => {
        document.getElementById('syncStockStatus').textContent = 'Synchronisation...';
        progress = 100;
        document.getElementById('syncProgressBar').style.width = progress + '%';
        document.getElementById('syncProgressText').textContent = progress + '%';
        
        syncStockData();
        
        // Afficher les résultats
        setTimeout(() => {
          document.getElementById('syncProgress').style.display = 'none';
          document.getElementById('syncComplete').style.display = 'block';
          
          const syncedOrdonnances = ordonnances.length;
          const syncedFactures = factures.length;
          const syncedStock = medicamentsStock.length;
          
          document.getElementById('syncOrdonnancesResult').textContent = syncedOrdonnances;
          document.getElementById('syncFacturesResult').textContent = syncedFactures;
          document.getElementById('syncTimestamp').textContent = new Date().toLocaleTimeString('fr-FR');
          
          document.getElementById('cancelSyncBtn').style.display = 'inline-block';
          
          // Mettre à jour les badges
          updateNavigation();
          
          console.log(`✅ Synchronisation terminée: ${syncedOrdonnances} ordonnances, ${syncedFactures} factures, ${syncedStock} médicaments`);
        }, 500);
        
      }, 2500);
    }

    function syncOrdonnancesData() {
      // Charger les ordonnances du système de détails
      const detailsOrdonnances = JSON.parse(localStorage.getItem("ordonnances")) || [];
      
      // Fusionner avec les ordonnances du système de gestion
      detailsOrdonnances.forEach(detailsOrd => {
        const exists = ordonnances.some(sysOrd => 
          sysOrd.code === detailsOrd.code || 
          sysOrd.id === detailsOrd.id ||
          sysOrd._id === detailsOrd.id
        );
        
        if (!exists) {
          // Convertir au format du système de gestion
          const newOrdonnance = {
            id: detailsOrd.id || detailsOrd._id || 'ordonnance_' + Date.now(),
            code: detailsOrd.code || `ORD-${Date.now()}`,
            patientNom: detailsOrd.patientNom,
            patientAge: detailsOrd.patientAge,
            patientGenre: detailsOrd.patientGenre,
            patientTelephone: detailsOrd.patientTelephone,
            patientAdresse: detailsOrd.patientAdresse,
            medecinNom: detailsOrd.medecinNom,
            medecinSpecialite: detailsOrd.medecinSpecialite,
            dateOrd: detailsOrd.dateOrd || detailsOrd.dateEnvoi,
            medicaments: detailsOrd.medicaments || detailsOrd.medicamentsList || [],
            statut: detailsOrd.statut || 'envoyee',
            instructions: detailsOrd.instructions || detailsOrd.recommandations,
            pharmacieNom: detailsOrd.pharmacieNom || 'Pharmacie RDC',
            factureAssociee: null,
            factureId: null,
            createdAt: detailsOrd.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          ordonnances.unshift(newOrdonnance);
        }
      });
      
      saveOrdonnances();
      document.getElementById('syncOrdonnancesStatus').textContent = 'Terminé';
    }

    function syncFacturesData() {
      // Charger les factures du système de détails
      const detailsFactures = JSON.parse(localStorage.getItem("factures")) || [];
      
      // Fusionner avec les factures du système de gestion
      detailsFactures.forEach(detailsFact => {
        const exists = factures.some(sysFact => 
          sysFact.numeroFacture === detailsFact.numeroFacture || 
          sysFact.id === detailsFact.id
        );
        
        if (!exists) {
          // Convertir au format du système de gestion
          const newFacture = {
            id: detailsFact.id || 'facture_' + Date.now(),
            numeroFacture: detailsFact.numeroFacture || `FACT-${Date.now()}`,
            clientNom: detailsFact.clientNom || 'Client Pharmacie',
            clientTelephone: detailsFact.clientTelephone || '',
            clientEmail: detailsFact.clientEmail || '',
            clientAdresse: detailsFact.clientAdresse || '',
            dateFacturation: detailsFact.dateFacturation || new Date().toISOString(),
            dateLimitePaiement: detailsFact.dateLimitePaiement || '',
            ordonnanceCode: detailsFact.codeOrdonnance || detailsFact.ordonnanceCode || '',
            ordonnanceId: detailsFact.idOrdonnance || detailsFact.ordonnanceId || '',
            medicaments: detailsFact.medicaments || detailsFact.items || [],
            sousTotal: detailsFact.sousTotal || 0,
            tva: detailsFact.tva || 0,
            remise: detailsFact.remise || 0,
            total: detailsFact.total || 0,
            statut: detailsFact.statut || 'en_attente',
            methodePaiement: detailsFact.methodePaiement || '',
            pharmacienNom: detailsFact.pharmacienNom || 'Pharmacien',
            remarques: detailsFact.remarques || '',
            createdAt: detailsFact.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          factures.unshift(newFacture);
          
          // Mettre à jour l'ordonnance associée
          if (newFacture.ordonnanceCode) {
            const ordonnance = ordonnances.find(o => o.code === newFacture.ordonnanceCode);
            if (ordonnance) {
              ordonnance.factureAssociee = newFacture.numeroFacture;
              ordonnance.factureId = newFacture.id;
              ordonnance.updatedAt = new Date().toISOString();
            }
          }
        }
      });
      
      saveFactures();
      saveOrdonnances();
      document.getElementById('syncFacturesStatus').textContent = 'Terminé';
    }

    function syncStockData() {
      // Pour l'instant, simplement marquer comme terminé
      document.getElementById('syncStockStatus').textContent = 'Terminé';
    }

    function openSyncModal() {
      document.getElementById('syncProgress').style.display = 'block';
      document.getElementById('syncComplete').style.display = 'none';
      document.getElementById('syncError').style.display = 'none';
      document.getElementById('cancelSyncBtn').style.display = 'none';
      document.getElementById('retrySyncBtn').style.display = 'none';
      
      document.getElementById('syncProgressBar').style.width = '0%';
      document.getElementById('syncProgressText').textContent = '0%';
      document.getElementById('syncOrdonnancesStatus').textContent = 'En attente...';
      document.getElementById('syncFacturesStatus').textContent = 'En attente...';
      document.getElementById('syncStockStatus').textContent = 'En attente...';
      
      openModal('syncModal');
    }

    // ========== INTERFACE ==========
    function setupInterface() {
      // Configurer les boutons du système
      document.querySelectorAll('.system-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const system = this.dataset.system;
          switchSystem(system);
        });
      });
      
      // Générer la navigation
      generateNavigation();
    }

    function switchSystem(system) {
      currentSystem = system;
      
      // Mettre à jour les boutons actifs
      document.querySelectorAll('.system-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.system === system);
      });
      
      // Masquer tous les contenus
      document.querySelectorAll('.main-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Afficher le contenu du système sélectionné
      document.getElementById(`${system}Content`).classList.add('active');
      
      // Mettre à jour la navigation
      updateNavigation();
      
      // Actions spécifiques au système
      switch(system) {
        case 'dashboard':
          updateDashboard();
          break;
        case 'factures':
          renderFactures();
          break;
        case 'ordonnances':
          renderOrdonnances();
          break;
        case 'details':
          loadDetailsSystem();
          break;
      }
      
      console.log(`🔄 Système changé: ${system}`);
    }

    function generateNavigation() {
      const navHTML = `
        <button class="nav-btn active" data-nav="dashboard">
          <i class="fas fa-tachometer-alt"></i> Tableau de bord
        </button>
        <button class="nav-btn" data-nav="factures">
          <i class="fas fa-file-invoice-dollar"></i> Factures
          <span class="notification-badge" id="facturesBadge" style="display: none;">0</span>
        </button>
        <button class="nav-btn" data-nav="ordonnances">
          <i class="fas fa-prescription"></i> Ordonnances
          <span class="notification-badge" id="ordonnancesBadge" style="display: none;">0</span>
        </button>
        <button class="nav-btn" data-nav="sync">
          <i class="fas fa-sync-alt"></i> Synchronisation
        </button>
        <button class="nav-btn" data-nav="rapports">
          <i class="fas fa-chart-bar"></i> Rapports
        </button>
        <button class="nav-btn" data-nav="stock">
          <i class="fas fa-pills"></i> Stock
          <span class="notification-badge" id="stockBadge" style="display: none;">0</span>
        </button>
        <button class="nav-btn" data-nav="parametres">
          <i class="fas fa-cog"></i> Paramètres
        </button>
      `;
      
      document.getElementById('mainNav').innerHTML = navHTML;
      
      // Configurer les écouteurs de navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const nav = this.dataset.nav;
          handleNavigation(nav);
        });
      });
    }

    function updateNavigation() {
      // Mettre à jour les badges
      const facturesEnAttente = factures.filter(f => f.statut === 'en_attente').length;
      const ordonnancesEnAttente = ordonnances.filter(o => o.statut === 'envoyee').length;
      const stockFaible = medicamentsStock.filter(m => m.quantite <= m.seuil).length;
      
      document.getElementById('facturesBadge').textContent = facturesEnAttente;
      document.getElementById('facturesBadge').style.display = facturesEnAttente > 0 ? 'inline-block' : 'none';
      
      document.getElementById('ordonnancesBadge').textContent = ordonnancesEnAttente;
      document.getElementById('ordonnancesBadge').style.display = ordonnancesEnAttente > 0 ? 'inline-block' : 'none';
      
      document.getElementById('stockBadge').textContent = stockFaible;
      document.getElementById('stockBadge').style.display = stockFaible > 0 ? 'inline-block' : 'none';
    }

    function handleNavigation(nav) {
      // Mettre à jour les boutons actifs
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.nav === nav);
      });
      
      // Gérer les actions de navigation
      switch(nav) {
        case 'dashboard':
          switchSystem('dashboard');
          break;
        case 'factures':
          switchSystem('factures');
          break;
        case 'ordonnances':
          switchSystem('ordonnances');
          break;
        case 'sync':
          syncPharmacyData();
          break;
        case 'stock':
          showStockManagement();
          break;
        case 'rapports':
          generateReport();
          break;
        case 'parametres':
          openSettings();
          break;
      }
    }

    // ========== DASHBOARD ==========
    function updateDashboard() {
      updateDashboardStats();
      updateRecentActivity();
      updateAlerts();
    }

    function updateDashboardStats() {
      const stats = {
        totalFactures: factures.length,
        facturesPayees: factures.filter(f => f.statut === 'payee').length,
        facturesEnAttente: factures.filter(f => f.statut === 'en_attente').length,
        totalMontant: factures.reduce((sum, f) => sum + f.total, 0),
        totalOrdonnances: ordonnances.length,
        ordonnancesEnCours: ordonnances.filter(o => o.statut === 'en_cours').length,
        ordonnancesPretes: ordonnances.filter(o => o.statut === 'pret').length,
        ordonnancesEnvoyees: ordonnances.filter(o => o.statut === 'envoyee').length,
        ordonnancesDelivrees: ordonnances.filter(o => o.statut === 'delivree').length,
        stockTotal: medicamentsStock.reduce((sum, m) => sum + m.quantite, 0),
        stockFaible: medicamentsStock.filter(m => m.quantite <= m.seuil).length
      };
      
      const statsHTML = `
        <div class="stat-card">
          <div class="stat-icon total">
            <i class="fas fa-file-invoice"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.totalFactures}</h3>
            <p>Factures totales</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon payees">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.facturesPayees}</h3>
            <p>Factures payées</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon en-cours">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.facturesEnAttente}</h3>
            <p>Factures en attente</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon montant">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-info">
            <h3>${formatPrice(stats.totalMontant)}</h3>
            <p>Chiffre d'affaires</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon ordonnances">
            <i class="fas fa-prescription"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.totalOrdonnances}</h3>
            <p>Ordonnances</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon envoyee">
            <i class="fas fa-paper-plane"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.ordonnancesEnvoyees}</h3>
            <p>À traiter</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon delivree">
            <i class="fas fa-check-double"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.ordonnancesDelivrees}</h3>
            <p>Délivrées</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon medicaments">
            <i class="fas fa-pills"></i>
          </div>
          <div class="stat-info">
            <h3>${stats.stockTotal}</h3>
            <p>Médicaments en stock</p>
          </div>
        </div>
      `;
      
      document.getElementById('dashboardStats').innerHTML = statsHTML;
    }

    function updateRecentActivity() {
      const activities = [];
      
      // Ajouter les factures récentes
      factures.slice(-5).forEach(f => {
        activities.push({
          type: 'facture',
          date: f.dateFacturation,
          title: `Facture ${f.numeroFacture}`,
          description: `${f.clientNom} - ${formatPrice(f.total)}`,
          status: f.statut,
          icon: 'file-invoice-dollar'
        });
      });
      
      // Ajouter les ordonnances récentes
      ordonnances.slice(-5).forEach(o => {
        activities.push({
          type: 'ordonnance',
          date: o.dateOrd,
          title: `Ordonnance ${o.code}`,
          description: `${o.patientNom} - Dr. ${o.medecinNom}`,
          status: o.statut,
          icon: 'prescription'
        });
      });
      
      // Trier par date
      activities.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      const recentActivities = activities.slice(0, 5);
      
      const activitiesHTML = recentActivities.map(activity => `
        <div style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
          <div style="width: 40px; height: 40px; border-radius: 8px; background: #e3f2fd; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-${activity.icon}" style="color: #1976d2;"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 500;">${activity.title}</div>
            <div style="font-size: 0.9em; color: #666;">${activity.description}</div>
          </div>
          <div style="font-size: 0.85em; color: #999;">${formatDate(activity.date)}</div>
        </div>
      `).join('');
      
      document.getElementById('recentActivity').innerHTML = activitiesHTML || '<p style="color: #999; text-align: center;">Aucune activité récente</p>';
    }

    function updateAlerts() {
      const alerts = [];
      
      // Alertes de stock faible
      medicamentsStock.filter(m => m.quantite <= m.seuil).forEach(m => {
        alerts.push({
          type: 'stock',
          level: 'warning',
          message: `Stock faible pour ${m.nom}: ${m.quantite} unités restantes`,
          icon: 'exclamation-triangle'
        });
      });
      
      // Alertes de factures en retard
      const today = new Date();
      factures.filter(f => f.statut === 'en_attente' && f.dateLimitePaiement).forEach(f => {
        const dueDate = new Date(f.dateLimitePaiement);
        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 3 && diffDays >= 0) {
          alerts.push({
            type: 'facture',
            level: diffDays <= 0 ? 'danger' : 'warning',
            message: `Facture ${f.numeroFacture} ${diffDays <= 0 ? 'en retard' : 'à échéance dans ' + diffDays + ' jours'}`,
            icon: 'clock'
          });
        }
      });
      
      // Alertes d'ordonnances en attente
      const ordonnancesEnAttente = ordonnances.filter(o => o.statut === 'envoyee').length;
      if (ordonnancesEnAttente > 0) {
        alerts.push({
          type: 'ordonnance',
          level: 'info',
          message: `${ordonnancesEnAttente} ordonnance(s) en attente de traitement`,
          icon: 'prescription'
        });
      }
      
      const alertsHTML = alerts.map(alert => `
        <div style="padding: 12px 15px; margin-bottom: 10px; border-radius: 6px; 
                    background: ${alert.level === 'danger' ? '#f8d7da' : alert.level === 'warning' ? '#fff3cd' : '#d1ecf1'};
                    color: ${alert.level === 'danger' ? '#721c24' : alert.level === 'warning' ? '#856404' : '#0c5460'};
                    border-left: 4px solid ${alert.level === 'danger' ? '#dc3545' : alert.level === 'warning' ? '#ffc107' : '#17a2b8'};">
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${alert.icon}"></i>
            <span>${alert.message}</span>
          </div>
        </div>
      `).join('');
      
      document.getElementById('alertsContainer').innerHTML = alertsHTML || '<p style="color: #999; text-align: center;">Aucune alerte pour le moment</p>';
    }

    // ========== SYSTÈME DE DÉTAILS ==========
    function loadDetailsSystem() {
      const detailsContainer = document.getElementById('detailsContainer');
      const loadingState = document.getElementById('detailsLoadingState');
      
      detailsContainer.style.display = 'none';
      loadingState.style.display = 'block';
      
      // Charger les ordonnances pour la sélection
      setTimeout(() => {
        const selectHTML = `
          <div class="prescription-details">
            <div class="prescription-header">
              <h1><i class="fas fa-search"></i> SÉLECTIONNER UNE ORDONNANCE</h1>
              <p style="font-size: 1.2em; margin-top: 10px;">Choisissez une ordonnance pour voir les détails</p>
            </div>
            
            <div class="prescription-content">
              <div class="section">
                <h3><i class="fas fa-list"></i> Liste des ordonnances disponibles</h3>
                <div class="info-grid">
                  <div class="info-item">
                    <strong>Rechercher une ordonnance:</strong>
                    <input type="text" id="searchDetailsOrdonnance" class="form-control" placeholder="Code, patient, médecin..." style="margin-top: 5px;">
                  </div>
                  <div class="info-item">
                    <strong>Filtrer par statut:</strong>
                    <select id="filterDetailsStatus" class="form-control" style="margin-top: 5px;">
                      <option value="">Tous les statuts</option>
                      <option value="envoyee">À traiter</option>
                      <option value="en_cours">En cours</option>
                      <option value="pret">Prête</option>
                      <option value="delivree">Délivrée</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="section">
                <h3><i class="fas fa-prescription"></i> Ordonnances</h3>
                <div id="ordonnancesListContainer" style="max-height: 400px; overflow-y: auto;">
                  ${generateOrdonnancesListHTML()}
                </div>
              </div>
              
              <div class="section">
                <h3><i class="fas fa-plus-circle"></i> Actions rapides</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                  <button class="btn btn-primary" onclick="createNewOrdonnance()">
                    <i class="fas fa-plus"></i> Nouvelle ordonnance
                  </button>
                  <button class="btn btn-success" onclick="syncPharmacyData()">
                    <i class="fas fa-sync-alt"></i> Synchroniser données
                  </button>
                  <button class="btn btn-info" onclick="switchSystem('ordonnances')">
                    <i class="fas fa-exchange-alt"></i> Aller à la gestion
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        detailsContainer.innerHTML = selectHTML;
        detailsContainer.style.display = 'block';
        loadingState.style.display = 'none';
        
        // Ajouter les écouteurs d'événements
        document.getElementById('searchDetailsOrdonnance').addEventListener('input', searchOrdonnancesInDetails);
        document.getElementById('filterDetailsStatus').addEventListener('change', searchOrdonnancesInDetails);
      }, 500);
    }

    function generateOrdonnancesListHTML() {
      if (ordonnances.length === 0) {
        return '<div class="empty-state"><i class="fas fa-prescription"></i><p>Aucune ordonnance disponible</p></div>';
      }
      
      return ordonnances.map(ordonnance => {
        const statusClass = `status-${ordonnance.statut}`;
        const statusText = getStatusText(ordonnance.statut);
        
        return `
          <div class="medicament-item" style="cursor: pointer;" onclick="viewOrdonnanceDetails('${ordonnance.id}')">
            <div class="medicament-header">
              <h4>${ordonnance.code} - ${ordonnance.patientNom}</h4>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <div class="medicament-details">
              <div><strong>Médecin:</strong> ${ordonnance.medecinNom}</div>
              <div><strong>Date:</strong> ${formatDate(ordonnance.dateOrd)}</div>
              <div><strong>Médicaments:</strong> ${ordonnance.medicaments.length}</div>
              <div><strong>Facture:</strong> ${ordonnance.factureAssociee || 'Non liée'}</div>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
              <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewOrdonnanceDetails('${ordonnance.id}')">
                <i class="fas fa-eye"></i> Voir détails
              </button>
              <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); createFactureFromOrdonnance('${ordonnance.id}')">
                <i class="fas fa-file-invoice-dollar"></i> Créer facture
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function searchOrdonnancesInDetails() {
      const searchTerm = document.getElementById('searchDetailsOrdonnance').value.toLowerCase();
      const statusFilter = document.getElementById('filterDetailsStatus').value;
      
      let filtered = ordonnances;
      
      if (searchTerm) {
        filtered = filtered.filter(o => 
          o.code.toLowerCase().includes(searchTerm) ||
          o.patientNom.toLowerCase().includes(searchTerm) ||
          o.medecinNom.toLowerCase().includes(searchTerm)
        );
      }
      
      if (statusFilter) {
        filtered = filtered.filter(o => o.statut === statusFilter);
      }
      
      const container = document.getElementById('ordonnancesListContainer');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Aucune ordonnance trouvée</p></div>';
      } else {
        container.innerHTML = filtered.map(ordonnance => {
          const statusClass = `status-${ordonnance.statut}`;
          const statusText = getStatusText(ordonnance.statut);
          
          return `
            <div class="medicament-item" style="cursor: pointer;" onclick="viewOrdonnanceDetails('${ordonnance.id}')">
              <div class="medicament-header">
                <h4>${ordonnance.code} - ${ordonnance.patientNom}</h4>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>
              <div class="medicament-details">
                <div><strong>Médecin:</strong> ${ordonnance.medecinNom}</div>
                <div><strong>Date:</strong> ${formatDate(ordonnance.dateOrd)}</div>
                <div><strong>Médicaments:</strong> ${ordonnance.medicaments.length}</div>
                <div><strong>Facture:</strong> ${ordonnance.factureAssociee || 'Non liée'}</div>
              </div>
              <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewOrdonnanceDetails('${ordonnance.id}')">
                  <i class="fas fa-eye"></i> Voir détails
                </button>
                <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); createFactureFromOrdonnance('${ordonnance.id}')">
                  <i class="fas fa-file-invoice-dollar"></i> Créer facture
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function viewOrdonnanceDetails(ordonnanceId) {
      const ordonnance = ordonnances.find(o => o.id === ordonnanceId);
      if (!ordonnance) return;
      
      currentPrescription = ordonnance;
      
      // Charger la facture associée
      if (ordonnance.factureId) {
        currentFacture = factures.find(f => f.id === ordonnance.factureId);
      } else {
        currentFacture = null;
      }
      
      const detailsContainer = document.getElementById('detailsContainer');
      detailsContainer.innerHTML = generateOrdonnanceDetailsHTML(ordonnance);
      
      // Mettre à jour l'interface
      updateNavigation();
    }

    function generateOrdonnanceDetailsHTML(p) {
      const statusClass = `status-${p.statut || 'envoye'}`;
      const statusText = getStatusText(p.statut);
      
      return `
        <div class="prescription-details">
          <div class="prescription-header">
            <h1><i class="fas fa-prescription"></i> ORDONNANCE MÉDICALE</h1>
            <p style="font-size: 1.2em; margin-top: 10px;">N° ${p.code || p.id || "—"}</p>
            <div class="status-badge ${statusClass}">${statusText}</div>
          </div>

          <div class="prescription-content">
            <!-- Informations pharmacie -->
            <div class="section">
              <h3><i class="fas fa-house-medical"></i> Informations Pharmacie</h3>
              <div class="info-grid">
                <div class="info-item">
                  <strong>Pharmacie :</strong>
                  <span>${escapeHtml(p.pharmacieNom || "Pharmacie RDC")}</span>
                </div>
                <div class="info-item">
                  <strong>Date de réception :</strong>
                  <span>${formatDate(p.dateOrd || p.createdAt)}</span>
                </div>
                <div class="info-item">
                  <strong>Statut :</strong>
                  <span style="color: ${getStatusColor(p.statut)}; font-weight: bold;">${statusText}</span>
                </div>
              </div>
            </div>

            <!-- Informations patient -->
            <div class="section">
              <h3><i class="fas fa-user"></i> Informations Patient</h3>
              <div class="info-grid">
                <div class="info-item">
                  <strong>Nom :</strong>
                  <span>${escapeHtml(p.patientNom || "Non spécifié")}</span>
                </div>
                <div class="info-item">
                  <strong>Âge :</strong>
                  <span>${escapeHtml(p.patientAge || "Non spécifié")}</span>
                </div>
                <div class="info-item">
                  <strong>Genre :</strong>
                  <span>${p.patientGenre === 'F' ? 'Femme' : (p.patientGenre === 'M' ? 'Homme' : escapeHtml(p.patientGenre) || "Non spécifié")}</span>
                </div>
                <div class="info-item">
                  <strong>Téléphone :</strong>
                  <span>${escapeHtml(p.patientTelephone || "Non spécifié")}</span>
                </div>
                <div class="info-item">
                  <strong>Adresse :</strong>
                  <span>${escapeHtml(p.patientAdresse || "Non spécifié")}</span>
                </div>
              </div>
            </div>

            <!-- Médicaments -->
            <div class="section">
              <h3><i class="fas fa-pills"></i> Médicaments Prescrits</h3>
              <div id="medicamentsContainerDetails">
                ${displayMedicamentsHTML(p.medicaments || [])}
              </div>
            </div>

            <!-- Instructions -->
            <div class="section">
              <h3><i class="fas fa-info-circle"></i> Instructions et Recommandations</h3>
              <div class="instructions">
                ${escapeHtml(p.instructions || "Aucune instruction particulière")}
              </div>
            </div>

            <!-- Informations médecin -->
            <div class="section">
              <h3><i class="fas fa-stethoscope"></i> Informations Médecin</h3>
              <div class="info-grid">
                <div class="info-item">
                  <strong>Nom médecin :</strong>
                  <span>${escapeHtml(p.medecinNom || "Non spécifié")}</span>
                </div>
                <div class="info-item">
                  <strong>Spécialité :</strong>
                  <span>${escapeHtml(p.medecinSpecialite || "Non spécifié")}</span>
                </div>
                <div class="info-item">
                  <strong>Date de prescription :</strong>
                  <span>${formatDate(p.dateOrd)}</span>
                </div>
                <div class="info-item">
                  <strong>Code ordonnance :</strong>
                  <span style="font-family: monospace; background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">
                    ${escapeHtml(p.code || "—")}
                  </span>
                </div>
              </div>
            </div>

            <!-- Section Facture -->
            <div class="facture-section">
              <div class="facture-header">
                <h3 style="margin: 0; color: white;"><i class="fas fa-file-invoice-dollar"></i> FACTURE PHARMACEUTIQUE</h3>
                <span class="code-badge">ORD-${p.code || p.id || "—"}</span>
              </div>
              
              <div class="facture-content">
                ${displayFactureHTML(currentFacture, p)}
                
                <!-- Information de liaison facture-ordonnance -->
                ${currentFacture ? `
                  <div class="linked-info">
                    <i class="fas fa-link fa-lg"></i>
                    <div>
                      <strong>Facture liée à l'ordonnance :</strong><br>
                      <span>La facture N° ${escapeHtml(currentFacture.numeroFacture || currentFacture.id)} est officiellement liée à l'ordonnance N° ${escapeHtml(p.code || p.id || "—")}</span>
                    </div>
                  </div>
                ` : ''}
                
                <div class="facture-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                  ${currentFacture ? `
                    <button class="btn btn-success" onclick="printFactureFromDetails('${currentFacture.id}')">
                      <i class="fas fa-print"></i> Imprimer la facture
                    </button>
                    <button class="btn btn-warning" onclick="editFacture('${currentFacture.id}')">
                      <i class="fas fa-edit"></i> Modifier la facture
                    </button>
                  ` : `
                    <button class="btn btn-success" onclick="createFactureFromOrdonnance('${p.id}')">
                      <i class="fas fa-plus-circle"></i> Créer une facture
                    </button>
                  `}
                  <button class="btn btn-info" onclick="switchSystem('ordonnances')">
                    <i class="fas fa-exchange-alt"></i> Retour à la liste
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: center;">
            ${getActionButtonsHTML(p.statut, p.id)}
            <button class="btn btn-outline" onclick="loadDetailsSystem()">
              <i class="fas fa-list"></i> Voir toutes les ordonnances
            </button>
          </div>
        </div>
      `;
    }

    function displayMedicamentsHTML(medicaments) {
      if (!medicaments || medicaments.length === 0) {
        return `
          <div class="empty-state">
            <i class="fas fa-prescription-bottle"></i>
            <p style="margin-top: 10px;">Aucun médicament prescrit</p>
          </div>
        `;
      }

      let html = '';
      medicaments.forEach((med, index) => {
        html += `
          <div class="medicament-item">
            <div class="medicament-header">
              <h4>${escapeHtml(med.medicament || med.nom || "Médicament sans nom")}</h4>
              <span class="medicament-number">Médicament #${index + 1}</span>
            </div>
            <div class="medicament-details">
              <div><strong>Dosage :</strong> ${escapeHtml(med.dosage || "Non spécifié")}</div>
              <div><strong>Posologie :</strong> ${escapeHtml(med.posologie || "Non spécifié")}</div>
              <div><strong>Durée :</strong> ${escapeHtml(med.duree || "Non spécifié")}</div>
              <div><strong>Quantité :</strong> ${escapeHtml(med.quantite || "Non spécifié")}</div>
            </div>
          </div>
        `;
      });
      
      return html;
    }

    function displayFactureHTML(facture, ordonnance) {
      if (!facture) {
        return `
          <div class="empty-state">
            <i class="fas fa-file-invoice fa-3x"></i>
            <h4>Aucune facture générée</h4>
            <p style="margin-top: 10px; color: #666;">
              Aucune facture n'a été créée pour cette ordonnance.<br>
              Cliquez sur "Créer une facture" pour démarrer la facturation.
            </p>
          </div>
        `;
      }

      const medicaments = facture.medicaments || [];
      const sousTotal = medicaments.reduce((sum, item) => sum + (item.prix * item.quantite), 0);
      const tva = facture.tva || sousTotal * 0.16;
      const total = facture.total || (sousTotal + tva);

      return `
        <div class="facture-grid">
          <div class="facture-info">
            <strong><i class="fas fa-hashtag"></i> Numéro de facture :</strong><br>
            <span style="font-size: 1.2em; font-weight: bold;">${escapeHtml(facture.numeroFacture || facture.id || "FACT-" + new Date().getTime())}</span>
          </div>
          <div class="facture-info">
            <strong><i class="fas fa-calendar"></i> Date de facturation :</strong><br>
            <span>${formatDate(facture.dateFacturation || new Date())}</span>
          </div>
          <div class="facture-info">
            <strong><i class="fas fa-user-md"></i> Pharmacien :</strong><br>
            <span>${escapeHtml(facture.pharmacienNom || "Pharmacien responsable")}</span>
          </div>
          <div class="facture-info">
            <strong><i class="fas fa-file-medical"></i> Ordonnance liée :</strong><br>
            <span style="font-family: monospace;">${escapeHtml(ordonnance.code || ordonnance.id || "—")}</span>
          </div>
        </div>

        <div class="facture-table-container">
          <table class="facture-table">
            <thead>
              <tr>
                <th>Médicament</th>
                <th>Dosage</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Sous-total</th>
              </tr>
            </thead>
            <tbody>
              ${medicaments.map((item, index) => `
                <tr>
                  <td>${escapeHtml(item.nom || item.medicament || "Médicament")}</td>
                  <td>${escapeHtml(item.dosage || "—")}</td>
                  <td>${escapeHtml(item.quantite || 1)}</td>
                  <td>${formatPrix(item.prix || 0)} FCF</td>
                  <td>${formatPrix((item.prix || 0) * (item.quantite || 1))} FCF</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="3"></td>
                <td><strong>Sous-total :</strong></td>
                <td><strong>${formatPrix(sousTotal)} FCF</strong></td>
              </tr>
              <tr class="total-row">
                <td colspan="3"></td>
                <td><strong>TVA (16%) :</strong></td>
                <td><strong>${formatPrix(tva)} FCF</strong></td>
              </tr>
              <tr class="total-row">
                <td colspan="3"></td>
                <td><strong>TOTAL :</strong></td>
                <td><strong style="font-size: 1.2em; color: #2a5298;">${formatPrix(total)} FCF</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
          <strong>Méthode de paiement :</strong> ${escapeHtml(facture.methodePaiement || "Non spécifiée")}<br>
          <strong>Date limite de paiement :</strong> ${formatDate(facture.dateLimitePaiement || "")}<br>
          <strong>Remarques :</strong> ${escapeHtml(facture.remarques || "Aucune remarque")}
        </div>
      `;
    }

    function getActionButtonsHTML(statut, ordonnanceId) {
      if (!ordonnanceId) return '';
      
      switch(statut) {
        case 'envoyee':
          return `
            <button class="btn btn-success" onclick="updateOrdonnanceStatus('${ordonnanceId}', 'en_cours')">
              <i class="fas fa-play"></i> Commencer le traitement
            </button>
          `;
        case 'en_cours':
          return `
            <button class="btn btn-success" onclick="updateOrdonnanceStatus('${ordonnanceId}', 'pret')">
              <i class="fas fa-check"></i> Marquer comme prête
            </button>
          `;
        case 'pret':
          return `
            <button class="btn btn-success" onclick="updateOrdonnanceStatus('${ordonnanceId}', 'delivree')">
              <i class="fas fa-check-double"></i> Confirmer la délivrance
            </button>
          `;
        default:
          return '';
      }
    }

    function updateOrdonnanceStatus(ordonnanceId, newStatus) {
      const ordonnance = ordonnances.find(o => o.id === ordonnanceId);
      if (!ordonnance) return;
      
      const oldStatus = ordonnance.statut;
      const statusText = getStatusText(newStatus);
      
      if (!confirm(`Changer le statut de l'ordonnance de "${getStatusText(oldStatus)}" à "${statusText}" ?`)) {
        return;
      }
      
      ordonnance.statut = newStatus;
      ordonnance.updatedAt = new Date().toISOString();
      
      saveOrdonnances();
      
      // Si on passe à "délivrée" et qu'il n'y a pas de facture, suggérer d'en créer une
      if (newStatus === 'delivree' && !ordonnance.factureAssociee) {
        setTimeout(() => {
          if (confirm(`L'ordonnance a été délivrée. Souhaitez-vous créer une facture maintenant ?`)) {
            createFactureFromOrdonnance(ordonnanceId);
          }
        }, 500);
      }
      
      showNotification(`Statut de l'ordonnance mis à jour: ${statusText}`, 'success');
      
      // Recharger la vue détaillée
      viewOrdonnanceDetails(ordonnanceId);
      
      // Mettre à jour le tableau de bord
      updateDashboard();
      updateNavigation();
    }

    function createNewOrdonnance() {
      openCreateOrdonnanceModal();
    }

    function printFactureFromDetails(factureId) {
      printFacture(factureId);
    }

    // ========== GESTION DES FACTURES ==========
    function renderFactures() {
      const tbody = document.getElementById('facturesTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      // Appliquer les filtres
      let filteredFactures = [...factures];
      
      // Filtre de recherche
      const searchTerm = document.getElementById('searchFactures').value.toLowerCase();
      if (searchTerm) {
        filteredFactures = filteredFactures.filter(f => 
          f.numeroFacture.toLowerCase().includes(searchTerm) ||
          f.clientNom.toLowerCase().includes(searchTerm) ||
          (f.clientTelephone && f.clientTelephone.includes(searchTerm)) ||
          (f.ordonnanceCode && f.ordonnanceCode.toLowerCase().includes(searchTerm))
        );
      }
      
      // Filtre par statut
      const statusFilter = document.getElementById('statusFilterFactures').value;
      if (statusFilter) {
        filteredFactures = filteredFactures.filter(f => f.statut === statusFilter);
      }
      
      // Filtre par date
      const dateFilter = document.getElementById('dateFilterFactures').value;
      if (dateFilter) {
        const now = new Date();
        filteredFactures = filteredFactures.filter(f => {
          const date = new Date(f.dateFacturation);
          switch(dateFilter) {
            case 'today':
              return date.toDateString() === now.toDateString();
            case 'week':
              const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
              return date >= weekStart;
            case 'month':
              return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            default:
              return true;
          }
        });
      }
      
      // Pagination
      const startIndex = (currentPage.factures - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedFactures = filteredFactures.slice(startIndex, endIndex);
      
      if (paginatedFactures.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <i class="fas fa-file-invoice"></i>
                <h4>Aucune facture trouvée</h4>
                <p>Essayez de modifier vos critères de recherche</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Rendre chaque facture
      paginatedFactures.forEach(facture => {
        const row = document.createElement('tr');
        
        const dateFormatted = formatDate(facture.dateFacturation);
        
        let statusClass = '';
        let statusText = '';
        switch(facture.statut) {
          case 'payee':
            statusClass = 'status-payee';
            statusText = 'Payée';
            break;
          case 'en_attente':
            statusClass = 'status-en_attente';
            statusText = 'En attente';
            break;
          case 'en_retard':
            statusClass = 'status-en_retard';
            statusText = 'En retard';
            break;
          case 'brouillon':
            statusClass = 'status-brouillon';
            statusText = 'Brouillon';
            break;
          case 'annulee':
            statusClass = 'status-annulee';
            statusText = 'Annulée';
            break;
        }
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="facture-checkbox" value="${facture.id}" 
                   ${selectedFactures.has(facture.id) ? 'checked' : ''}>
          </td>
          <td>
            <span class="facture-num">${facture.numeroFacture}</span>
          </td>
          <td>
            <div class="client-info">
              <span class="client-name">${escapeHtml(facture.clientNom)}</span>
              ${facture.clientTelephone ? `
                <span class="client-phone">${escapeHtml(facture.clientTelephone)}</span>
              ` : ''}
            </div>
          </td>
          <td>${dateFormatted}</td>
          <td class="montant">${formatPrice(facture.total)}</td>
          <td>
            <span class="status-badge ${statusClass}">
              <i class="fas fa-circle" style="font-size: 8px;"></i>
              ${statusText}
            </span>
          </td>
          <td>
            ${facture.ordonnanceCode ? 
              `<a href="#" onclick="viewOrdonnanceDetails('${facture.ordonnanceId}')" style="color: #006b3f; text-decoration: underline;">
                ${escapeHtml(facture.ordonnanceCode)}
              </a>` : 
              '<span style="color: #999;">—</span>'
            }
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view" data-id="${facture.id}" title="Voir">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon edit" data-id="${facture.id}" title="Modifier">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon print" data-id="${facture.id}" title="Imprimer">
                <i class="fas fa-print"></i>
              </button>
              <button class="btn-icon link" data-id="${facture.id}" title="Lier à une ordonnance">
                <i class="fas fa-link"></i>
              </button>
              <button class="btn-icon delete" data-id="${facture.id}" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Ajouter des écouteurs aux boutons d'action
      tbody.querySelectorAll('.btn-icon.view').forEach(btn => {
        btn.addEventListener('click', () => viewFacture(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.edit').forEach(btn => {
        btn.addEventListener('click', () => editFacture(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.print').forEach(btn => {
        btn.addEventListener('click', () => printFacture(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.link').forEach(btn => {
        btn.addEventListener('click', () => linkFactureToOrdonnance(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.delete').forEach(btn => {
        btn.addEventListener('click', () => confirmDeleteFacture(btn.dataset.id));
      });
      
      // Mettre à jour les cases à cocher
      tbody.querySelectorAll('.facture-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          if (this.checked) {
            selectedFactures.add(this.value);
          } else {
            selectedFactures.delete(this.value);
            document.getElementById('selectAllFactures').checked = false;
          }
        });
      });
      
      // Mettre à jour l'info de pagination
      document.getElementById('facturesPaginationInfo').textContent = 
        `Affichage de ${startIndex + 1} à ${Math.min(endIndex, filteredFactures.length)} sur ${filteredFactures.length} factures`;
      
      // Mettre à jour les contrôles de pagination
      document.getElementById('prevPageFactures').disabled = currentPage.factures === 1;
      document.getElementById('nextPageFactures').disabled = endIndex >= filteredFactures.length;
      
      // Générer les numéros de page
      updatePageNumbers('factures', filteredFactures.length);
    }

    // ========== GESTION DES ORDONNANCES ==========
    function renderOrdonnances() {
      const tbody = document.getElementById('ordonnancesTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      // Appliquer les filtres
      let filteredOrdonnances = [...ordonnances];
      
      // Filtre de recherche
      const searchTerm = document.getElementById('searchOrdonnances').value.toLowerCase();
      if (searchTerm) {
        filteredOrdonnances = filteredOrdonnances.filter(o => 
          o.code.toLowerCase().includes(searchTerm) ||
          o.patientNom.toLowerCase().includes(searchTerm) ||
          o.medecinNom.toLowerCase().includes(searchTerm) ||
          (o.patientTelephone && o.patientTelephone.includes(searchTerm))
        );
      }
      
      // Filtre par statut
      const statusFilter = document.getElementById('statusFilterOrdonnances').value;
      if (statusFilter) {
        filteredOrdonnances = filteredOrdonnances.filter(o => o.statut === statusFilter);
      }
      
      // Filtre par date
      const dateFilter = document.getElementById('dateFilterOrdonnances').value;
      if (dateFilter) {
        const now = new Date();
        filteredOrdonnances = filteredOrdonnances.filter(o => {
          const date = new Date(o.dateOrd);
          switch(dateFilter) {
            case 'today':
              return date.toDateString() === now.toDateString();
            case 'week':
              const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
              return date >= weekStart;
            case 'month':
              return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            default:
              return true;
          }
        });
      }
      
      // Pagination
      const startIndex = (currentPage.ordonnances - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedOrdonnances = filteredOrdonnances.slice(startIndex, endIndex);
      
      if (paginatedOrdonnances.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <i class="fas fa-prescription"></i>
                <h4>Aucune ordonnance trouvée</h4>
                <p>Essayez de modifier vos critères de recherche</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Rendre chaque ordonnance
      paginatedOrdonnances.forEach(ordonnance => {
        const row = document.createElement('tr');
        
        const dateFormatted = formatDate(ordonnance.dateOrd);
        
        let statusClass = '';
        let statusText = '';
        switch(ordonnance.statut) {
          case 'envoyee':
            statusClass = 'status-envoye';
            statusText = 'À traiter';
            break;
          case 'en_cours':
            statusClass = 'status-en_cours';
            statusText = 'En cours';
            break;
          case 'pret':
            statusClass = 'status-pret';
            statusText = 'Prête';
            break;
          case 'delivree':
            statusClass = 'status-delivree';
            statusText = 'Délivrée';
            break;
          case 'annulee':
            statusClass = 'status-annulee';
            statusText = 'Annulée';
            break;
        }
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="ordonnance-checkbox" value="${ordonnance.id}" 
                   ${selectedOrdonnances.has(ordonnance.id) ? 'checked' : ''}>
          </td>
          <td>
            <span class="ordonnance-num">${ordonnance.code}</span>
          </td>
          <td>
            <div class="patient-info">
              <span class="patient-name">${escapeHtml(ordonnance.patientNom)}</span>
              ${ordonnance.patientTelephone ? `
                <span class="patient-phone">${escapeHtml(ordonnance.patientTelephone)}</span>
              ` : ''}
            </div>
          </td>
          <td>${escapeHtml(ordonnance.medecinNom)}</td>
          <td>${dateFormatted}</td>
          <td>
            <span class="status-badge ${statusClass}">
              <i class="fas fa-circle" style="font-size: 8px;"></i>
              ${statusText}
            </span>
          </td>
          <td>
            ${ordonnance.factureAssociee ? 
              `<a href="#" onclick="viewFactureDetails('${ordonnance.factureId}')" style="color: #006b3f; text-decoration: underline;">
                ${escapeHtml(ordonnance.factureAssociee)}
              </a>` : 
              '<span style="color: #999;">—</span>'
            }
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view" data-id="${ordonnance.id}" title="Voir détails">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon edit" data-id="${ordonnance.id}" title="Modifier">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon print" data-id="${ordonnance.id}" title="Imprimer">
                <i class="fas fa-print"></i>
              </button>
              <button class="btn-icon link" data-id="${ordonnance.id}" title="Créer facture">
                <i class="fas fa-file-invoice-dollar"></i>
              </button>
              <button class="btn-icon delete" data-id="${ordonnance.id}" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Ajouter des écouteurs aux boutons d'action
      tbody.querySelectorAll('.btn-icon.view').forEach(btn => {
        btn.addEventListener('click', () => viewOrdonnanceDetails(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.edit').forEach(btn => {
        btn.addEventListener('click', () => editOrdonnance(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.print').forEach(btn => {
        btn.addEventListener('click', () => printOrdonnance(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.link').forEach(btn => {
        btn.addEventListener('click', () => createFactureFromOrdonnance(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-icon.delete').forEach(btn => {
        btn.addEventListener('click', () => confirmDeleteOrdonnance(btn.dataset.id));
      });
      
      // Mettre à jour les cases à cocher
      tbody.querySelectorAll('.ordonnance-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          if (this.checked) {
            selectedOrdonnances.add(this.value);
          } else {
            selectedOrdonnances.delete(this.value);
            document.getElementById('selectAllOrdonnances').checked = false;
          }
        });
      });
      
      // Mettre à jour l'info de pagination
      document.getElementById('ordonnancesPaginationInfo').textContent = 
        `Affichage de ${startIndex + 1} à ${Math.min(endIndex, filteredOrdonnances.length)} sur ${filteredOrdonnances.length} ordonnances`;
      
      // Mettre à jour les contrôles de pagination
      document.getElementById('prevPageOrdonnances').disabled = currentPage.ordonnances === 1;
      document.getElementById('nextPageOrdonnances').disabled = endIndex >= filteredOrdonnances.length;
      
      // Générer les numéros de page
      updatePageNumbers('ordonnances', filteredOrdonnances.length);
    }

    // ========== CONFIGURATION DES ÉCOUTEURS ==========
    function setupEventListeners() {
      console.log('🔧 Configuration des écouteurs d\'événements...');
      
      // Boutons du dashboard
      document.getElementById('quickNewFacture').addEventListener('click', openCreateFactureModal);
      document.getElementById('quickImportOrdonnance').addEventListener('click', openImportOrdonnanceModal);
      document.getElementById('quickGenerateReport').addEventListener('click', generateDailyReport);
      document.getElementById('quickSyncData').addEventListener('click', syncPharmacyData);
      
      // Boutons des factures
      document.getElementById('newFactureBtn').addEventListener('click', openCreateFactureModal);
      document.getElementById('importOrdonnanceBtn').addEventListener('click', openImportOrdonnanceModal);
      document.getElementById('exportFacturesBtn').addEventListener('click', exportFactures);
      document.getElementById('refreshFacturesBtn').addEventListener('click', () => renderFactures());
      
      // Boutons des ordonnances
      document.getElementById('newOrdonnanceBtn').addEventListener('click', openCreateOrdonnanceModal);
      document.getElementById('scanOrdonnanceBtn').addEventListener('click', scanQRCode);
      document.getElementById('exportOrdonnancesBtn').addEventListener('click', exportOrdonnances);
      document.getElementById('refreshOrdonnancesBtn').addEventListener('click', () => renderOrdonnances());
      
      // Boutons de fermeture de modal
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', closeModal);
      });
      
      // Boutons d'annulation
      document.getElementById('cancelFactureBtn').addEventListener('click', closeModal);
      document.getElementById('cancelOrdonnanceBtn').addEventListener('click', closeModal);
      document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);
      document.getElementById('cancelImportBtn').addEventListener('click', closeModal);
      document.getElementById('cancelSyncBtn').addEventListener('click', closeModal);
      document.getElementById('retrySyncBtn').addEventListener('click', syncPharmacyData);
      
      // Boutons de sauvegarde
      document.getElementById('saveFactureBtn').addEventListener('click', saveFacture);
      document.getElementById('saveOrdonnanceBtn').addEventListener('click', saveOrdonnance);
      
      // Boutons d'importation
      document.getElementById('confirmImportBtn').addEventListener('click', importOrdonnanceToFacture);
      
      // Sélection multiple
      document.getElementById('selectAllFactures').addEventListener('change', toggleSelectAllFactures);
      document.getElementById('selectAllOrdonnances').addEventListener('change', toggleSelectAllOrdonnances);
      
      // Recherche et filtres
      document.getElementById('searchFactures').addEventListener('input', debounce(renderFactures, 300));
      document.getElementById('statusFilterFactures').addEventListener('change', renderFactures);
      document.getElementById('dateFilterFactures').addEventListener('change', renderFactures);
      
      document.getElementById('searchOrdonnances').addEventListener('input', debounce(renderOrdonnances, 300));
      document.getElementById('statusFilterOrdonnances').addEventListener('change', renderOrdonnances);
      document.getElementById('dateFilterOrdonnances').addEventListener('change', renderOrdonnances);
      
      // Médicaments
      document.getElementById('addMedicamentBtn').addEventListener('click', addMedicamentRow);
      document.getElementById('addOrdonnanceMedicamentBtn').addEventListener('click', addOrdonnanceMedicamentRow);
      
      // Calcul en temps réel
      document.addEventListener('input', function(e) {
        if (e.target.classList.contains('medicament-quantite') || 
            e.target.classList.contains('medicament-prix') ||
            e.target.id === 'remise') {
          calculateTotal();
        }
      });
      
      // Lier ordonnance
      document.getElementById('linkOrdonnanceBtn').addEventListener('click', linkOrdonnanceToFacture);
      
      // Créer facture depuis ordonnance
      document.getElementById('createFactureFromOrdonnanceBtn').addEventListener('click', createFactureFromCurrentOrdonnance);
      
      // Pagination
      document.getElementById('prevPageFactures').addEventListener('click', () => changePage('factures', currentPage.factures - 1));
      document.getElementById('nextPageFactures').addEventListener('click', () => changePage('factures', currentPage.factures + 1));
      document.getElementById('prevPageOrdonnances').addEventListener('click', () => changePage('ordonnances', currentPage.ordonnances - 1));
      document.getElementById('nextPageOrdonnances').addEventListener('click', () => changePage('ordonnances', currentPage.ordonnances + 1));
      
      // Prévisualisation d'importation
      document.getElementById('selectOrdonnanceImport').addEventListener('change', previewOrdonnanceImport);
      
      console.log('✅ Écouteurs d\'événements configurés');
    }

    // ========== FONCTIONS MODALES ==========
    function generateFactureNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      
      const count = factures.filter(f => 
        f.numeroFacture && f.numeroFacture.includes(`FACT-${year}${month}`)
      ).length + 1;
      
      const factureNum = `FACT-${year}${month}${String(count).padStart(3, '0')}`;
      document.getElementById('numeroFacture').value = factureNum;
    }

    function generateOrdonnanceCode() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      
      const count = ordonnances.filter(o => 
        o.code && o.code.includes(`ORD-${year}${month}`)
      ).length + 1;
      
      const ordonnanceCode = `ORD-${year}${month}${String(count).padStart(3, '0')}`;
      document.getElementById('codeOrdonnance').value = ordonnanceCode;
    }

    function addMedicamentRow() {
      const container = document.getElementById('medicamentsContainer');
      const rowCount = container.children.length;
      const rowId = `medicament-${rowCount + 1}`;
      
      const row = document.createElement('div');
      row.className = 'medicament-row';
      row.id = rowId;
      row.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;';
      
      row.innerHTML = `
        <div class="form-row">
          <div class="form-group">
            <label>Médicament</label>
            <input type="text" class="form-control medicament-nom" placeholder="Nom du médicament" required>
          </div>
          <div class="form-group">
            <label>Dosage</label>
            <input type="text" class="form-control medicament-dosage" placeholder="Ex: 500mg">
          </div>
          <div class="form-group">
            <label>Quantité</label>
            <input type="number" class="form-control medicament-quantite" min="1" value="1" step="1" required>
          </div>
          <div class="form-group">
            <label>Prix unitaire (FCF)</label>
            <input type="number" class="form-control medicament-prix" min="0" value="0" step="100" required>
          </div>
          <div class="form-group" style="align-self: flex-end;">
            <button type="button" class="btn btn-danger remove-medicament-btn" data-row="${rowId}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      container.appendChild(row);
      
      // Ajouter l'écouteur pour le bouton de suppression
      row.querySelector('.remove-medicament-btn').addEventListener('click', function() {
        removeMedicamentRow(this.dataset.row);
      });
      
      // Ajouter des écouteurs pour le calcul en temps réel
      row.querySelector('.medicament-quantite').addEventListener('input', calculateTotal);
      row.querySelector('.medicament-prix').addEventListener('input', calculateTotal);
      
      calculateTotal();
    }

    function addOrdonnanceMedicamentRow() {
      const container = document.getElementById('ordonnanceMedicamentsContainer');
      const rowCount = container.children.length;
      const rowId = `ordonnance-medicament-${rowCount + 1}`;
      
      const row = document.createElement('div');
      row.className = 'ordonnance-medicament-row';
      row.id = rowId;
      row.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;';
      
      row.innerHTML = `
        <div class="form-row">
          <div class="form-group">
            <label>Médicament *</label>
            <input type="text" class="form-control ordonnance-medicament-nom" placeholder="Nom du médicament" required>
          </div>
          <div class="form-group">
            <label>Dosage</label>
            <input type="text" class="form-control ordonnance-medicament-dosage" placeholder="Ex: 500mg">
          </div>
          <div class="form-group">
            <label>Posologie</label>
            <input type="text" class="form-control ordonnance-medicament-posologie" placeholder="Ex: 1 comprimé 3 fois/jour">
          </div>
          <div class="form-group">
            <label>Quantité</label>
            <input type="number" class="form-control ordonnance-medicament-quantite" min="1" value="1" step="1">
          </div>
          <div class="form-group">
            <label>Durée</label>
            <input type="text" class="form-control ordonnance-medicament-duree" placeholder="Ex: 7 jours">
          </div>
          <div class="form-group" style="align-self: flex-end;">
            <button type="button" class="btn btn-danger remove-ordonnance-medicament-btn" data-row="${rowId}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      container.appendChild(row);
      
      // Ajouter l'écouteur pour le bouton de suppression
      row.querySelector('.remove-ordonnance-medicament-btn').addEventListener('click', function() {
        const rowToRemove = document.getElementById(this.dataset.row);
        if (rowToRemove && container.children.length > 1) {
          rowToRemove.remove();
        }
      });
    }

    function removeMedicamentRow(rowId) {
      const row = document.getElementById(rowId);
      if (row && document.querySelectorAll('.medicament-row').length > 1) {
        row.remove();
        calculateTotal();
      }
    }

    function calculateTotal() {
      let sousTotal = 0;
      
      document.querySelectorAll('.medicament-row').forEach(row => {
        const quantite = parseFloat(row.querySelector('.medicament-quantite').value) || 0;
        const prix = parseFloat(row.querySelector('.medicament-prix').value) || 0;
        sousTotal += quantite * prix;
      });
      
      const tva = sousTotal * 0.16;
      const remise = parseFloat(document.getElementById('remise').value) || 0;
      const total = sousTotal + tva - remise;
      
      document.getElementById('sousTotal').textContent = formatPrice(sousTotal);
      document.getElementById('tva').textContent = formatPrice(tva);
      document.getElementById('total').textContent = formatPrice(total);
    }

    function openCreateFactureModal() {
      editingFactureId = null;
      document.getElementById('modalFactureTitle').innerHTML = '<i class="fas fa-file-invoice-dollar"></i> Nouvelle Facture';
      document.getElementById('factureForm').reset();
      document.getElementById('printFactureBtn').style.display = 'none';
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateFacturation').value = today;
      
      generateFactureNumber();
      
      const medicamentsContainer = document.getElementById('medicamentsContainer');
      medicamentsContainer.innerHTML = '';
      addMedicamentRow();
      
      document.getElementById('remise').value = 0;
      calculateTotal();
      
      openModal('factureModal');
    }

    function openCreateOrdonnanceModal() {
      editingOrdonnanceId = null;
      document.getElementById('modalOrdonnanceTitle').innerHTML = '<i class="fas fa-prescription"></i> Nouvelle Ordonnance';
      document.getElementById('ordonnanceForm').reset();
      document.getElementById('createFactureFromOrdonnanceBtn').style.display = 'none';
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateOrdonnance').value = today;
      
      generateOrdonnanceCode();
      
      const medicamentsContainer = document.getElementById('ordonnanceMedicamentsContainer');
      medicamentsContainer.innerHTML = '';
      addOrdonnanceMedicamentRow();
      
      openModal('ordonnanceModal');
    }

    function openImportOrdonnanceModal() {
      const select = document.getElementById('selectOrdonnanceImport');
      select.innerHTML = '<option value="">Choisir une ordonnance...</option>';
      
      // Filtrer les ordonnances non liées à une facture
      const ordonnancesNonLiees = ordonnances.filter(o => !o.factureAssociee);
      
      if (ordonnancesNonLiees.length === 0) {
        select.innerHTML += '<option value="" disabled>Aucune ordonnance disponible</option>';
        showNotification('Aucune ordonnance disponible pour l\'importation', 'warning');
        return;
      }
      
      ordonnancesNonLiees.forEach((ord, index) => {
        const option = document.createElement('option');
        option.value = ord.id;
        option.textContent = `${ord.code} - ${ord.patientNom} (${formatDate(ord.dateOrd)})`;
        select.appendChild(option);
      });
      
      document.getElementById('ordonnanceImportPreview').style.display = 'none';
      openModal('importOrdonnanceModal');
    }

    function previewOrdonnanceImport() {
      const ordId = document.getElementById('selectOrdonnanceImport').value;
      const preview = document.getElementById('ordonnanceImportPreview');
      
      if (!ordId) {
        preview.style.display = 'none';
        return;
      }
      
      const ordonnance = ordonnances.find(o => o.id === ordId);
      if (ordonnance) {
        preview.innerHTML = `
          <h4>Aperçu de l'ordonnance</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <div>
              <strong>Patient:</strong> ${escapeHtml(ordonnance.patientNom)}<br>
              <strong>Âge:</strong> ${ordonnance.patientAge || 'Non spécifié'}<br>
              <strong>Téléphone:</strong> ${ordonnance.patientTelephone || 'Non spécifié'}
            </div>
            <div>
              <strong>Médecin:</strong> ${escapeHtml(ordonnance.medecinNom)}<br>
              <strong>Date:</strong> ${formatDate(ordonnance.dateOrd)}<br>
              <strong>Médicaments:</strong> ${ordonnance.medicaments.length}
            </div>
          </div>
          <div style="margin-top: 10px;">
            <strong>Liste des médicaments:</strong>
            <ul style="margin-top: 5px; padding-left: 20px;">
              ${ordonnance.medicaments.map(m => `<li>${escapeHtml(m.nom)} (${m.dosage || '—'})</li>`).join('')}
            </ul>
          </div>
        `;
        preview.style.display = 'block';
      }
    }

    function importOrdonnanceToFacture() {
      const ordId = document.getElementById('selectOrdonnanceImport').value;
      if (!ordId) {
        showNotification('Veuillez sélectionner une ordonnance', 'warning');
        return;
      }
      
      const ordonnance = ordonnances.find(o => o.id === ordId);
      if (!ordonnance) {
        showNotification('Ordonnance non trouvée', 'error');
        return;
      }
      
      // Fermer le modal d'importation
      closeModal();
      
      // Ouvrir le modal de facture
      openCreateFactureModal();
      
      // Remplir les informations
      const importPatientInfo = document.getElementById('importPatientInfo').checked;
      const importMedicaments = document.getElementById('importMedicaments').checked;
      const autoCalculatePrices = document.getElementById('autoCalculatePrices').checked;
      
      if (importPatientInfo) {
        document.getElementById('clientNom').value = ordonnance.patientNom;
        document.getElementById('clientTelephone').value = ordonnance.patientTelephone || '';
        document.getElementById('clientAdresse').value = ordonnance.patientAdresse || '';
      }
      
      document.getElementById('ordonnanceCode').value = ordonnance.code;
      
      if (importMedicaments) {
        const medicamentsContainer = document.getElementById('medicamentsContainer');
        medicamentsContainer.innerHTML = '';
        
        ordonnance.medicaments.forEach((med, index) => {
          addMedicamentRow();
          const lastRow = medicamentsContainer.children[index];
          if (lastRow) {
            lastRow.querySelector('.medicament-nom').value = med.nom;
            lastRow.querySelector('.medicament-dosage').value = med.dosage || '';
            lastRow.querySelector('.medicament-quantite').value = med.quantite || 1;
            
            if (autoCalculatePrices) {
              const prix = calculatePrixFromMedicament(med.nom);
              lastRow.querySelector('.medicament-prix').value = prix;
            } else {
              lastRow.querySelector('.medicament-prix').value = 0;
            }
          }
        });
        
        calculateTotal();
      }
      
      showNotification(`Ordonnance ${ordonnance.code} importée avec succès`, 'success');
    }

    function calculatePrixFromMedicament(nomMedicament) {
      const nom = nomMedicament.toLowerCase();
      const prixBase = {
        'paracétamol': 500,
        'doliprane': 600,
        'ibuprofène': 750,
        'aspirine': 600,
        'amoxicilline': 2500,
        'vitamine': 1500,
        'coartem': 3500,
        'nivaquine': 1200
      };
      
      for (const [key, prix] of Object.entries(prixBase)) {
        if (nom.includes(key)) {
          return prix;
        }
      }
      
      return 1000;
    }

    function saveFacture() {
      if (!validateFactureForm()) return;
      
      const formData = {
        id: editingFactureId || 'facture_' + Date.now(),
        numeroFacture: document.getElementById('numeroFacture').value,
        clientNom: document.getElementById('clientNom').value,
        clientTelephone: document.getElementById('clientTelephone').value,
        clientEmail: document.getElementById('clientEmail').value,
        clientAdresse: document.getElementById('clientAdresse').value,
        dateFacturation: document.getElementById('dateFacturation').value,
        dateLimitePaiement: document.getElementById('dateLimitePaiement').value || null,
        ordonnanceCode: document.getElementById('ordonnanceCode').value || null,
        statut: document.getElementById('statutFacture').value,
        methodePaiement: document.getElementById('methodePaiement').value || null,
        remarques: document.getElementById('remarquesFacture').value,
        pharmacienNom: 'Pharmacie RDC',
        
        medicaments: [],
        sousTotal: 0,
        tva: 0,
        remise: parseFloat(document.getElementById('remise').value) || 0,
        total: 0,
        
        createdAt: editingFactureId ? 
          factures.find(f => f.id === editingFactureId)?.createdAt || new Date().toISOString() : 
          new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // Calculer les médicaments
      let sousTotal = 0;
      document.querySelectorAll('.medicament-row').forEach(row => {
        const medicament = {
          nom: row.querySelector('.medicament-nom').value,
          dosage: row.querySelector('.medicament-dosage').value,
          quantite: parseFloat(row.querySelector('.medicament-quantite').value) || 1,
          prix: parseFloat(row.querySelector('.medicament-prix').value) || 0
        };
        formData.medicaments.push(medicament);
        sousTotal += medicament.quantite * medicament.prix;
      });
      
      formData.sousTotal = sousTotal;
      formData.tva = sousTotal * 0.16;
      formData.total = sousTotal + formData.tva - formData.remise;
      
      // Trouver l'ordonnance liée
      if (formData.ordonnanceCode) {
        const ordonnanceLiee = ordonnances.find(o => o.code === formData.ordonnanceCode);
        if (ordonnanceLiee) {
          formData.ordonnanceId = ordonnanceLiee.id;
          
          // Mettre à jour l'ordonnance avec la référence de la facture
          ordonnanceLiee.factureAssociee = formData.numeroFacture;
          ordonnanceLiee.factureId = formData.id;
          ordonnanceLiee.updatedAt = new Date().toISOString();
          saveOrdonnances();
        }
      }
      
      // Sauvegarder la facture
      if (editingFactureId) {
        const index = factures.findIndex(f => f.id === editingFactureId);
        if (index !== -1) {
          factures[index] = formData;
        }
        showNotification('Facture mise à jour avec succès', 'success');
      } else {
        factures.unshift(formData);
        showNotification('Facture créée avec succès', 'success');
      }
      
      saveFactures();
      closeModal();
      renderFactures();
      updateDashboard();
      updateNavigation();
      
      // Synchroniser avec le système de détails
      syncPharmacyData();
    }

    function saveOrdonnance() {
      if (!validateOrdonnanceForm()) return;
      
      const formData = {
        id: editingOrdonnanceId || 'ordonnance_' + Date.now(),
        code: document.getElementById('codeOrdonnance').value,
        patientNom: document.getElementById('patientNom').value,
        patientAge: document.getElementById('patientAge').value || null,
        patientGenre: document.getElementById('patientGenre').value || null,
        patientTelephone: document.getElementById('patientTelephone').value || null,
        patientAdresse: document.getElementById('patientAdresse').value || null,
        medecinNom: document.getElementById('medecinNom').value,
        medecinSpecialite: document.getElementById('medecinSpecialite').value || null,
        dateOrd: document.getElementById('dateOrdonnance').value,
        statut: document.getElementById('statutOrdonnance').value,
        instructions: document.getElementById('instructions').value || null,
        pharmacieNom: 'Pharmacie RDC',
        
        medicaments: [],
        
        createdAt: editingOrdonnanceId ? 
          ordonnances.find(o => o.id === editingOrdonnanceId)?.createdAt || new Date().toISOString() : 
          new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // Récupérer les médicaments
      document.querySelectorAll('.ordonnance-medicament-row').forEach(row => {
        const medicament = {
          nom: row.querySelector('.ordonnance-medicament-nom').value,
          dosage: row.querySelector('.ordonnance-medicament-dosage').value || null,
          posologie: row.querySelector('.ordonnance-medicament-posologie').value || null,
          quantite: parseFloat(row.querySelector('.ordonnance-medicament-quantite').value) || 1,
          duree: row.querySelector('.ordonnance-medicament-duree').value || null
        };
        formData.medicaments.push(medicament);
      });
      
      // Sauvegarder l'ordonnance
      if (editingOrdonnanceId) {
        const index = ordonnances.findIndex(o => o.id === editingOrdonnanceId);
        if (index !== -1) {
          ordonnances[index] = formData;
        }
        showNotification('Ordonnance mise à jour avec succès', 'success');
      } else {
        ordonnances.unshift(formData);
        showNotification('Ordonnance créée avec succès', 'success');
      }
      
      saveOrdonnances();
      closeModal();
      renderOrdonnances();
      updateDashboard();
      updateNavigation();
      
      // Synchroniser avec le système de détails
      syncPharmacyData();
    }

    function validateFactureForm() {
      const requiredFields = [
        { id: 'numeroFacture', name: 'Numéro de facture' },
        { id: 'dateFacturation', name: 'Date de facturation' },
        { id: 'clientNom', name: 'Nom du client' }
      ];
      
      for (const field of requiredFields) {
        const element = document.getElementById(field.id);
        if (!element.value.trim()) {
          showNotification(`Le champ "${field.name}" est requis`, 'error');
          element.focus();
          return false;
        }
      }
      
      const medicaments = document.querySelectorAll('.medicament-row');
      let hasValidMedicament = false;
      
      medicaments.forEach(row => {
        const nom = row.querySelector('.medicament-nom').value.trim();
        const quantite = parseFloat(row.querySelector('.medicament-quantite').value) || 0;
        const prix = parseFloat(row.querySelector('.medicament-prix').value) || 0;
        
        if (nom && quantite > 0 && prix > 0) {
          hasValidMedicament = true;
        }
      });
      
      if (!hasValidMedicament) {
        showNotification('Ajoutez au moins un médicament valide', 'error');
        return false;
      }
      
      return true;
    }

    function validateOrdonnanceForm() {
      const requiredFields = [
        { id: 'codeOrdonnance', name: 'Code d\'ordonnance' },
        { id: 'dateOrdonnance', name: 'Date de prescription' },
        { id: 'patientNom', name: 'Nom du patient' },
        { id: 'medecinNom', name: 'Nom du médecin' }
      ];
      
      for (const field of requiredFields) {
        const element = document.getElementById(field.id);
        if (!element.value.trim()) {
          showNotification(`Le champ "${field.name}" est requis`, 'error');
          element.focus();
          return false;
        }
      }
      
      const medicaments = document.querySelectorAll('.ordonnance-medicament-row');
      let hasValidMedicament = false;
      
      medicaments.forEach(row => {
        const nom = row.querySelector('.ordonnance-medicament-nom').value.trim();
        if (nom) {
          hasValidMedicament = true;
        }
      });
      
      if (!hasValidMedicament) {
        showNotification('Ajoutez au moins un médicament', 'error');
        return false;
      }
      
      return true;
    }

    function viewFacture(factureId) {
      const facture = factures.find(f => f.id === factureId);
      if (!facture) return;
      
      editFacture(factureId);
      document.querySelectorAll('#factureForm input, #factureForm select, #factureForm textarea').forEach(el => {
        el.disabled = true;
      });
      document.getElementById('saveFactureBtn').style.display = 'none';
      document.getElementById('printFactureBtn').style.display = 'inline-flex';
      document.getElementById('modalFactureTitle').innerHTML = `<i class="fas fa-file-invoice-dollar"></i> Facture ${facture.numeroFacture}`;
    }

    function editFacture(factureId) {
      const facture = factures.find(f => f.id === factureId);
      if (!facture) return;
      
      editingFactureId = factureId;
      document.getElementById('modalFactureTitle').innerHTML = `<i class="fas fa-file-invoice-dollar"></i> Modifier ${facture.numeroFacture}`;
      document.getElementById('printFactureBtn').style.display = 'inline-flex';
      
      // Remplir le formulaire
      document.getElementById('numeroFacture').value = facture.numeroFacture;
      document.getElementById('clientNom').value = facture.clientNom;
      document.getElementById('clientTelephone').value = facture.clientTelephone || '';
      document.getElementById('clientEmail').value = facture.clientEmail || '';
      document.getElementById('clientAdresse').value = facture.clientAdresse || '';
      document.getElementById('dateFacturation').value = facture.dateFacturation.split('T')[0];
      document.getElementById('dateLimitePaiement').value = facture.dateLimitePaiement ? 
        facture.dateLimitePaiement.split('T')[0] : '';
      document.getElementById('ordonnanceCode').value = facture.ordonnanceCode || '';
      document.getElementById('statutFacture').value = facture.statut;
      document.getElementById('methodePaiement').value = facture.methodePaiement || '';
      document.getElementById('remarquesFacture').value = facture.remarques || '';
      document.getElementById('remise').value = facture.remise || 0;
      
      // Remplir les médicaments
      const medicamentsContainer = document.getElementById('medicamentsContainer');
      medicamentsContainer.innerHTML = '';
      
      facture.medicaments.forEach((med, index) => {
        addMedicamentRow();
        const row = medicamentsContainer.children[index];
        if (row) {
          row.querySelector('.medicament-nom').value = med.nom;
          row.querySelector('.medicament-dosage').value = med.dosage || '';
          row.querySelector('.medicament-quantite').value = med.quantite;
          row.querySelector('.medicament-prix').value = med.prix;
        }
      });
      
      calculateTotal();
      openModal('factureModal');
      
      // Réactiver tous les champs
      document.querySelectorAll('#factureForm input, #factureForm select, #factureForm textarea').forEach(el => {
        el.disabled = false;
      });
      document.getElementById('saveFactureBtn').style.display = 'inline-flex';
    }

    function linkOrdonnanceToFacture() {
      const ordonnanceCode = document.getElementById('ordonnanceCode').value;
      if (!ordonnanceCode) {
        showNotification('Veuillez entrer un code d\'ordonnance', 'warning');
        return;
      }
      
      const ordonnance = ordonnances.find(o => o.code === ordonnanceCode);
      if (!ordonnance) {
        showNotification('Ordonnance non trouvée', 'error');
        return;
      }
      
      if (ordonnance.factureAssociee && editingFactureId) {
        const currentFacture = factures.find(f => f.id === editingFactureId);
        if (currentFacture && currentFacture.numeroFacture !== ordonnance.factureAssociee) {
          if (!confirm(`Cette ordonnance est déjà liée à la facture ${ordonnance.factureAssociee}. Voulez-vous la relier à cette facture ?`)) {
            return;
          }
        }
      }
      
      // Remplir automatiquement les informations du patient
      document.getElementById('clientNom').value = ordonnance.patientNom;
      document.getElementById('clientTelephone').value = ordonnance.patientTelephone || '';
      document.getElementById('clientAdresse').value = ordonnance.patientAdresse || '';
      
      showNotification(`Ordonnance ${ordonnanceCode} liée avec succès`, 'success');
    }

    function linkFactureToOrdonnance(factureId) {
      const facture = factures.find(f => f.id === factureId);
      if (!facture) return;
      
      editingFactureId = factureId;
      
      // Ouvrir le modal avec la facture pré-remplie
      editFacture(factureId);
      
      // Focus sur le champ de code d'ordonnance
      setTimeout(() => {
        document.getElementById('ordonnanceCode').focus();
      }, 500);
    }

    function createFactureFromOrdonnance(ordonnanceId) {
      const ordonnance = ordonnances.find(o => o.id === ordonnanceId);
      if (!ordonnance) return;
      
      // Si l'ordonnance a déjà une facture, demander confirmation
      if (ordonnance.factureAssociee) {
        if (!confirm(`Cette ordonnance est déjà liée à la facture ${ordonnance.factureAssociee}. Voulez-vous créer une nouvelle facture ?`)) {
          return;
        }
      }
      
      closeModal();
      openCreateFactureModal();
      
      // Pré-remplir avec les données de l'ordonnance
      document.getElementById('clientNom').value = ordonnance.patientNom;
      document.getElementById('clientTelephone').value = ordonnance.patientTelephone || '';
      document.getElementById('clientAdresse').value = ordonnance.patientAdresse || '';
      document.getElementById('ordonnanceCode').value = ordonnance.code;
      
      // Ajouter les médicaments avec prix automatiques
      const medicamentsContainer = document.getElementById('medicamentsContainer');
      medicamentsContainer.innerHTML = '';
      
      ordonnance.medicaments.forEach((med, index) => {
        addMedicamentRow();
        const lastRow = medicamentsContainer.children[index];
        if (lastRow) {
          lastRow.querySelector('.medicament-nom').value = med.nom;
          lastRow.querySelector('.medicament-dosage').value = med.dosage || '';
          lastRow.querySelector('.medicament-quantite').value = med.quantite || 1;
          
          const prix = calculatePrixFromMedicament(med.nom);
          lastRow.querySelector('.medicament-prix').value = prix;
        }
      });
      
      calculateTotal();
      
      showNotification(`Facture créée à partir de l'ordonnance ${ordonnance.code}`, 'success');
    }

    function createFactureFromCurrentOrdonnance() {
      if (!editingOrdonnanceId) return;
      
      createFactureFromOrdonnance(editingOrdonnanceId);
      closeModal();
    }

    function confirmDeleteFacture(factureId) {
      const facture = factures.find(f => f.id === factureId);
      if (!facture) return;
      
      document.getElementById('confirmMessage').textContent = 
        `Êtes-vous sûr de vouloir supprimer la facture ${facture.numeroFacture} ? Cette action est irréversible.`;
      
      document.getElementById('confirmActionBtn').onclick = () => {
        deleteFacture(factureId);
        closeConfirmModal();
      };
      
      openModal('confirmModal');
    }

    function confirmDeleteOrdonnance(ordonnanceId) {
      const ordonnance = ordonnances.find(o => o.id === ordonnanceId);
      if (!ordonnance) return;
      
      let warning = '';
      if (ordonnance.factureAssociee) {
        warning = `<br><br><strong>Attention :</strong> Cette ordonnance est liée à la facture ${ordonnance.factureAssociee}.`;
      }
      
      document.getElementById('confirmMessage').innerHTML = 
        `Êtes-vous sûr de vouloir supprimer l'ordonnance ${ordonnance.code} ?${warning}`;
      
      document.getElementById('confirmActionBtn').onclick = () => {
        deleteOrdonnance(ordonnanceId);
        closeConfirmModal();
      };
      
      openModal('confirmModal');
    }

    function deleteFacture(factureId) {
      const index = factures.findIndex(f => f.id === factureId);
      if (index === -1) return;
      
      const facture = factures[index];
      
      // Retirer la référence de la facture dans l'ordonnance liée
      if (facture.ordonnanceCode) {
        const ordonnance = ordonnances.find(o => o.code === facture.ordonnanceCode);
        if (ordonnance) {
          ordonnance.factureAssociee = null;
          ordonnance.factureId = null;
          ordonnance.updatedAt = new Date().toISOString();
          saveOrdonnances();
        }
      }
      
      factures.splice(index, 1);
      saveFactures();
      renderFactures();
      updateDashboard();
      showNotification('Facture supprimée avec succès', 'success');
      
      // Synchroniser avec le système de détails
      syncPharmacyData();
    }

    function deleteOrdonnance(ordonnanceId) {
      const index = ordonnances.findIndex(o => o.id === ordonnanceId);
      if (index === -1) return;
      
      const ordonnance = ordonnances[index];
      
      // Retirer la référence de l'ordonnance dans la facture liée
      if (ordonnance.factureId) {
        const facture = factures.find(f => f.id === ordonnance.factureId);
        if (facture) {
          facture.ordonnanceCode = null;
          facture.ordonnanceId = null;
          facture.updatedAt = new Date().toISOString();
          saveFactures();
        }
      }
      
      ordonnances.splice(index, 1);
      saveOrdonnances();
      renderOrdonnances();
      updateDashboard();
      showNotification('Ordonnance supprimée avec succès', 'success');
      
      // Synchroniser avec le système de détails
      syncPharmacyData();
    }

    function printFacture(factureId) {
      const facture = factures.find(f => f.id === factureId);
      if (!facture) return;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(generateFacturePrintHTML(facture));
      printWindow.document.close();
      printWindow.focus();
      
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    function printOrdonnance(ordonnanceId) {
      const ordonnance = ordonnances.find(o => o.id === ordonnanceId);
      if (!ordonnance) return;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(generateOrdonnancePrintHTML(ordonnance));
      printWindow.document.close();
      printWindow.focus();
      
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    function generateFacturePrintHTML(facture) {
      const dateFacturation = formatDate(facture.dateFacturation);
      const dateLimite = facture.dateLimitePaiement ? 
        formatDate(facture.dateLimitePaiement) : 'Non spécifiée';
      
      return `
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <title>Facture ${facture.numeroFacture}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
            .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #006b3f; padding-bottom: 20px; }
            .header h1 { color: #006b3f; margin-bottom: 10px; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0; }
            .info-box { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #006b3f; }
            table { width: 100%; border-collapse: collapse; margin: 30px 0; }
            th { background: #006b3f; color: white; padding: 12px; text-align: left; }
            td { padding: 10px 12px; border-bottom: 1px solid #ddd; }
            .total-row { font-weight: bold; background: #f8f9fa; }
            .footer { margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #666; }
            .signature { margin-top: 80px; display: flex; justify-content: space-between; }
            .stamp { border: 2px solid red; padding: 10px 20px; transform: rotate(-15deg); color: red; font-weight: bold; }
            @media print { 
              body { margin: 20px; font-size: 12px; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>FACTURE PHARMACEUTIQUE - PHARMACIE RDC</h1>
            <h2>${facture.numeroFacture}</h2>
            <p>Date: ${dateFacturation}</p>
          </div>
          
          <div class="info-grid">
            <div class="info-box">
              <h3>PHARMACIE RDC</h3>
              <p><strong>Nom:</strong> Pharmacie RDC</p>
              <p><strong>Pharmacien:</strong> ${facture.pharmacienNom}</p>
              <p><strong>Tél:</strong> +243 81 234 5678</p>
              <p><strong>Adresse:</strong> Av. de la Pharmacie, Kinshasa, RDC</p>
            </div>
            <div class="info-box">
              <h3>CLIENT</h3>
              <p><strong>Nom:</strong> ${escapeHtml(facture.clientNom)}</p>
              ${facture.clientTelephone ? `<p><strong>Téléphone:</strong> ${escapeHtml(facture.clientTelephone)}</p>` : ''}
              ${facture.clientEmail ? `<p><strong>Email:</strong> ${escapeHtml(facture.clientEmail)}</p>` : ''}
              ${facture.clientAdresse ? `<p><strong>Adresse:</strong> ${escapeHtml(facture.clientAdresse)}</p>` : ''}
              ${facture.ordonnanceCode ? `<p><strong>Ordonnance:</strong> ${escapeHtml(facture.ordonnanceCode)}</p>` : ''}
            </div>
          </div>
          
          <h3>DÉTAIL DES MÉDICAMENTS</h3>
          <table>
            <thead>
              <tr>
                <th>Médicament</th>
                <th>Dosage</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${facture.medicaments.map(item => `
                <tr>
                  <td>${escapeHtml(item.nom)}</td>
                  <td>${escapeHtml(item.dosage || '—')}</td>
                  <td>${item.quantite}</td>
                  <td>${formatPrice(item.prix)}</td>
                  <td>${formatPrice(item.prix * item.quantite)}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="4" style="text-align: right;">Sous-total:</td>
                <td>${formatPrice(facture.sousTotal)}</td>
              </tr>
              <tr class="total-row">
                <td colspan="4" style="text-align: right;">TVA (16%):</td>
                <td>${formatPrice(facture.tva)}</td>
              </tr>
              ${facture.remise > 0 ? `
                <tr class="total-row">
                  <td colspan="4" style="text-align: right;">Remise:</td>
                  <td>-${formatPrice(facture.remise)}</td>
                </tr>
              ` : ''}
              <tr class="total-row">
                <td colspan="4" style="text-align: right;"><strong>TOTAL:</strong></td>
                <td><strong>${formatPrice(facture.total)}</strong></td>
              </tr>
            </tfoot>
          </table>
          
          <div class="info-box">
            <h3>INFORMATIONS DE PAIEMENT</h3>
            <p><strong>Statut:</strong> ${getStatusText(facture.statut)}</p>
            <p><strong>Méthode de paiement:</strong> ${getPaymentMethodText(facture.methodePaiement)}</p>
            <p><strong>Date limite de paiement:</strong> ${dateLimite}</p>
            ${facture.remarques ? `<p><strong>Remarques:</strong> ${escapeHtml(facture.remarques)}</p>` : ''}
          </div>
          
          <div class="signature">
            <div>
              <p>Signature du pharmacien:</p>
              <p>_________________________</p>
              <p style="margin-top: 10px;">${facture.pharmacienNom}</p>
            </div>
            ${facture.statut === 'payee' ? `
              <div class="stamp">
                PAYÉ<br>
                ${dateFacturation}
              </div>
            ` : ''}
          </div>
          
          <div class="footer">
            <p>Merci de votre confiance !</p>
            <p><small>Facture générée le ${new Date().toLocaleDateString('fr-FR')} par Pharmacie RDC</small></p>
          </div>
        </body>
        </html>
      `;
    }

    function generateOrdonnancePrintHTML(ordonnance) {
      const dateOrd = formatDate(ordonnance.dateOrd);
      
      return `
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <title>Ordonnance ${ordonnance.code}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
            .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #2a5298; padding-bottom: 20px; }
            .header h1 { color: #2a5298; margin-bottom: 10px; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0; }
            .info-box { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #2a5298; }
            table { width: 100%; border-collapse: collapse; margin: 30px 0; }
            th { background: #2a5298; color: white; padding: 12px; text-align: left; }
            td { padding: 10px 12px; border-bottom: 1px solid #ddd; }
            .medicament-card { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #3498db; }
            .footer { margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #666; }
            .signature { margin-top: 80px; display: flex; justify-content: space-between; }
            @media print { 
              body { margin: 20px; font-size: 12px; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>ORDONNANCE MÉDICALE</h1>
            <h2>${ordonnance.code}</h2>
            <p>Date de prescription: ${dateOrd}</p>
          </div>
          
          <div class="info-grid">
            <div class="info-box">
              <h3>INFORMATIONS PATIENT</h3>
              <p><strong>Nom:</strong> ${escapeHtml(ordonnance.patientNom)}</p>
              <p><strong>Âge:</strong> ${ordonnance.patientAge || 'Non spécifié'}</p>
              <p><strong>Genre:</strong> ${ordonnance.patientGenre === 'M' ? 'Masculin' : ordonnance.patientGenre === 'F' ? 'Féminin' : 'Non spécifié'}</p>
              <p><strong>Téléphone:</strong> ${ordonnance.patientTelephone || 'Non spécifié'}</p>
              <p><strong>Adresse:</strong> ${ordonnance.patientAdresse || 'Non spécifié'}</p>
            </div>
            <div class="info-box">
              <h3>INFORMATIONS MÉDECIN</h3>
              <p><strong>Nom:</strong> ${escapeHtml(ordonnance.medecinNom)}</p>
              <p><strong>Spécialité:</strong> ${ordonnance.medecinSpecialite || 'Non spécifié'}</p>
              <p><strong>Date:</strong> ${dateOrd}</p>
            </div>
          </div>
          
          <h3>MÉDICAMENTS PRESCRITS</h3>
          ${ordonnance.medicaments.map((med, index) => `
            <div class="medicament-card">
              <h4>${escapeHtml(med.nom)}</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                <div><strong>Dosage:</strong> ${med.dosage || 'Non spécifié'}</div>
                <div><strong>Posologie:</strong> ${med.posologie || 'Non spécifié'}</div>
                <div><strong>Quantité:</strong> ${med.quantite || 1}</div>
                <div><strong>Durée:</strong> ${med.duree || 'Non spécifié'}</div>
              </div>
            </div>
          `).join('')}
          
          <div class="info-box">
            <h3>INSTRUCTIONS ET RECOMMANDATIONS</h3>
            <p>${ordonnance.instructions || 'Aucune instruction particulière'}</p>
          </div>
          
          <div class="signature">
            <div>
              <p>Signature et cachet du médecin:</p>
              <p>_________________________</p>
              <p style="margin-top: 10px;">${escapeHtml(ordonnance.medecinNom)}</p>
            </div>
            <div>
              <p>Pour la pharmacie:</p>
              <p>_________________________</p>
              <p style="margin-top: 10px;">Pharmacie RDC</p>
            </div>
          </div>
          
          <div class="footer">
            <p>Cette ordonnance est valable pour un mois à compter de la date de prescription</p>
            <p><small>Ordonnance générée le ${new Date().toLocaleDateString('fr-FR')}</small></p>
          </div>
        </body>
        </html>
      `;
    }

    function viewFactureDetails(factureId) {
      const facture = factures.find(f => f.id === factureId);
      if (!facture) return;
      
      editFacture(factureId);
    }

    function toggleSelectAllFactures(e) {
      const checkboxes = document.querySelectorAll('.facture-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = e.target.checked;
        if (e.target.checked) {
          selectedFactures.add(cb.value);
        } else {
          selectedFactures.delete(cb.value);
        }
      });
    }

    function toggleSelectAllOrdonnances(e) {
      const checkboxes = document.querySelectorAll('.ordonnance-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = e.target.checked;
        if (e.target.checked) {
          selectedOrdonnances.add(cb.value);
        } else {
          selectedOrdonnances.delete(cb.value);
        }
      });
    }

    function changePage(type, page) {
      const totalItems = type === 'factures' ? factures.length : ordonnances.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      
      if (page < 1 || page > totalPages) return;
      
      currentPage[type] = page;
      
      if (type === 'factures') {
        renderFactures();
      } else if (type === 'ordonnances') {
        renderOrdonnances();
      }
    }

    function updatePageNumbers(type, totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const current = currentPage[type];
      const pageNumbersId = type === 'factures' ? 'pageNumbersFactures' : 'pageNumbersOrdonnances';
      const pageNumbers = document.getElementById(pageNumbersId);
      
      if (!pageNumbers) return;
      
      pageNumbers.innerHTML = '';
      
      const maxVisiblePages = 5;
      let startPage = Math.max(1, current - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('span');
        pageBtn.className = `page-number ${i === current ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => changePage(type, i));
        pageNumbers.appendChild(pageBtn);
      }
    }

    function exportFactures() {
      const dataStr = JSON.stringify(factures, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `factures_pharmacie_rdc_${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showNotification('Factures exportées avec succès', 'success');
    }

    function exportOrdonnances() {
      const dataStr = JSON.stringify(ordonnances, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `ordonnances_pharmacie_rdc_${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showNotification('Ordonnances exportées avec succès', 'success');
    }

    function generateDailyReport() {
      const now = new Date();
      const today = now.toISOString().split('T')[0];
      
      const facturesAujourdhui = factures.filter(f => 
        f.dateFacturation.split('T')[0] === today
      );
      
      const ordonnancesAujourdhui = ordonnances.filter(o => 
        o.dateOrd.split('T')[0] === today
      );
      
      const totalCA = facturesAujourdhui.reduce((sum, f) => sum + f.total, 0);
      
      const report = `
        RAPPORT JOURNALIER - ${formatDate(now)}
        ========================================
        
        STATISTIQUES DU JOUR:
        ---------------------
        • Factures créées: ${facturesAujourdhui.length}
        • Ordonnances reçues: ${ordonnancesAujourdhui.length}
        • Chiffre d'affaires: ${formatPrice(totalCA)}
        
        FACTURES DU JOUR:
        -----------------
        ${facturesAujourdhui.length > 0 ? facturesAujourdhui.map(f => 
          `  - ${f.numeroFacture}: ${f.clientNom} - ${formatPrice(f.total)} (${getStatusText(f.statut)})`
        ).join('\n') : '  Aucune facture aujourd\'hui'}
        
        ORDONNANCES DU JOUR:
        --------------------
        ${ordonnancesAujourdhui.length > 0 ? ordonnancesAujourdhui.map(o => 
          `  - ${o.code}: ${o.patientNom} - Dr. ${o.medecinNom} (${getStatusText(o.statut)})`
        ).join('\n') : '  Aucune ordonnance aujourd\'hui'}
        
        ALERTES:
        --------
        ${getAlertsReport()}
      `;
      
      alert(report);
    }

    function getAlertsReport() {
      const alerts = [];
      
      // Stock faible
      const stockFaible = medicamentsStock.filter(m => m.quantite <= m.seuil);
      if (stockFaible.length > 0) {
        alerts.push(`• Stock faible pour ${stockFaible.length} médicament(s)`);
      }
      
      // Factures en retard
      const today = new Date();
      const facturesEnRetard = factures.filter(f => {
        if (f.statut !== 'en_attente' || !f.dateLimitePaiement) return false;
        const dueDate = new Date(f.dateLimitePaiement);
        return dueDate < today;
      });
      
      if (facturesEnRetard.length > 0) {
        alerts.push(`• ${facturesEnRetard.length} facture(s) en retard de paiement`);
      }
      
      // Ordonnances en attente
      const ordonnancesEnAttente = ordonnances.filter(o => o.statut === 'envoyee');
      if (ordonnancesEnAttente.length > 0) {
        alerts.push(`• ${ordonnancesEnAttente.length} ordonnance(s) en attente de traitement`);
      }
      
      return alerts.length > 0 ? alerts.join('\n') : '  Aucune alerte';
    }

    function scanQRCode() {
      showNotification('Fonction de scan QR Code en développement', 'info');
    }

    function showStockManagement() {
      showNotification('Gestion de stock en développement', 'info');
    }

    function openSettings() {
      showNotification('Paramètres en développement', 'info');
    }

    function generateReport() {
      showNotification('Rapports détaillés en développement', 'info');
    }

    // ========== FONCTIONS UTILITAIRES GÉNÉRALES ==========
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
          modal.style.opacity = '1';
        }, 10);
      }
    }

    function closeModal() {
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
        modal.style.opacity = '0';
      });
      document.body.style.overflow = 'auto';
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      
      switch(type) {
        case 'success':
          notification.style.background = '#28a745';
          break;
        case 'error':
          notification.style.background = '#dc3545';
          break;
        case 'warning':
          notification.style.background = '#ff9800';
          break;
        default:
          notification.style.background = '#17a2b8';
      }
      
      notification.innerHTML = `
        <span>${message}</span>
        <button style="background:none; border:none; color:white; margin-left:15px; cursor:pointer;">×</button>
      `;
      
      document.body.appendChild(notification);
      
      notification.querySelector('button').addEventListener('click', () => {
        notification.remove();
      });
      
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('fr-CD', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(price) + ' FCF';
    }

    function formatPrix(price) {
      return new Intl.NumberFormat('fr-CD', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(price);
    }

    function formatDate(dateString) {
      if (!dateString) return 'Non spécifié';
      try {
        const d = new Date(dateString);
        if (isNaN(d.getTime())) return dateString.toString();
        
        return d.toLocaleDateString("fr-FR", {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString.toString();
      }
    }

    function getStatusText(statut) {
      const statusMap = {
        'payee': 'Payée',
        'en_attente': 'En attente',
        'en_retard': 'En retard',
        'brouillon': 'Brouillon',
        'annulee': 'Annulée',
        'envoyee': 'À traiter',
        'en_cours': 'En cours',
        'pret': 'Prête',
        'delivree': 'Délivrée'
      };
      return statusMap[statut] || statut;
    }

    function getStatusColor(statut) {
      const colorMap = {
        'envoyee': '#ff9800',
        'en_cours': '#2196f3',
        'pret': '#4caf50',
        'delivree': '#9c27b0',
        'annulee': '#dc3545'
      };
      return colorMap[statut] || '#666';
    }

    function getPaymentMethodText(methode) {
      const map = {
        'especes': 'Espèces',
        'carte': 'Carte bancaire',
        'cheque': 'Chèque',
        'virement': 'Virement',
        'assurance': 'Assurance',
        'mobile_money': 'Mobile Money'
      };
      return map[methode] || methode || 'Non spécifiée';
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>